
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PyLOSt.ui.stitch_algorithms.util.util_stitching &#8212; PyLOSt  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/alabaster.css" />
    <script data-url_root="../../../../../" id="documentation_options" src="../../../../../_static/documentation_options.js"></script>
    <script src="../../../../../_static/jquery.js"></script>
    <script src="../../../../../_static/underscore.js"></script>
    <script src="../../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for PyLOSt.ui.stitch_algorithms.util.util_stitching</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Created on Jul 27, 2018</span>

<span class="sd">Util functions used in stitching algorithms</span>

<span class="sd">@author: adapa</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtWidgets</span> <span class="kn">import</span> <span class="n">QFileDialog</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>

<span class="kn">from</span> <span class="nn">PyLOSt.algorithms.util.util_fit</span> <span class="kn">import</span> <span class="n">fit2D</span>
<span class="kn">from</span> <span class="nn">PyLOSt.algorithms.util.util_math</span> <span class="kn">import</span> <span class="n">rms</span>
<span class="kn">from</span> <span class="nn">PyLOSt.algorithms.util.util_stitching</span> <span class="kn">import</span> <span class="n">plotSt</span>

<span class="c1"># matplotlib.use(&#39;Qt4Agg&#39;)</span>
<span class="kn">from</span> <span class="nn">statistics</span> <span class="kn">import</span> <span class="n">median</span>
<span class="kn">import</span> <span class="nn">scipy.linalg</span>
<span class="kn">from</span> <span class="nn">numpy.lib.nanfunctions</span> <span class="kn">import</span> <span class="n">nanmean</span>
<span class="kn">from</span> <span class="nn">numpy.core.multiarray</span> <span class="kn">import</span> <span class="n">arange</span>


<div class="viewcode-block" id="gravity_correction"><a class="viewcode-back" href="../../../../../PyLOSt.ui.stitch_algorithms.util.html#PyLOSt.ui.stitch_algorithms.util.util_stitching.gravity_correction">[docs]</a><span class="k">def</span> <span class="nf">gravity_correction</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="mf">2340.0</span><span class="p">,</span><span class="n">E</span><span class="o">=</span><span class="mf">1.3E+11</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Correct gavity for a simple setup with two cylindes symmetrically supporing mirror seperated by half mirror length</span>
<span class="sd">    </span>
<span class="sd">    :param x: mirror x positions in mm</span>
<span class="sd">    :param t: thickness of mirror</span>
<span class="sd">    :param L: length of mirror</span>
<span class="sd">    :param d: seperation between cylinders, usually L/2</span>
<span class="sd">    :param p: for si 2340</span>
<span class="sd">    :param E: </span>
<span class="sd">    :return: gravity correction vector in mrad</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="n">g</span> <span class="o">=</span> <span class="mf">9.81</span> <span class="c1"># gravity constant m/s^2</span>
    <span class="n">ind_i</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">d</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ind_o</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">d</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">S</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">g</span><span class="o">*</span><span class="n">L</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-3</span><span class="o">/</span><span class="p">(</span><span class="n">E</span><span class="o">*</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">gx</span><span class="p">[</span><span class="n">ind_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="o">*</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="n">ind_i</span><span class="p">]</span><span class="o">/</span><span class="n">L</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="p">(</span><span class="n">d</span><span class="o">/</span><span class="n">L</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">ind_i</span><span class="p">]</span><span class="o">/</span><span class="n">L</span><span class="p">))</span><span class="o">*</span><span class="mf">1e3</span>
    <span class="n">gx</span><span class="p">[</span><span class="n">ind_o</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="o">*</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">ind_o</span><span class="p">])</span><span class="o">/</span><span class="n">L</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">ind_o</span><span class="p">]</span><span class="o">/</span><span class="n">L</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">ind_o</span><span class="p">])</span><span class="o">/</span><span class="n">L</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">d</span><span class="o">/</span><span class="n">L</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">ind_o</span><span class="p">])</span><span class="o">*</span><span class="mf">1e3</span>
    <span class="n">gx</span> <span class="o">=</span> <span class="n">gx</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>
    <span class="k">return</span> <span class="n">gx</span></div>

<div class="viewcode-block" id="addAppliedStageTilt"><a class="viewcode-back" href="../../../../../PyLOSt.ui.stitch_algorithms.util.html#PyLOSt.ui.stitch_algorithms.util.util_stitching.addAppliedStageTilt">[docs]</a><span class="k">def</span> <span class="nf">addAppliedStageTilt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_sx</span><span class="p">,</span> <span class="n">d_sy</span><span class="p">,</span> <span class="n">instrScale</span><span class="p">,</span> <span class="n">h5si</span><span class="p">,</span> <span class="n">h5fi</span><span class="p">):</span>
    <span class="n">retSx</span> <span class="o">=</span> <span class="n">d_sx</span>
    <span class="n">retSy</span> <span class="o">=</span> <span class="n">d_sy</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;appTxF&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">appTxF</span><span class="p">)):</span>
            <span class="n">txf</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">QFileDialog</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;Open X tilts forward&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">txb</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">QFileDialog</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;Open X tilts backward&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">tyf</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">QFileDialog</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;Open Y tilts forward&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">tyb</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">QFileDialog</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;Open Y tilts backward&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">appTxF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">txf</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">deg_to_mrad</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">instrScale</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">appTxB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">txb</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">deg_to_mrad</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">instrScale</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">appTyF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">tyf</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">deg_to_mrad</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">instrScale</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">appTyB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">tyb</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">deg_to_mrad</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">instrScale</span><span class="p">)</span>
        <span class="n">appTx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">appTxF</span> <span class="k">if</span> <span class="n">h5si</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;scan_direction&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;F&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">appTxB</span>
        <span class="n">appTy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">appTyF</span> <span class="k">if</span> <span class="n">h5si</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;scan_direction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">appTyB</span>
        <span class="n">retSx</span> <span class="o">=</span> <span class="n">d_sx</span> <span class="o">+</span> <span class="n">appTx</span>
        <span class="n">retSy</span> <span class="o">=</span> <span class="n">d_sy</span> <span class="o">+</span> <span class="n">appTy</span>
        <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;applied_stage_tilt_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">appTx</span>
        <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;applied_stage_tilt_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">appTy</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;subCalRef &lt;- util_functions&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">retSx</span><span class="p">,</span> <span class="n">retSy</span></div>
<span class="c1"># Calibrated reference for tilt X</span>
<span class="c1"># Tested for SHARPeR</span>
<div class="viewcode-block" id="subCalRefSlp"><a class="viewcode-back" href="../../../../../PyLOSt.ui.stitch_algorithms.util.html#PyLOSt.ui.stitch_algorithms.util.util_stitching.subCalRefSlp">[docs]</a><span class="k">def</span> <span class="nf">subCalRefSlp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_sx</span><span class="p">,</span> <span class="n">d_sy</span><span class="p">,</span> <span class="n">instrScale</span><span class="p">,</span> <span class="n">h5fi</span><span class="p">):</span>
    <span class="n">retSx</span> <span class="o">=</span> <span class="n">d_sx</span>
    <span class="n">retSy</span> <span class="o">=</span> <span class="n">d_sy</span>
    <span class="n">refX</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">refY</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;calSx&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calSx</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">QFileDialog</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;Open calibration slope X&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sxe</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">QFileDialog</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;Open calibration slope X errors&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sye</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">QFileDialog</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;Open calibration slope Y errors&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calSx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sx</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calSxErr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sxe</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calSyErr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sye</span><span class="p">)</span>
        <span class="n">d_sx_im</span> <span class="o">=</span> <span class="n">d_sx</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">d_sy_im</span> <span class="o">=</span> <span class="n">d_sy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">d_sx_2d</span> <span class="o">=</span> <span class="n">d_sx_im</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_sx_im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># columnwise unwrap of sx image</span>
        <span class="n">d_sy_2d</span> <span class="o">=</span> <span class="n">d_sy_im</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_sy_im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># columnwise unwrap of sy image</span>
        <span class="n">d_sx_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">d_sx_2d</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">d_sy_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">d_sy_2d</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">refX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">d_sx_2d</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">refY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">d_sy_2d</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">d_sx_2d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">d_sx_ml</span> <span class="o">=</span> <span class="n">d_sx_2d</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">d_sy_ml</span> <span class="o">=</span> <span class="n">d_sy_2d</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calSx</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">sxe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calSxErr</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">sye</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calSyErr</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">q</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">]):</span>
                <span class="n">fx</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="n">sxe</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span>
                <span class="n">d_sx_ml_e</span> <span class="o">=</span> <span class="n">fx</span><span class="p">(</span><span class="n">d_sx_ml</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">instrScale</span><span class="p">)</span> <span class="c1">#Factor to convert real tilt back to what should be measured by instrument</span>
                <span class="n">d_sx_r</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_sx_ml</span> <span class="o">-</span> <span class="n">d_sx_ml_e</span>
                <span class="n">refX</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_sx_ml_e</span>
                <span class="n">fy</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="n">sye</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span>
                <span class="n">d_sy_ml_e</span> <span class="o">=</span> <span class="n">fy</span><span class="p">(</span><span class="n">d_sx_ml</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">instrScale</span><span class="p">)</span> <span class="c1">#y errors for given x tilts</span>
                <span class="n">d_sy_r</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_sy_ml</span> <span class="o">-</span> <span class="n">d_sy_ml_e</span>
                <span class="n">refY</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_sy_ml_e</span>
        <span class="n">retSx</span> <span class="o">=</span> <span class="n">d_sx_r</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_sx_im</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">retSy</span> <span class="o">=</span> <span class="n">d_sy_r</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_sy_im</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">refX</span> <span class="o">=</span> <span class="n">refX</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_sx_im</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">refY</span> <span class="o">=</span> <span class="n">refY</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">d_sy_im</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;ref_tilt_slopes_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">refX</span>
        <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;ref_tilt_slopes_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">refY</span>
        <span class="n">h5fi</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ref_tilt_calib_slopeX_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sx</span>
        <span class="n">h5fi</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ref_tilt_calib_slopeErrX_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sxe</span>
        <span class="n">h5fi</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ref_tilt_calib_slopeErrY_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sye</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;subCalRef &lt;- util_functions&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">retSx</span><span class="p">,</span> <span class="n">retSy</span></div>

<div class="viewcode-block" id="correctRefFromMeasuredData_slp"><a class="viewcode-back" href="../../../../../PyLOSt.ui.stitch_algorithms.util.html#PyLOSt.ui.stitch_algorithms.util.util_stitching.correctRefFromMeasuredData_slp">[docs]</a><span class="k">def</span> <span class="nf">correctRefFromMeasuredData_slp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slxArr</span><span class="p">,</span> <span class="n">slyArr</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">h5fi</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;avg&#39;</span><span class="p">:</span>
        <span class="n">slxArr</span><span class="p">,</span> <span class="n">slyArr</span> <span class="o">=</span> <span class="n">preprocessSlp</span><span class="p">(</span><span class="s1">&#39;REF_M_A&#39;</span><span class="p">,</span> <span class="n">slxArr</span><span class="p">,</span> <span class="n">slyArr</span><span class="p">,</span> <span class="n">pix_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pix_size</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">outH5Obj</span><span class="o">=</span><span class="n">h5fi</span><span class="p">,</span><span class="n">isSave</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">saveMidResults</span><span class="p">,</span> <span class="n">showPlots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">showPlots</span><span class="p">,</span><span class="n">nbExclEdges</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_ref_exclude_nb_edge_subaps</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;avg_plus_extract&#39;</span><span class="p">:</span>
        <span class="n">slxArr</span><span class="p">,</span> <span class="n">slyArr</span> <span class="o">=</span> <span class="n">preprocessSlp</span><span class="p">(</span><span class="s1">&#39;REF_M_A&#39;</span><span class="p">,</span> <span class="n">slxArr</span><span class="p">,</span> <span class="n">slyArr</span><span class="p">,</span> <span class="n">pix_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pix_size</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">outH5Obj</span><span class="o">=</span><span class="n">h5fi</span><span class="p">,</span><span class="n">isSave</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">saveMidResults</span><span class="p">,</span> <span class="n">showPlots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">showPlots</span><span class="p">,</span><span class="n">nbExclEdges</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_ref_exclude_nb_edge_subaps</span><span class="p">)</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="s1">&#39;extract_from_stitching&#39;</span>
    <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;avg_high_freq&#39;</span><span class="p">:</span>
        <span class="n">slxArr</span><span class="p">,</span> <span class="n">slyArr</span> <span class="o">=</span> <span class="n">preprocessSlp</span><span class="p">(</span><span class="s1">&#39;REF_M_A_HF&#39;</span><span class="p">,</span> <span class="n">slxArr</span><span class="p">,</span> <span class="n">slyArr</span><span class="p">,</span> <span class="n">pix_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pix_size</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">outH5Obj</span><span class="o">=</span><span class="n">h5fi</span><span class="p">,</span><span class="n">isSave</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">saveMidResults</span><span class="p">,</span> <span class="n">showPlots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">showPlots</span><span class="p">,</span><span class="n">nbExclEdges</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_ref_exclude_nb_edge_subaps</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;high_freq&#39;</span><span class="p">:</span>
        <span class="n">slxArr</span><span class="p">,</span> <span class="n">slyArr</span> <span class="o">=</span> <span class="n">preprocessSlp</span><span class="p">(</span><span class="s1">&#39;REF_M_HF&#39;</span><span class="p">,</span> <span class="n">slxArr</span><span class="p">,</span> <span class="n">slyArr</span><span class="p">,</span> <span class="n">pix_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pix_size</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">outH5Obj</span><span class="o">=</span><span class="n">h5fi</span><span class="p">,</span><span class="n">isSave</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">saveMidResults</span><span class="p">,</span> <span class="n">showPlots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">showPlots</span><span class="p">,</span><span class="n">nbExclEdges</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_ref_exclude_nb_edge_subaps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">slxArr</span><span class="p">,</span> <span class="n">slyArr</span><span class="p">,</span> <span class="n">typ</span></div>

<div class="viewcode-block" id="correctRefFromMeasuredData_height"><a class="viewcode-back" href="../../../../../PyLOSt.ui.stitch_algorithms.util.html#PyLOSt.ui.stitch_algorithms.util.util_stitching.correctRefFromMeasuredData_height">[docs]</a><span class="k">def</span> <span class="nf">correctRefFromMeasuredData_height</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hArr</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">h5fi</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;avg&#39;</span><span class="p">:</span>
        <span class="n">hArr</span> <span class="o">=</span> <span class="n">preprocessHgt</span><span class="p">(</span><span class="s1">&#39;REF_M_A&#39;</span><span class="p">,</span><span class="n">hArr</span><span class="p">,</span> <span class="n">pix_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix_size</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">,</span> <span class="n">outH5Obj</span> <span class="o">=</span> <span class="n">h5fi</span><span class="p">,</span> <span class="n">isSave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveMidResults</span><span class="p">,</span> <span class="n">showPlots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">showPlots</span><span class="p">,</span> <span class="n">nbExclEdges</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_ref_exclude_nb_edge_subaps</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;avg_plus_extract&#39;</span><span class="p">:</span>
        <span class="n">hArr</span> <span class="o">=</span> <span class="n">preprocessHgt</span><span class="p">(</span><span class="s1">&#39;REF_M_A&#39;</span><span class="p">,</span> <span class="n">hArr</span><span class="p">,</span> <span class="n">pix_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pix_size</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">outH5Obj</span><span class="o">=</span><span class="n">h5fi</span><span class="p">,</span><span class="n">isSave</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">saveMidResults</span><span class="p">,</span> <span class="n">showPlots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">showPlots</span><span class="p">,</span><span class="n">nbExclEdges</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_ref_exclude_nb_edge_subaps</span><span class="p">)</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="s1">&#39;extract_from_stitching&#39;</span>
    <span class="k">if</span> <span class="n">typ</span><span class="o">==</span><span class="s1">&#39;avg_high_freq&#39;</span><span class="p">:</span>
        <span class="n">hArr</span> <span class="o">=</span> <span class="n">preprocessHgt</span><span class="p">(</span><span class="s1">&#39;REF_M_A_HF&#39;</span><span class="p">,</span><span class="n">hArr</span><span class="p">,</span> <span class="n">pix_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix_size</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">,</span> <span class="n">outH5Obj</span> <span class="o">=</span> <span class="n">h5fi</span><span class="p">,</span> <span class="n">isSave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveMidResults</span><span class="p">,</span> <span class="n">showPlots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">showPlots</span><span class="p">,</span> <span class="n">nbExclEdges</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_ref_exclude_nb_edge_subaps</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">typ</span><span class="o">==</span><span class="s1">&#39;high_freq&#39;</span><span class="p">:</span>
        <span class="n">hArr</span> <span class="o">=</span> <span class="n">preprocessHgt</span><span class="p">(</span><span class="s1">&#39;REF_M_HF&#39;</span><span class="p">,</span><span class="n">hArr</span><span class="p">,</span> <span class="n">pix_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix_size</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">,</span> <span class="n">outH5Obj</span> <span class="o">=</span> <span class="n">h5fi</span><span class="p">,</span> <span class="n">isSave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveMidResults</span><span class="p">,</span> <span class="n">showPlots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">showPlots</span><span class="p">,</span> <span class="n">nbExclEdges</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_ref_exclude_nb_edge_subaps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hArr</span><span class="p">,</span> <span class="n">typ</span></div>

<div class="viewcode-block" id="preprocessSlp"><a class="viewcode-back" href="../../../../../PyLOSt.ui.stitch_algorithms.util.html#PyLOSt.ui.stitch_algorithms.util.util_stitching.preprocessSlp">[docs]</a><span class="k">def</span> <span class="nf">preprocessSlp</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">slxArr</span><span class="p">,</span> <span class="n">slyArr</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pix_size</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outH5Obj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">isSave</span> <span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showPlots</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">nbExclEdges</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pre processing of slopes data</span>

<span class="sd">    :param typ: Type of preprocess, e.g. apply threshold, reference from measured data average etc...</span>
<span class="sd">    :param slxArr: Slopes X array</span>
<span class="sd">    :param slyArr: Slopes Y array</span>
<span class="sd">    :param args: Min/max threshold slope</span>
<span class="sd">    :param pix_size: Pixel size</span>
<span class="sd">    :param mask: Mask of data</span>
<span class="sd">    :param outH5Obj: H5 object where the reference is saved</span>
<span class="sd">    :param isSave: Save flag</span>
<span class="sd">    :return: Corrected slope arrays</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># preprocess subapertures</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nbExclEdges</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># exclude edge subapertures which usually have large errors, from reference calculation</span>
            <span class="n">mask</span><span class="p">[:</span><span class="n">nbExclEdges</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">mask</span><span class="p">[</span><span class="o">-</span><span class="n">nbExclEdges</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sz_x</span> <span class="o">=</span> <span class="n">slxArr</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">sz_y</span> <span class="o">=</span> <span class="n">slyArr</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">typ</span><span class="o">==</span><span class="s1">&#39;E_FS&#39;</span><span class="p">:</span>                                     <span class="c1"># apply threshold on slopes</span>
            <span class="n">slxArr</span><span class="p">[</span><span class="n">slxArr</span><span class="o">&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">slyArr</span><span class="p">[</span><span class="n">slxArr</span><span class="o">&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">slxArr</span><span class="p">[</span><span class="n">slxArr</span><span class="o">&lt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">slyArr</span><span class="p">[</span><span class="n">slxArr</span><span class="o">&lt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">elif</span> <span class="n">typ</span><span class="o">==</span><span class="s1">&#39;REF_M_A&#39;</span><span class="p">:</span>                                <span class="c1"># reference = avg(measurements)</span>
            <span class="n">slxArr_resd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">slxArr</span><span class="p">)</span>
            <span class="n">slxArr_resd</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">slyArr_resd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">slyArr</span><span class="p">)</span>
            <span class="n">slyArr_resd</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">refMsx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">slxArr_resd</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">refMsy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">slyArr_resd</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">slxArr</span> <span class="o">=</span> <span class="n">slxArr</span> <span class="o">-</span> <span class="n">refMsx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">sz_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">sz_x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">slyArr</span> <span class="o">=</span> <span class="n">slyArr</span> <span class="o">-</span> <span class="n">refMsy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">sz_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">sz_x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">outH5Obj</span><span class="o">!=</span><span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">isSave</span><span class="p">:</span>
                <span class="n">outH5Obj</span><span class="p">[</span><span class="s1">&#39;retrieved_ref_sx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">refMsx</span>
                <span class="n">outH5Obj</span><span class="p">[</span><span class="s1">&#39;retrieved_ref_sy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">refMsy</span>
            <span class="k">if</span> <span class="n">showPlots</span><span class="p">:</span>
                <span class="n">plotSt</span><span class="p">(</span><span class="n">refMsx</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Reference slopes X (avg subapp)&#39;</span><span class="p">)</span>
                <span class="n">plotSt</span><span class="p">(</span><span class="n">refMsy</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Reference slopes Y (avg subapp)&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">typ</span><span class="o">==</span><span class="s1">&#39;REF_M_A_HF&#39;</span><span class="p">:</span>                             <span class="c1"># reference = high_freq(avg(measurements))</span>
            <span class="n">slxArr_resd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">slxArr</span><span class="p">)</span>
            <span class="n">slxArr_resd</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">slyArr_resd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">slyArr</span><span class="p">)</span>
            <span class="n">slyArr_resd</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">refMsx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">slxArr_resd</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">refMsy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">slyArr_resd</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span><span class="n">refMsx</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">fit2D</span><span class="p">(</span><span class="n">refMsx</span><span class="p">,</span> <span class="n">pix_size</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span><span class="n">refMsy</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">fit2D</span><span class="p">(</span><span class="n">refMsy</span><span class="p">,</span> <span class="n">pix_size</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">slxArr</span> <span class="o">=</span> <span class="n">slxArr</span> <span class="o">-</span> <span class="n">refMsx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">sz_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">sz_x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">slyArr</span> <span class="o">=</span> <span class="n">slyArr</span> <span class="o">-</span> <span class="n">refMsy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">sz_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">sz_x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">outH5Obj</span><span class="o">!=</span><span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">isSave</span><span class="p">:</span>
                <span class="n">outH5Obj</span><span class="p">[</span><span class="s1">&#39;retrieved_ref_sx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">refMsx</span>
                <span class="n">outH5Obj</span><span class="p">[</span><span class="s1">&#39;retrieved_ref_sy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">refMsy</span>
            <span class="k">if</span> <span class="n">showPlots</span><span class="p">:</span>
                <span class="n">plotSt</span><span class="p">(</span><span class="n">refMsx</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Reference slopes X (high freq from avg subapp)&#39;</span><span class="p">)</span>
                <span class="n">plotSt</span><span class="p">(</span><span class="n">refMsy</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Reference slopes Y (high freq from avg subapp)&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">typ</span><span class="o">==</span><span class="s1">&#39;REF_M_HF&#39;</span><span class="p">:</span>                               <span class="c1"># reference = avg(high_freq(measurements))</span>
            <span class="n">slxArr_resd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">slxArr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">slyArr_resd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">slyArr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">sz_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="o">!=</span><span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">_</span><span class="p">,</span><span class="n">slxArr_resd</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span><span class="n">_</span> <span class="o">=</span> <span class="n">fit2D</span><span class="p">(</span><span class="n">slxArr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">pix_size</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">_</span><span class="p">,</span><span class="n">slyArr_resd</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span><span class="n">_</span> <span class="o">=</span> <span class="n">fit2D</span><span class="p">(</span><span class="n">slyArr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">pix_size</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">refMsx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">slxArr_resd</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">refMsy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">slyArr_resd</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">slxArr</span> <span class="o">=</span> <span class="n">slxArr</span> <span class="o">-</span> <span class="n">refMsx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">sz_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">sz_x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">slyArr</span> <span class="o">=</span> <span class="n">slyArr</span> <span class="o">-</span> <span class="n">refMsy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">sz_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">sz_x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">outH5Obj</span><span class="o">!=</span><span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">isSave</span><span class="p">:</span>
                <span class="n">outH5Obj</span><span class="p">[</span><span class="s1">&#39;retrieved_ref_sx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">refMsx</span>
                <span class="n">outH5Obj</span><span class="p">[</span><span class="s1">&#39;retrieved_ref_sy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">refMsy</span>
            <span class="k">if</span> <span class="n">showPlots</span><span class="p">:</span>
                <span class="n">plotSt</span><span class="p">(</span><span class="n">refMsx</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Reference slopes X (avg subapp high freq)&#39;</span><span class="p">)</span>
                <span class="n">plotSt</span><span class="p">(</span><span class="n">refMsy</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Reference slopes Y (avg subapp high freq)&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;preprocessSlp &lt;- util_functions&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">slxArr</span><span class="p">,</span><span class="n">slyArr</span></div>

<div class="viewcode-block" id="preprocessHgt"><a class="viewcode-back" href="../../../../../PyLOSt.ui.stitch_algorithms.util.html#PyLOSt.ui.stitch_algorithms.util.util_stitching.preprocessHgt">[docs]</a><span class="k">def</span> <span class="nf">preprocessHgt</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">hArr</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pix_size</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outH5Obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">isSave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showPlots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nbExclEdges</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pre processing of height data</span>

<span class="sd">    :param typ: Type of preprocess, e.g. apply threshold, reference from measured data average etc...</span>
<span class="sd">    :param hArr: Height array</span>
<span class="sd">    :param args: Min/max threshold slope</span>
<span class="sd">    :param pix_size: Pixel size</span>
<span class="sd">    :param mask: Mask of data</span>
<span class="sd">    :param outH5Obj: H5 object where the reference is saved</span>
<span class="sd">    :param isSave: Save flag</span>
<span class="sd">    :return: Corrected height array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># preprocess subapertures</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nbExclEdges</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># exclude edge subapertures which usually have large errors, from reference calculation</span>
            <span class="n">mask</span><span class="p">[:</span><span class="n">nbExclEdges</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">mask</span><span class="p">[</span><span class="o">-</span><span class="n">nbExclEdges</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sz</span> <span class="o">=</span> <span class="n">hArr</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">typ</span><span class="o">==</span><span class="s1">&#39;REF_M_A&#39;</span><span class="p">:</span>                                <span class="c1"># reference = avg(measurements)</span>
            <span class="n">hArr_resd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">hArr</span><span class="p">)</span>
            <span class="n">hArr_resd</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">refM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">hArr_resd</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">hArr</span> <span class="o">=</span> <span class="n">hArr</span> <span class="o">-</span> <span class="n">refM</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">sz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">sz</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">outH5Obj</span><span class="o">!=</span><span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">isSave</span><span class="p">:</span>
                <span class="n">outH5Obj</span><span class="p">[</span><span class="s1">&#39;retrieved_ref_hgt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">refM</span>
        <span class="k">if</span> <span class="n">typ</span><span class="o">==</span><span class="s1">&#39;REF_M_A_HF&#39;</span><span class="p">:</span>                             <span class="c1"># reference = high_freq(avg(measurements))</span>
            <span class="n">hArr_resd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">hArr</span><span class="p">)</span>
            <span class="n">hArr_resd</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">refM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">hArr_resd</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span><span class="n">refM</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">fit2D</span><span class="p">(</span><span class="n">refM</span><span class="p">,</span> <span class="n">pix_size</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">hArr</span> <span class="o">=</span> <span class="n">hArr</span> <span class="o">-</span> <span class="n">refM</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">sz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">sz</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">outH5Obj</span><span class="o">!=</span><span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">isSave</span><span class="p">:</span>
                <span class="n">outH5Obj</span><span class="p">[</span><span class="s1">&#39;retrieved_ref_hgt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">refM</span>
            <span class="k">if</span> <span class="n">showPlots</span><span class="p">:</span>
                <span class="n">plotSt</span><span class="p">(</span><span class="n">refM</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Reference height (avg subapp)&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">typ</span><span class="o">==</span><span class="s1">&#39;REF_M_HF&#39;</span><span class="p">:</span>                             <span class="c1"># reference = avg(high_freq(measurements))</span>
            <span class="n">hArr_resd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">hArr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="o">!=</span><span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">_</span><span class="p">,</span><span class="n">hArr_resd</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span><span class="n">_</span> <span class="o">=</span> <span class="n">fit2D</span><span class="p">(</span><span class="n">hArr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">pix_size</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">refM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">hArr_resd</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">hArr</span> <span class="o">=</span> <span class="n">hArr</span> <span class="o">-</span> <span class="n">refM</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">sz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">sz</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">outH5Obj</span><span class="o">!=</span><span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">isSave</span><span class="p">:</span>
                <span class="n">outH5Obj</span><span class="p">[</span><span class="s1">&#39;retrieved_ref_hgt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">refM</span>
            <span class="k">if</span> <span class="n">showPlots</span><span class="p">:</span>
                <span class="n">plotSt</span><span class="p">(</span><span class="n">refM</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Reference height (avg subapp high freq)&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;preprocessHgt &lt;- util_functions&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hArr</span></div>


<div class="viewcode-block" id="applyExternalMask"><a class="viewcode-back" href="../../../../../PyLOSt.ui.stitch_algorithms.util.html#PyLOSt.ui.stitch_algorithms.util.util_stitching.applyExternalMask">[docs]</a><span class="k">def</span> <span class="nf">applyExternalMask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">extMask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply external mask to current mask</span>

<span class="sd">    :param mask: Current mask</span>
<span class="sd">    :param extMask: External mask</span>
<span class="sd">    :return: Final mask</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extMask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="c1">#extMask = extMask.reshape(1, extMask.shape[-2], extMask.shape[-1])</span>
        <span class="n">extMask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">extMask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">extMask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">extMask</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="n">extMask</span><span class="p">)</span> <span class="c1">#elementwie multiply</span>
    <span class="k">return</span> <span class="n">mask</span></div>

<div class="viewcode-block" id="parseQUser"><a class="viewcode-back" href="../../../../../PyLOSt.ui.stitch_algorithms.util.html#PyLOSt.ui.stitch_algorithms.util.util_stitching.parseQUser">[docs]</a><span class="k">def</span> <span class="nf">parseQUser</span><span class="p">(</span><span class="n">quser</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">retArr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">quser</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">retArr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">quser</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">A</span><span class="p">:</span>
                <span class="nb">dir</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;f&#39;</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="nb">dir</span><span class="o">!=</span><span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="n">a</span>
                <span class="k">if</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
                    <span class="n">an</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">an</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">an</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">retArr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Scan_&#39;</span><span class="o">+</span><span class="nb">dir</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">retArr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Scan_&#39;</span> <span class="o">+</span> <span class="nb">dir</span> <span class="o">+</span> <span class="n">a</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">retArr</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;parseQUser &lt;- util_functions&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>


<div class="viewcode-block" id="rawScanAvg"><a class="viewcode-back" href="../../../../../PyLOSt.ui.stitch_algorithms.util.html#PyLOSt.ui.stitch_algorithms.util.util_stitching.rawScanAvg">[docs]</a><span class="k">def</span> <span class="nf">rawScanAvg</span><span class="p">(</span><span class="n">h5scans</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;Scan_avg&#39;</span> <span class="ow">in</span> <span class="n">h5scans</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">del</span> <span class="n">h5scans</span><span class="p">[</span><span class="s1">&#39;Scan_avg&#39;</span><span class="p">]</span>
    <span class="n">h5sa</span> <span class="o">=</span> <span class="n">h5scans</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;Scan_avg&#39;</span><span class="p">)</span>
    <span class="n">isc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">h5scans</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;NX_class&#39;</span> <span class="ow">in</span> <span class="n">h5scans</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="n">h5scans</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NX_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NXdata&#39;</span><span class="p">:</span>  <span class="c1"># loop over scans</span>
            <span class="n">h5si</span> <span class="o">=</span> <span class="n">h5scans</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">isc</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># update attributes only once</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">h5si</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                    <span class="c1"># TODO : attributes update for ascan average, deal with scans of different sizes e.g. nb images are different</span>
                    <span class="n">h5sa</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">h5si</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">h5sa</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Scan_avg&#39;</span>
                    <span class="k">if</span> <span class="n">a</span><span class="o">==</span><span class="s1">&#39;scan_direction&#39;</span><span class="p">:</span> <span class="n">h5sa</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">h5si</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">,</span><span class="s1">&#39;slopes_y&#39;</span><span class="p">,</span><span class="s1">&#39;height&#39;</span><span class="p">,</span><span class="s1">&#39;intensity&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">h5sa</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">h5sa</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">h5si</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">h5sa</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">h5sa</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="o">...</span><span class="p">],</span><span class="n">h5si</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="o">...</span><span class="p">])),</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">d</span><span class="o">==</span><span class="s1">&#39;mask&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">h5sa</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">h5sa</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">h5si</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">h5sa</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">h5sa</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="o">...</span><span class="p">],</span><span class="n">h5si</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="o">...</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">isc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">h5sa</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">h5si</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>

            <span class="n">isc</span> <span class="o">=</span> <span class="n">isc</span><span class="o">+</span><span class="mi">1</span>
    <span class="c1"># scale the summed data</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">h5si</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">,</span> <span class="s1">&#39;slopes_y&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">,</span><span class="s1">&#39;intensity&#39;</span><span class="p">]:</span>
            <span class="n">h5sa</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">h5sa</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="o">...</span><span class="p">]</span><span class="o">/</span><span class="n">isc</span></div>

<div class="viewcode-block" id="getFwdScanCount"><a class="viewcode-back" href="../../../../../PyLOSt.ui.stitch_algorithms.util.html#PyLOSt.ui.stitch_algorithms.util.util_stitching.getFwdScanCount">[docs]</a><span class="k">def</span> <span class="nf">getFwdScanCount</span><span class="p">(</span><span class="n">h5ss</span><span class="p">):</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">h5ss</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;dir&#39;</span> <span class="ow">in</span> <span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;F&#39;</span><span class="p">:</span>
            <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">count</span></div>

<div class="viewcode-block" id="avgStitchedScans"><a class="viewcode-back" href="../../../../../PyLOSt.ui.stitch_algorithms.util.html#PyLOSt.ui.stitch_algorithms.util.util_stitching.avgStitchedScans">[docs]</a><span class="k">def</span> <span class="nf">avgStitchedScans</span><span class="p">(</span><span class="n">h5stitched</span><span class="p">,</span> <span class="n">isSlopeStitch</span><span class="p">,</span> <span class="n">mXArr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quser</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tot_scan_cnt</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Average stitched scans</span>

<span class="sd">    :param h5stitched: Stitched data group in H5</span>
<span class="sd">    :param isSlopeStitch: Flag slope or height</span>
<span class="sd">    :param mXArr: Translation offset array</span>
<span class="sd">    :param quser: user selected scans string</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">slx_arr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">slxe_arr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sly_arr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">hgt_arr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tot_int</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">corr_arr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">int_noise_arr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">hasCorrectors</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">Rcx_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">h5ss</span> <span class="o">=</span> <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;stitched_scans&#39;</span><span class="p">]</span>
        <span class="n">totcnt</span> <span class="o">=</span> <span class="n">tot_scan_cnt</span> <span class="k">if</span> <span class="n">tot_scan_cnt</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">h5ss</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">scan_rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">totcnt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">scan_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">totcnt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">med_int_scan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">totcnt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">std_int_scan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">totcnt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">scan_filter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">totcnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">h5fi</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fwd_scan_count</span> <span class="o">=</span> <span class="n">getFwdScanCount</span><span class="p">(</span><span class="n">h5ss</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fwd_scan_count</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">fwd_scan_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">totcnt</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">quser_scans</span> <span class="o">=</span> <span class="n">parseQUser</span><span class="p">(</span><span class="n">quser</span><span class="p">)</span>

<span class="c1">#         Q = filterScansByStd(h5ss, isSlopeStitch)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">h5ss</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">isStitchedDataAvailable</span> <span class="o">=</span> <span class="s1">&#39;slopes_x&#39;</span> <span class="ow">in</span> <span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">isSlopeStitch</span> <span class="k">else</span> <span class="s1">&#39;height&#39;</span> <span class="ow">in</span> <span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isStitchedDataAvailable</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">quser</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">quser_scans</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="k">if</span> <span class="s1">&#39;NX_class&#39;</span> <span class="ow">in</span> <span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NX_class&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;NXdata&#39;</span><span class="p">:</span><span class="c1"># and h5ss[i].attrs[&#39;dir&#39;] in [&#39;F&#39;,&#39;B&#39;]: #loop over stitched scans FW/BW</span>
                <span class="k">if</span> <span class="kc">True</span><span class="p">:</span><span class="c1">#Q[idx]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
                    <span class="n">h5fi</span>                        <span class="o">=</span> <span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span> <span class="k">if</span> <span class="n">isSlopeStitch</span> <span class="k">else</span> <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span>
                    
                    <span class="k">if</span> <span class="s1">&#39;scan_number&#39;</span> <span class="ow">in</span> <span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                        <span class="n">snum</span> <span class="o">=</span> <span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;scan_number&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
                        <span class="k">if</span> <span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;B&#39;</span><span class="p">:</span>
                            <span class="n">snum</span> <span class="o">=</span> <span class="n">snum</span> <span class="o">+</span> <span class="n">fwd_scan_count</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">snum</span> <span class="o">=</span> <span class="n">fwd_scan_count</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_b&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;B&#39;</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_f&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
                    <span class="n">scan_rms</span><span class="p">[</span><span class="n">snum</span><span class="p">]</span> <span class="o">=</span> <span class="n">rms</span><span class="p">(</span><span class="n">obj</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
                    <span class="n">scan_mean</span><span class="p">[</span><span class="n">snum</span><span class="p">]</span> <span class="o">=</span> <span class="n">nanmean</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
                    <span class="n">q1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">scan_rms</span><span class="p">[</span><span class="n">snum</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">100000</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">scan_rms</span><span class="p">[</span><span class="n">snum</span><span class="p">])</span><span class="o">&lt;</span><span class="mi">600</span>
<span class="c1">#                     q2 = int(h5fi.attrs[&#39;scan_number&#39;])&lt;8</span>
<span class="c1">#                     q3 = int(h5fi.attrs[&#39;scan_number&#39;])&gt;12</span>
<span class="c1">#                     q4 = int(h5fi.attrs[&#39;scan_number&#39;])&lt;28</span>
<span class="c1">#                     q5 = int(h5fi.attrs[&#39;scan_number&#39;])&gt;32</span>
                    <span class="n">qf</span> <span class="o">=</span> <span class="n">q1</span> <span class="c1">#or ((q2 or q3) and (q4 or q5))</span>
                    <span class="k">if</span> <span class="n">qf</span><span class="p">:</span> 
                        <span class="n">scan_rms</span><span class="p">[</span><span class="n">snum</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                        <span class="k">continue</span>
                    
                    <span class="n">scan_filter</span><span class="p">[</span><span class="n">snum</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    
                    <span class="k">if</span> <span class="n">isSlopeStitch</span><span class="p">:</span>
                        <span class="n">slx_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">slx_arr</span><span class="p">,</span> <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]))</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">slx_arr</span><span class="o">==</span><span class="p">[]</span> <span class="k">else</span> <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span>
                        <span class="n">sly_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">sly_arr</span><span class="p">,</span> <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;slopes_y&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]))</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">sly_arr</span><span class="o">==</span><span class="p">[]</span> <span class="k">else</span> <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;slopes_y&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">hgt_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">hgt_arr</span><span class="p">,</span> <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]))</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">hgt_arr</span><span class="o">==</span><span class="p">[]</span> <span class="k">else</span> <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span>

                    <span class="k">if</span> <span class="s1">&#39;correctors&#39;</span> <span class="ow">in</span> <span class="n">h5fi</span><span class="p">:</span>
                        <span class="n">hasCorrectors</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">corr_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">corr_arr</span><span class="p">,</span> <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;correctors&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]))</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">corr_arr</span><span class="o">==</span><span class="p">[]</span> <span class="k">else</span> <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;correctors&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span>

                    <span class="n">scan_int</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#h5fi[&#39;intensity&#39;][...]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">scan_int</span><span class="p">):</span>     <span class="n">scan_int</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">])</span> <span class="k">if</span> <span class="n">isSlopeStitch</span> <span class="k">else</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">])</span>
                    <span class="n">tot_int</span> <span class="o">=</span> <span class="n">tot_int</span> <span class="o">+</span> <span class="n">scan_int</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">tot_int</span><span class="o">==</span><span class="p">[]</span> <span class="k">else</span> <span class="n">scan_int</span>

                    <span class="k">if</span> <span class="s1">&#39;intensity_photon_noise&#39;</span> <span class="ow">in</span> <span class="n">h5fi</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;intensity_photon_noise&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]):</span>
                        <span class="n">int_noise_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">int_noise_arr</span><span class="p">,</span> <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;intensity_photon_noise&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]))</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">int_noise_arr</span><span class="o">==</span><span class="p">[]</span> <span class="k">else</span> <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;intensity_photon_noise&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;intensity_mean&#39;</span> <span class="ow">in</span> <span class="n">h5fi</span><span class="p">:</span>
                        <span class="n">im</span> <span class="o">=</span> <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;intensity_mean&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span>
                        <span class="n">imm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
                        <span class="n">imd</span> <span class="o">=</span> <span class="n">im</span><span class="o">-</span><span class="n">imm</span>
                        <span class="n">imd</span><span class="p">[</span><span class="n">im</span><span class="o">&lt;</span><span class="mf">0.5</span><span class="o">*</span><span class="n">imm</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                        <span class="n">ms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">imd</span><span class="p">),(</span><span class="mi">10</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">10</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">imd</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)[</span><span class="mi">10</span><span class="p">:]</span>
                        <span class="n">imd</span><span class="p">[</span><span class="o">~</span><span class="n">ms</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                        <span class="n">med_int_scan</span><span class="p">[</span><span class="n">snum</span><span class="p">]</span> <span class="o">=</span> <span class="n">imm</span>
                        <span class="n">std_int_scan</span><span class="p">[</span><span class="n">snum</span><span class="p">]</span> <span class="o">=</span> <span class="n">rms</span><span class="p">(</span><span class="n">imd</span><span class="p">)</span>

                    <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">idx</span><span class="o">+=</span><span class="mi">1</span>
        <span class="c1"># avg of all scans</span>
        <span class="k">if</span> <span class="s1">&#39;scan_avg&#39;</span> <span class="ow">in</span> <span class="n">h5stitched</span><span class="p">:</span> <span class="k">del</span> <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">isSlopeStitch</span><span class="p">:</span>
            <span class="n">resDim</span>                                          <span class="o">=</span> <span class="n">slx_arr</span><span class="o">.</span><span class="n">ndim</span>
            <span class="n">slx_arr_avg</span>                                     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">slx_arr</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">resDim</span><span class="o">&gt;</span><span class="mi">2</span> <span class="k">else</span> <span class="n">slx_arr</span>
            <span class="n">sly_arr_avg</span>                                     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">sly_arr</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">resDim</span><span class="o">&gt;</span><span class="mi">2</span> <span class="k">else</span> <span class="n">sly_arr</span>
            <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/slopes_x&#39;</span><span class="p">]</span>                 <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">slx_arr_avg</span><span class="p">,</span> <span class="n">tot_int</span><span class="p">)</span>
            <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/slopes_y&#39;</span><span class="p">]</span>                 <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">sly_arr_avg</span><span class="p">,</span> <span class="n">tot_int</span><span class="p">)</span>
            <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/slopes_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
            <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/slopes_y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;slopes_y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">resDim</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/slopes_x_std&#39;</span><span class="p">]</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">slx_arr</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tot_int</span><span class="p">))</span>
                <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/slopes_y_std&#39;</span><span class="p">]</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">sly_arr</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tot_int</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">h5fi</span> <span class="ow">and</span> <span class="s1">&#39;pix_size&#39;</span> <span class="ow">in</span> <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/slopes_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;pix_size&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;pix_size&#39;</span><span class="p">]</span>
                <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/slopes_y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;pix_size&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;pix_size&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resDim</span>                                          <span class="o">=</span> <span class="n">hgt_arr</span><span class="o">.</span><span class="n">ndim</span>
            <span class="n">hgt_arr_avg</span>                                     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">hgt_arr</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">resDim</span><span class="o">&gt;</span><span class="mi">2</span> <span class="k">else</span> <span class="n">hgt_arr</span>
            <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/height&#39;</span><span class="p">]</span>                   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">hgt_arr_avg</span><span class="p">,</span> <span class="n">tot_int</span><span class="p">)</span>
            <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">resDim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/height_std&#39;</span><span class="p">]</span>           <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">hgt_arr</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tot_int</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">h5fi</span> <span class="ow">and</span> <span class="s1">&#39;pix_size&#39;</span> <span class="ow">in</span> <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;pix_size&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;pix_size&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">int_noise_arr</span><span class="p">):</span>
            <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/intensity_photon_noise&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">int_noise_arr</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span> <span class="k">if</span> <span class="n">resDim</span><span class="o">&gt;</span><span class="mi">2</span> <span class="k">else</span> <span class="n">int_noise_arr</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">med_int_scan</span><span class="p">):</span>
            <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/intensity_scan_median&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">med_int_scan</span>
            <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/intensity_scan_std&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">std_int_scan</span>
        <span class="k">if</span> <span class="n">hasCorrectors</span><span class="p">:</span>
            <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/correctors&#39;</span><span class="p">]</span>               <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">corr_arr</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">corr_arr</span><span class="o">.</span><span class="n">ndim</span><span class="o">&gt;</span><span class="mi">2</span> <span class="k">else</span> <span class="n">corr_arr</span>

        <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/intensity&#39;</span><span class="p">]</span>                    <span class="o">=</span> <span class="n">tot_int</span>
        <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/filter&#39;</span><span class="p">]</span>                       <span class="o">=</span> <span class="n">scan_filter</span>
        <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/scan_rms&#39;</span><span class="p">]</span>                     <span class="o">=</span> <span class="n">scan_rms</span>
        <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/scan_mean&#39;</span><span class="p">]</span>                    <span class="o">=</span> <span class="n">scan_mean</span>

        <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;NX_class&#39;</span><span class="p">]</span>                       <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;NXdata&#39;</span>
        <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;nb_scans_averagesd&#39;</span><span class="p">]</span>             <span class="o">=</span> <span class="n">cnt</span>
        <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;isRefSubtracted&#39;</span><span class="p">]</span>                 <span class="o">=</span> <span class="kc">True</span> <span class="c1">#if h5fi.attrs[&#39;isRefSubtracted&#39;] else False</span>
        <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;isGravitySubtracted&#39;</span><span class="p">]</span>             <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="s1">&#39;isGravitySubtracted&#39;</span> <span class="ow">in</span> <span class="n">h5fi</span> <span class="ow">and</span> <span class="n">h5fi</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;isGravitySubtracted&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">h5fi</span> <span class="ow">and</span> <span class="s1">&#39;pix_size&#39;</span> <span class="ow">in</span> <span class="n">h5fi</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="n">h5stitched</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;pix_size&#39;</span><span class="p">]</span>                                <span class="o">=</span> <span class="n">h5fi</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;pix_size&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;avgStitchedScans &lt;- util_functions&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>
        
<span class="c1">##TODO</span>
<div class="viewcode-block" id="getStd"><a class="viewcode-back" href="../../../../../PyLOSt.ui.stitch_algorithms.util.html#PyLOSt.ui.stitch_algorithms.util.util_stitching.getStd">[docs]</a><span class="k">def</span> <span class="nf">getStd</span><span class="p">(</span><span class="n">h5stitched</span><span class="p">,</span> <span class="n">isSlopeStitch</span><span class="p">,</span> <span class="n">pix_sz</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get standard deviation of stitched scans</span>

<span class="sd">    :param h5stitched: Stitched data group in H5</span>
<span class="sd">    :param isSlopeStitch: Flag slope or height</span>
<span class="sd">    :param pix_sz: Pixel size</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">slxe_arr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">slye_arr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">hgte_arr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tot_int</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Rcx_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">h5ss</span> <span class="o">=</span> <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;stitched_scans&#39;</span><span class="p">]</span>
        <span class="n">totcnt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">h5ss</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        
        <span class="n">Q</span> <span class="o">=</span> <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/filter&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">h5ss</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">isStitchedDataAvailable</span> <span class="o">=</span> <span class="s1">&#39;slopes_x&#39;</span> <span class="ow">in</span> <span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">isSlopeStitch</span> <span class="k">else</span> <span class="s1">&#39;height&#39;</span> <span class="ow">in</span> <span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isStitchedDataAvailable</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="k">if</span> <span class="s1">&#39;NX_class&#39;</span> <span class="ow">in</span> <span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NX_class&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;NXdata&#39;</span><span class="p">:</span><span class="c1"># and h5ss[i].attrs[&#39;dir&#39;] in [&#39;F&#39;,&#39;B&#39;]: #loop over stitched scans FW/BW</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
                <span class="n">h5fi</span>                        <span class="o">=</span> <span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;scan_number&#39;</span> <span class="ow">in</span> <span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                    <span class="n">snum</span> <span class="o">=</span> <span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;scan_number&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;B&#39;</span><span class="p">:</span>
                        <span class="n">snum</span> <span class="o">=</span> <span class="n">snum</span> <span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">totcnt</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">snum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">totcnt</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_b&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;B&#39;</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_f&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">Q</span><span class="p">[</span><span class="n">snum</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">isSlopeStitch</span><span class="p">:</span>
                        <span class="n">Cx</span><span class="p">,</span><span class="n">slxe</span><span class="p">,</span><span class="n">_</span>                 <span class="o">=</span> <span class="n">fit2D</span><span class="p">(</span><span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">],</span> <span class="n">pix_size</span><span class="o">=</span><span class="n">pix_sz</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">slxe_arr</span>                <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">slxe_arr</span><span class="p">,</span> <span class="n">slxe</span><span class="p">))</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">slxe_arr</span><span class="o">==</span><span class="p">[]</span> <span class="k">else</span> <span class="n">slxe</span>
                        <span class="n">Rcx_arr</span>                 <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Rcx_arr</span><span class="p">,</span> <span class="p">[</span><span class="mi">1000</span><span class="o">/</span><span class="n">Cx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="n">Cy</span><span class="p">,</span><span class="n">slye</span><span class="p">,</span><span class="n">_</span>                 <span class="o">=</span> <span class="n">fit2D</span><span class="p">(</span><span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;slopes_y&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">],</span> <span class="n">pix_size</span><span class="o">=</span><span class="n">pix_sz</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">slye_arr</span>                <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">slye_arr</span><span class="p">,</span> <span class="n">slye</span><span class="p">))</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">slye_arr</span><span class="o">==</span><span class="p">[]</span> <span class="k">else</span> <span class="n">slye</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">C</span><span class="p">,</span><span class="n">hgte</span><span class="p">,</span><span class="n">_</span>                 <span class="o">=</span> <span class="n">fit2D</span><span class="p">(</span><span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">],</span> <span class="n">pix_size</span><span class="o">=</span><span class="n">pix_sz</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">hgte_arr</span>                <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">hgte_arr</span><span class="p">,</span> <span class="n">hgte</span><span class="p">))</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">hgte_arr</span><span class="o">==</span><span class="p">[]</span> <span class="k">else</span> <span class="n">hgte</span>
                        <span class="n">Rcx_arr</span>                 <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Rcx_arr</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.5</span><span class="o">*</span><span class="mi">1000</span><span class="o">/</span><span class="n">C</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>

                    <span class="n">scan_int</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">])</span> <span class="k">if</span> <span class="n">isSlopeStitch</span> <span class="k">else</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">])</span>
                    <span class="n">tot_int</span> <span class="o">=</span> <span class="n">tot_int</span> <span class="o">+</span> <span class="n">scan_int</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">tot_int</span><span class="o">==</span><span class="p">[]</span> <span class="k">else</span> <span class="n">scan_int</span>
                    <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">idx</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">isSlopeStitch</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;scan_avg/slopes_x_std&#39;</span> <span class="ow">in</span> <span class="n">h5stitched</span><span class="p">:</span> <span class="k">del</span> <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/slopes_x_std&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">slxe_arr</span><span class="p">):</span> <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/slopes_x_std&#39;</span><span class="p">]</span>             <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">slxe_arr</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tot_int</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;scan_avg/slopes_y_std&#39;</span> <span class="ow">in</span> <span class="n">h5stitched</span><span class="p">:</span> <span class="k">del</span> <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/slopes_y_std&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">slye_arr</span><span class="p">):</span> <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/slopes_y_std&#39;</span><span class="p">]</span>             <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">slye_arr</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tot_int</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;scan_avg/height_std&#39;</span> <span class="ow">in</span> <span class="n">h5stitched</span><span class="p">:</span> <span class="k">del</span> <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/height_std&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">hgte_arr</span><span class="p">):</span> <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/height_std&#39;</span><span class="p">]</span>               <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">hgte_arr</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tot_int</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">Rcx_arr</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;scan_avg/roc_x_arr&#39;</span> <span class="ow">in</span> <span class="n">h5stitched</span><span class="p">:</span> <span class="k">del</span> <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/roc_x_arr&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;scan_avg/roc_x_std&#39;</span> <span class="ow">in</span> <span class="n">h5stitched</span><span class="p">:</span> <span class="k">del</span> <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/roc_x_std&#39;</span><span class="p">]</span>
            <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/roc_x_arr&#39;</span><span class="p">]</span>                     <span class="o">=</span> <span class="n">Rcx_arr</span>
            <span class="n">h5stitched</span><span class="p">[</span><span class="s1">&#39;scan_avg/roc_x_std&#39;</span><span class="p">]</span>                     <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">Rcx_arr</span><span class="o">.</span><span class="n">flatten</span><span class="p">()),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cnt</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;getStd &lt;- util_functions&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>

<span class="c1"># stitched scans -- input</span>
<div class="viewcode-block" id="filterScansByStd"><a class="viewcode-back" href="../../../../../PyLOSt.ui.stitch_algorithms.util.html#PyLOSt.ui.stitch_algorithms.util.util_stitching.filterScansByStd">[docs]</a><span class="k">def</span> <span class="nf">filterScansByStd</span><span class="p">(</span><span class="n">h5ss</span><span class="p">,</span> <span class="n">isSlopeStitch</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter stitched scans above 2 std</span>

<span class="sd">    :param h5ss: Stitched scans h5 object</span>
<span class="sd">    :param isSlopeStitch: Flag slopes of height</span>
<span class="sd">    :return: Filter mask</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">e_ssi</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">h5ss</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;NX_class&#39;</span> <span class="ow">in</span> <span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NX_class&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;NXdata&#39;</span> <span class="ow">and</span> <span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">,</span><span class="s1">&#39;B&#39;</span><span class="p">]:</span>
            <span class="n">h5fi</span>                        <span class="o">=</span> <span class="n">h5ss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">isSlopeStitch</span><span class="p">:</span>
                <span class="n">a</span>                           <span class="o">=</span> <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span>
                <span class="n">e_ssi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">)]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">a</span>                           <span class="o">=</span> <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span>
                <span class="n">e_ssi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">)]))</span>
    <span class="n">med_e_ssi</span> <span class="o">=</span> <span class="n">median</span><span class="p">(</span><span class="n">e_ssi</span><span class="p">)</span>
    <span class="n">Q</span><span class="o">=</span><span class="p">(</span><span class="n">e_ssi</span><span class="o">-</span><span class="n">med_e_ssi</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">e_ssi</span><span class="o">-</span><span class="n">med_e_ssi</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Q</span></div>
     
<div class="viewcode-block" id="addAttributesStitchedScans"><a class="viewcode-back" href="../../../../../PyLOSt.ui.stitch_algorithms.util.html#PyLOSt.ui.stitch_algorithms.util.util_stitching.addAttributesStitchedScans">[docs]</a><span class="k">def</span> <span class="nf">addAttributesStitchedScans</span><span class="p">(</span><span class="n">h5si</span><span class="p">,</span> <span class="n">h5fi</span><span class="p">,</span> <span class="n">isSlopeStitch</span><span class="p">,</span> <span class="n">subRefFlag</span><span class="p">,</span> <span class="n">gravitySubFlag</span><span class="p">,</span> <span class="n">pix_size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add additional attributes to stitched scans</span>

<span class="sd">    :param h5si: Subaperture data object</span>
<span class="sd">    :param h5fi: Stitched data object</span>
<span class="sd">    :param isSlopeStitch: Slope or height flag</span>
<span class="sd">    :param subRefFlag: Subtract reference flag</span>
<span class="sd">    :param gravitySubFlag: Subtract gravity flag</span>
<span class="sd">    :param pix_size: Pixel size</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">h5fi</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NX_class&#39;</span><span class="p">]</span>                  <span class="o">=</span> <span class="s1">&#39;NXdata&#39;</span>
    <span class="n">h5fi</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>                      <span class="o">=</span> <span class="s1">&#39;Stitched&#39;</span><span class="o">+</span><span class="n">h5si</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">h5fi</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;scan_number&#39;</span><span class="p">]</span>               <span class="o">=</span> <span class="n">h5si</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;scan_number&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;scan_number&#39;</span> <span class="ow">in</span> <span class="n">h5si</span><span class="o">.</span><span class="n">attrs</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">h5fi</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span>                       <span class="o">=</span> <span class="n">h5si</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;scan_direction&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;scan_direction&#39;</span> <span class="ow">in</span> <span class="n">h5si</span><span class="o">.</span><span class="n">attrs</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
    <span class="n">h5fi</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;isRefSubtracted&#39;</span><span class="p">]</span>           <span class="o">=</span> <span class="n">subRefFlag</span>
    <span class="n">h5fi</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;isGravitySubtracted&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">gravitySubFlag</span>
    <span class="k">if</span> <span class="n">isSlopeStitch</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;slopes_x&#39;</span> <span class="ow">in</span> <span class="n">h5fi</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;slopes_y&#39;</span> <span class="ow">in</span> <span class="n">h5fi</span><span class="p">):</span>
        <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;urad&#39;</span>
        <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;slopes_y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;urad&#39;</span>
        <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;pix_size&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">pix_size</span>
        <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;slopes_y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;pix_size&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">pix_size</span>
    <span class="k">elif</span> <span class="s1">&#39;height&#39;</span> <span class="ow">in</span> <span class="n">h5fi</span><span class="p">:</span>
        <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h5si</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
        <span class="n">h5fi</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;pix_size&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">pix_size</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;ref&#39;</span> <span class="ow">in</span> <span class="n">h5si</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;rawfile_loc&#39;</span> <span class="ow">in</span> <span class="n">h5si</span><span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">):</span>
        <span class="n">h5fi</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ref_rawfile_loc&#39;</span><span class="p">]</span>           <span class="o">=</span> <span class="n">h5si</span><span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;rawfile_loc&#39;</span><span class="p">]</span></div>
        
<div class="viewcode-block" id="calcMatrixInv"><a class="viewcode-back" href="../../../../../PyLOSt.ui.stitch_algorithms.util.html#PyLOSt.ui.stitch_algorithms.util.util_stitching.calcMatrixInv">[docs]</a><span class="k">def</span> <span class="nf">calcMatrixInv</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">validPat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SVD&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate inverse of IndexMatrix</span>

<span class="sd">    :param A: IndexMatrix</span>
<span class="sd">    :param validPat: Valid subapertures</span>
<span class="sd">    :param method: Inversion method e.g.SVD inverse</span>
<span class="sd">    :return: Inverse IndexMatrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;SVD&#39;</span><span class="p">:</span>
        <span class="n">nzP</span>  <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">A</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">*</span><span class="n">validPat</span>
        <span class="n">B</span><span class="o">=</span><span class="n">A</span><span class="p">[:,</span><span class="n">nzP</span><span class="p">]</span>
        <span class="n">nzOV</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">B</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">C</span><span class="o">=</span><span class="n">B</span><span class="p">[</span><span class="n">nzOV</span><span class="p">,:]</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">vh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">invC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">vh</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="o">**-</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">u</span><span class="p">)))</span>
        <span class="n">invA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="n">invB</span> <span class="o">=</span> <span class="n">invA</span><span class="p">[:,</span><span class="n">nzOV</span><span class="p">]</span>
        <span class="n">invB</span><span class="p">[</span><span class="n">nzP</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">invC</span>
        <span class="n">invA</span><span class="p">[:,</span><span class="n">nzOV</span><span class="p">]</span> <span class="o">=</span> <span class="n">invB</span>
        <span class="k">return</span> <span class="n">invA</span></div>
    
<div class="viewcode-block" id="planeFit2D"><a class="viewcode-back" href="../../../../../PyLOSt.ui.stitch_algorithms.util.html#PyLOSt.ui.stitch_algorithms.util.util_stitching.planeFit2D">[docs]</a><span class="k">def</span> <span class="nf">planeFit2D</span><span class="p">(</span> <span class="n">Z</span><span class="p">,</span>  <span class="n">pix_size</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;LS&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit a plane to 2D data</span>

<span class="sd">    :param Z: Input data</span>
<span class="sd">    :param pix_size: Pixel size</span>
<span class="sd">    :param mask: Data mask</span>
<span class="sd">    :param method: Fitting method e.g. least squares</span>
<span class="sd">    :return: Fit coefficients</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">)</span>
    <span class="n">v</span>                           <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>
    <span class="n">mn</span>                          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># top left corner on the mask</span>
    <span class="n">mx</span>                          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># bottom right corner on the mask</span>

    <span class="n">Zs</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">mn</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span><span class="n">mx</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span><span class="n">mn</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span><span class="n">mx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">mask_s</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">mn</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span><span class="n">mx</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span><span class="n">mn</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span><span class="n">mx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">Zf</span> <span class="o">=</span> <span class="n">Zs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">mf</span> <span class="o">=</span> <span class="n">mask_s</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">ny</span><span class="p">,</span><span class="n">nx</span> <span class="o">=</span> <span class="n">Zs</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nx</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ny</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">pix_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">pix_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="n">xv</span><span class="p">,</span><span class="n">yv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">xv</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">yv</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">xv</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">C</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">mf</span><span class="p">],</span> <span class="n">Zf</span><span class="p">[</span><span class="n">mf</span><span class="p">])</span> <span class="c1"># coefficients C[0]*X + C[1]*Y + C[2]</span>
    <span class="k">return</span> <span class="n">C</span></div>

<div class="viewcode-block" id="pad_along_axis"><a class="viewcode-back" href="../../../../../PyLOSt.ui.stitch_algorithms.util.html#PyLOSt.ui.stitch_algorithms.util.util_stitching.pad_along_axis">[docs]</a><span class="k">def</span> <span class="nf">pad_along_axis</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">target_length</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">pad_size</span> <span class="o">=</span> <span class="n">target_length</span> <span class="o">-</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">pad_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">array</span>
    <span class="n">npad</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">*</span> <span class="n">array</span><span class="o">.</span><span class="n">ndim</span>
    <span class="n">npad</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pad_size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">pad_width</span><span class="o">=</span><span class="n">npad</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="rolling_sum"><a class="viewcode-back" href="../../../../../PyLOSt.ui.stitch_algorithms.util.html#PyLOSt.ui.stitch_algorithms.util.util_stitching.rolling_sum">[docs]</a><span class="k">def</span> <span class="nf">rolling_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="p">:</span> <span class="c1">#axis 0</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rolling sum of data</span>
<span class="sd">    :param a: Data</span>
<span class="sd">    :param n: Degree</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">ret</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span> <span class="o">-</span> <span class="n">ret</span><span class="p">[:</span><span class="o">-</span><span class="n">n</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:]</span></div>

<span class="c1"># difference between i,i+k elements</span>
<div class="viewcode-block" id="diff_k"><a class="viewcode-back" href="../../../../../PyLOSt.ui.stitch_algorithms.util.html#PyLOSt.ui.stitch_algorithms.util.util_stitching.diff_k">[docs]</a><span class="k">def</span> <span class="nf">diff_k</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="p">:</span> <span class="c1">#axis 0</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    n-th order difference of an array</span>

<span class="sd">    :param a: Data</span>
<span class="sd">    :param n: difference degree</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># default</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">a</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[:</span><span class="o">-</span><span class="n">n</span><span class="p">]</span></div>

<div class="viewcode-block" id="buildOverlapMatrices"><a class="viewcode-back" href="../../../../../PyLOSt.ui.stitch_algorithms.util.html#PyLOSt.ui.stitch_algorithms.util.util_stitching.buildOverlapMatrices">[docs]</a><span class="k">def</span> <span class="nf">buildOverlapMatrices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oXArr</span><span class="p">,</span> <span class="n">pat_arr</span><span class="p">,</span> <span class="n">mask_arr</span><span class="p">,</span> <span class="n">res_szY</span><span class="p">,</span> <span class="n">res_szX</span><span class="p">,</span> <span class="n">otype</span><span class="p">,</span> <span class="n">fitData</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">extractRef</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">degRef</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">refType</span><span class="o">=</span><span class="s1">&#39;legendre&#39;</span><span class="p">,</span> <span class="n">startDegRef</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build overlap errors</span>

<span class="sd">    :param self: Stitching function reference object</span>
<span class="sd">    :param oXArr: Translation offset array</span>
<span class="sd">    :param pat_arr: Subaperture array</span>
<span class="sd">    :param mask_arr: Mask array of subapertures</span>
<span class="sd">    :param res_szY: Stitching result size Y</span>
<span class="sd">    :param res_szX: Stitching result size X</span>
<span class="sd">    :param otype: Data type slope/height</span>
<span class="sd">    :param fitData: Flag to fit plane to overlap</span>
<span class="sd">    :param extractRef: Flag to retrieve reference from fitting polynomial</span>
<span class="sd">    :param degRef: Polynomial degree to use for extracting reference from fitting</span>
<span class="sd">    :param refType: Reference fit type e.g. fit to legendre</span>
<span class="sd">    :param startDegRef: Start degree for reference. Usually degree&lt;2 are excluded as theses reference orders cannot be extracted from measured data</span>
<span class="sd">    :return: IndexMatrix, overlaps matrix, overalap errors pitch/roll/piston, max overlap count, valid overlaps, valid subapertures, subaperture array, maximum overlap order, piston array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">patch_count</span>                 <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">oXArr</span><span class="p">)</span>
    <span class="n">szPat</span>                       <span class="o">=</span> <span class="n">mask_arr</span><span class="o">.</span><span class="n">shape</span> <span class="c1"># shape (patch_count, patSzY, patSzX)</span>
    <span class="n">max_mask</span>                    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask_arr</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># maximum applicable mask elements</span>
    <span class="n">v</span>                           <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">max_mask</span><span class="p">))</span>
    <span class="n">mn</span>                          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mx</span>                          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">szM</span>                         <span class="o">=</span> <span class="n">mx</span> <span class="o">-</span> <span class="n">mn</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> 
    <span class="n">validPatches</span>                <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">([</span><span class="n">patch_count</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">Ep</span>                          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">([</span><span class="n">patch_count</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="c1">#s_mean_img                  = np.nanmean(pat_arr[:,mn[-2]:mn[-2]+szM[-2],mn[-1]:mn[-1]+szM[-1]],axis=0)</span>
    <span class="n">pix_sz</span>                      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix_size</span>
    <span class="k">if</span> <span class="n">otype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sx&#39;</span><span class="p">,</span> <span class="s1">&#39;sy&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">]:</span>
        <span class="n">sarr</span>                                <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">([</span><span class="n">patch_count</span><span class="p">,</span> <span class="n">szM</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">szM</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">res_szX</span><span class="o">-</span><span class="n">szPat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="c1"># </span>
        <span class="n">sarr_mask</span>                           <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">sarr</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="c1"># </span>
        <span class="n">sarr_ret</span>                            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">([</span><span class="n">patch_count</span><span class="p">,</span> <span class="n">res_szY</span><span class="p">,</span> <span class="n">res_szX</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useFullImages</span> <span class="k">else</span> <span class="n">sarr</span><span class="c1"># returned array contains all values before masking, intermediate patch slope/height array, filled by nan outside patch field of view</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ox</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">oXArr</span><span class="p">):</span> <span class="c1">#offsets X array</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">useFullImages</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">applyMaskCorImg</span> <span class="p">:</span>
                    <span class="n">sarr_ret</span><span class="p">[</span><span class="n">j</span><span class="p">,:,</span><span class="n">ox</span><span class="p">:</span><span class="n">ox</span><span class="o">+</span><span class="n">szPat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>       <span class="o">=</span> <span class="n">mask_arr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pat_arr</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sarr_ret</span><span class="p">[</span><span class="n">j</span><span class="p">,:,</span><span class="n">ox</span><span class="p">:</span><span class="n">ox</span><span class="o">+</span><span class="n">szPat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pat_arr</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
            
            <span class="n">pat_arr</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="o">~</span><span class="n">mask_arr</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">otemp</span>                               <span class="o">=</span> <span class="n">pat_arr</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">mn</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span><span class="n">mn</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">szM</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span><span class="n">mn</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span><span class="n">mn</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">szM</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

            <span class="c1"># TODO</span>
            <span class="c1"># if self.filtBadPix:</span>
            <span class="c1">#     maskBadPix                      = filtBadPixels(self, otemp, pix_sz)</span>
            <span class="c1">#     otemp[~maskBadPix]              = np.nan</span>
            <span class="c1">#     mask_arr[j, mn[-2]:mn[-2] + szM[-2], mn[-1]:mn[-1] + szM[-1]] = mask_arr[j,mn[-2]:mn[-2]+szM[-2],mn[-1]:mn[-1]+szM[-1]]*maskBadPix</span>
            
            <span class="n">sarr</span><span class="p">[</span><span class="n">j</span><span class="p">,:</span><span class="n">szM</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span><span class="n">ox</span><span class="p">:</span><span class="n">ox</span><span class="o">+</span><span class="n">szM</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>      <span class="o">=</span> <span class="n">otemp</span>
            <span class="n">sarr_mask</span><span class="p">[</span><span class="n">j</span><span class="p">,:</span><span class="n">szM</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span><span class="n">ox</span><span class="p">:</span><span class="n">ox</span><span class="o">+</span><span class="n">szM</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mask_arr</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">mn</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span><span class="n">mn</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">szM</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span><span class="n">mn</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span><span class="n">mn</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">szM</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">validPatches</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>                     <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pat_arr</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="k">else</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fin prepare data objects&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">removeOutlierPatches</span><span class="p">:</span>
            <span class="c1"># mask of validpatches: exclude outlier patches</span>
            <span class="n">pat_savg</span>                            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">((</span><span class="n">pat_arr</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">med_savg</span>                            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">pat_savg</span><span class="p">[</span><span class="n">validPatches</span><span class="p">])</span>
            <span class="n">Q</span>                                   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pat_savg</span><span class="o">-</span><span class="n">med_savg</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">pat_savg</span><span class="p">[</span><span class="n">validPatches</span><span class="p">]</span><span class="o">-</span><span class="n">med_savg</span><span class="p">)</span> <span class="c1">#use proximity to neighbours instead</span>
            <span class="n">sarr</span><span class="p">[</span><span class="o">~</span><span class="n">Q</span><span class="p">,:,:]</span>                        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">sarr_mask</span><span class="p">[</span><span class="o">~</span><span class="n">Q</span><span class="p">,:,:]</span>                   <span class="o">=</span> <span class="kc">False</span>
            <span class="n">validPatches</span>                        <span class="o">=</span> <span class="n">validPatches</span> <span class="o">*</span> <span class="n">Q</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fin remove outlier subapertures&#39;</span><span class="p">)</span>
        
        <span class="c1">#filter before stitching for coeffs 0 order to 2nd order</span>
        <span class="n">sz_sarr</span>                             <span class="o">=</span> <span class="n">sarr</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">s_mean_piston</span>                       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">sarr</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preFiltArr</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">sarr</span>                            <span class="o">=</span> <span class="n">sarr</span><span class="o">-</span><span class="n">s_mean_piston</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sz_sarr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fin filter piston&#39;</span><span class="p">)</span>
        
        <span class="c1"># roughly determine max k, for given minoverlap</span>
        <span class="n">max_pix_offset</span>                      <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">szM</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">minOverlap</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">minOverlap</span><span class="p">))</span> <span class="c1">#max step to remain within min overlap</span>
        <span class="n">max_k</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">diff_k</span><span class="p">(</span><span class="n">oXArr</span><span class="p">,</span><span class="n">max_k</span><span class="p">)</span><span class="o">&lt;</span><span class="n">max_pix_offset</span><span class="p">):</span> <span class="c1"># max offset satisfied for all steps. need this if multiple steps are used</span>
            <span class="n">max_k</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="n">max_ov_cnt</span>                          <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_k</span><span class="o">*</span><span class="n">patch_count</span> <span class="o">-</span> <span class="p">(</span><span class="n">max_k</span><span class="o">*</span><span class="p">(</span><span class="n">max_k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="c1"># sum of series pc-1 + pc-2 + ...+ pc-max_k   #int(patch_count*(patch_count-1)/2) #nc2 combinations of overlaps</span>
        <span class="n">A</span>                                   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">([</span><span class="n">max_ov_cnt</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">patch_count</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span> <span class="c1"># 1 more for global tilts &amp; piston, A[-1]=1</span>
        <span class="n">sarr_diff</span>                           <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">([</span><span class="n">max_ov_cnt</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">sz_sarr</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">sz_sarr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> 
        <span class="n">Ep_diff</span>                             <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">([</span><span class="n">max_ov_cnt</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">extractRef</span> <span class="k">else</span> <span class="mi">3</span><span class="o">+</span><span class="p">(</span><span class="n">degRef</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">overlapCoeffArr</span>                     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">([</span><span class="n">max_ov_cnt</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span> 
        
        <span class="n">k</span>                                   <span class="o">=</span> <span class="mi">1</span> <span class="c1">#diff step=1 or neighbouring elements</span>
        <span class="n">overlapCoeff</span>                        <span class="o">=</span> <span class="mi">1</span>
        <span class="n">nbPatEl</span>                             <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sarr</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">nbPatElDiag</span>                         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">nbPatEl</span><span class="p">)</span>
        <span class="n">AI</span>                                  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">patch_count</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Start overlap error matrices&#39;</span><span class="p">)</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cf</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">overlapCoeff</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">minOverlap</span> <span class="ow">and</span> <span class="n">k</span><span class="o">&lt;=</span><span class="n">max_k</span><span class="p">:</span>
            <span class="n">A_k</span>                             <span class="o">=</span> <span class="n">diff_k</span><span class="p">(</span><span class="n">AI</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
            <span class="n">sarr_diff_k</span>                     <span class="o">=</span> <span class="n">diff_k</span><span class="p">(</span><span class="n">sarr</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
            <span class="c1">#Ep_diff_k                       = diff_k(Ep,k)</span>
            <span class="n">nbPatElDiag_diff_k</span>              <span class="o">=</span> <span class="n">diff_k</span><span class="p">(</span><span class="n">nbPatElDiag</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
            
            <span class="n">nbOverlapElements_k</span>             <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sarr_diff_k</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">nbElTot_k</span>                       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">nbPatElDiag_diff_k</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">nbOverlapElements_k</span>
            <span class="n">overlapCoeff_k</span>                  <span class="o">=</span> <span class="n">nbOverlapElements_k</span><span class="o">/</span><span class="n">nbElTot_k</span>
            <span class="n">overlapCoeff_k</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">overlapCoeff_k</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">overlapCoeff</span>                    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">overlapCoeff_k</span><span class="p">)</span> <span class="c1"># atleast 1 diff element has overlap larger than minimum overlap criteria</span>
            
            <span class="n">ci</span>                              <span class="o">=</span> <span class="n">cf</span>                    <span class="c1"># first index starts at 0</span>
            <span class="n">cf</span>                              <span class="o">=</span> <span class="n">ci</span><span class="o">+</span><span class="n">A_k</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>       <span class="c1"># last index not included in slicing</span>
            <span class="n">A</span><span class="p">[</span><span class="n">ci</span><span class="p">:</span><span class="n">cf</span><span class="p">]</span>                        <span class="o">=</span> <span class="n">A_k</span>                   <span class="c1"># slicing in axis 0</span>
            <span class="n">sarr_diff</span><span class="p">[</span><span class="n">ci</span><span class="p">:</span><span class="n">cf</span><span class="p">]</span>                <span class="o">=</span> <span class="n">sarr_diff_k</span>
            <span class="n">overlapCoeffArr</span><span class="p">[</span><span class="n">ci</span><span class="p">:</span><span class="n">cf</span><span class="p">]</span>          <span class="o">=</span> <span class="n">overlapCoeff_k</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">patch_count</span><span class="o">-</span><span class="n">k</span><span class="p">):</span>
                <span class="n">i1</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span> <span class="n">i2</span><span class="o">=</span><span class="n">j</span><span class="o">+</span><span class="n">k</span>
                <span class="k">if</span> <span class="n">fitData</span> <span class="ow">and</span> <span class="n">overlapCoeff_k</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">minOverlap</span><span class="p">:</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">sarr_mask</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span><span class="o">*</span><span class="n">sarr_mask</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span><span class="o">*~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sarr</span><span class="p">[</span><span class="n">i1</span><span class="p">,:,:])</span><span class="o">*~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sarr</span><span class="p">[</span><span class="n">i2</span><span class="p">,:,:])</span>
                    <span class="n">f1</span><span class="p">,</span><span class="n">f1resd</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">fit2D</span><span class="p">(</span><span class="n">sarr</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">mask</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">pix_size</span><span class="o">=</span><span class="n">pix_sz</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">useMaskForXY</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">retResd</span><span class="o">=</span><span class="n">extractRef</span><span class="p">)</span>
                    <span class="n">f2</span><span class="p">,</span><span class="n">f2resd</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">fit2D</span><span class="p">(</span><span class="n">sarr</span><span class="p">[</span><span class="n">i2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">mask</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">pix_size</span><span class="o">=</span><span class="n">pix_sz</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">useMaskForXY</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">retResd</span><span class="o">=</span><span class="n">extractRef</span><span class="p">)</span>
                    <span class="n">Ep_diff</span><span class="p">[</span><span class="n">ci</span><span class="o">+</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">f2</span><span class="o">-</span><span class="n">f1</span>
                    <span class="k">if</span> <span class="n">extractRef</span><span class="p">:</span>
                        <span class="n">f1R</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">fit2D</span><span class="p">(</span><span class="n">f1resd</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">pix_size</span><span class="o">=</span><span class="n">pix_sz</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="n">degRef</span><span class="p">,</span> <span class="n">start_degree</span><span class="o">=</span><span class="n">startDegRef</span><span class="p">,</span> <span class="n">useMaskForXY</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="n">refType</span><span class="p">,</span> <span class="n">retResd</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">f2R</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">fit2D</span><span class="p">(</span><span class="n">f2resd</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">pix_size</span><span class="o">=</span><span class="n">pix_sz</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="n">degRef</span><span class="p">,</span> <span class="n">start_degree</span><span class="o">=</span><span class="n">startDegRef</span><span class="p">,</span> <span class="n">useMaskForXY</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="n">refType</span><span class="p">,</span> <span class="n">retResd</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">Ep_diff</span><span class="p">[</span><span class="n">ci</span><span class="o">+</span><span class="n">j</span><span class="p">,</span><span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="n">f2R</span><span class="o">-</span><span class="n">f1R</span>
            
            <span class="n">k</span><span class="o">+=</span><span class="mi">1</span>
        
        <span class="c1"># global pitch/roll/piston</span>
        <span class="n">A</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>                                   <span class="o">=</span> <span class="mi">1</span>
        <span class="n">sarr_diff</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="n">szM</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="p">:</span><span class="n">szM</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>       <span class="o">=</span> <span class="mi">0</span> 
        <span class="n">Ep_diff</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>                             <span class="o">=</span> <span class="mi">0</span> 
        
        <span class="n">validOverlaps</span>                           <span class="o">=</span> <span class="n">overlapCoeffArr</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">minOverlap</span> <span class="c1">#logical array of valid overlaps (for axis 0)</span>
        <span class="n">hangingPats</span>                             <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">A</span><span class="p">[:,</span><span class="n">validPatches</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#remove overlap pair corresponding to invalid patches</span>
        <span class="n">validOverlaps</span>                           <span class="o">=</span> <span class="n">validOverlaps</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">hangingPats</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">validOverlaps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>                       <span class="o">=</span> <span class="kc">True</span> <span class="c1">#Global tilts/ piston</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fin build overlap error matrices&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">sarr_diff</span><span class="p">,</span> <span class="n">Ep_diff</span><span class="p">,</span> <span class="n">max_ov_cnt</span><span class="p">,</span> <span class="n">validOverlaps</span><span class="p">,</span> <span class="n">validPatches</span><span class="p">,</span> <span class="n">sarr_ret</span><span class="p">,</span> <span class="n">max_k</span><span class="p">,</span> <span class="n">s_mean_piston</span></div>


</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../index.html">PyLOSt</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../PyLOSt.html">PyLOSt package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../quick_guide.html">Quick Guide</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>