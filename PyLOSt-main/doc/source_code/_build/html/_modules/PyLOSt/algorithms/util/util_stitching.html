
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PyLOSt.algorithms.util.util_stitching &#8212; PyLOSt  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/alabaster.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for PyLOSt.algorithms.util.util_stitching</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Mar 9, 2019</span>

<span class="sd">Util functions used in fast stitching algorithms</span>

<span class="sd">@author: ADAPA</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">cProfile</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">pstats</span>
<span class="kn">import</span> <span class="nn">timeit</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="n">imshow</span><span class="p">,</span> <span class="n">plot</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">spdiags</span><span class="p">,</span> <span class="n">lil_matrix</span>

<span class="kn">from</span> <span class="nn">PyLOSt.algorithms.util.util_fit</span> <span class="kn">import</span> <span class="n">fit2D</span><span class="p">,</span> <span class="n">getXYGrid</span>
<span class="kn">from</span> <span class="nn">PyLOSt.algorithms.util.util_math</span> <span class="kn">import</span> <span class="n">rms</span><span class="p">,</span> <span class="n">rmse</span><span class="p">,</span> <span class="n">nbTermsPoly</span>

<span class="kn">from</span> <span class="nn">scipy.sparse.linalg.dsolve.linsolve</span> <span class="kn">import</span> <span class="n">spsolve</span>
<span class="kn">from</span> <span class="nn">scipy.sparse.coo</span> <span class="kn">import</span> <span class="n">coo_matrix</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>


<div class="viewcode-block" id="start_profiler"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_stitching.start_profiler">[docs]</a><span class="k">def</span> <span class="nf">start_profiler</span><span class="p">():</span>
    <span class="n">profiler</span> <span class="o">=</span> <span class="n">cProfile</span><span class="o">.</span><span class="n">Profile</span><span class="p">()</span>
    <span class="n">profiler</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">profiler</span></div>

<div class="viewcode-block" id="print_profiler"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_stitching.print_profiler">[docs]</a><span class="k">def</span> <span class="nf">print_profiler</span><span class="p">(</span><span class="n">profiler</span><span class="p">):</span>
    <span class="n">profiler</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">pstats</span><span class="o">.</span><span class="n">Stats</span><span class="p">(</span><span class="n">profiler</span><span class="p">)</span><span class="o">.</span><span class="n">sort_stats</span><span class="p">(</span><span class="s1">&#39;cumtime&#39;</span><span class="p">)</span>
    <span class="n">stats</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span></div>

<div class="viewcode-block" id="flatten_list"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_stitching.flatten_list">[docs]</a><span class="k">def</span> <span class="nf">flatten_list</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">a</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span></div>

<div class="viewcode-block" id="filtBadPixels"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_stitching.filtBadPixels">[docs]</a><span class="k">def</span> <span class="nf">filtBadPixels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sarr</span><span class="p">,</span> <span class="n">pix_sz</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter pixels above n-std from global shape.</span>

<span class="sd">    :param self: Stitching function reference object</span>
<span class="sd">    :param sarr: Input data</span>
<span class="sd">    :param pix_sz: Pixel size</span>
<span class="sd">    :return: Filter mask</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">maxStd</span>                      <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filt_bad_pix_threshold</span><span class="p">)</span>
    <span class="n">sz</span>                          <span class="o">=</span> <span class="n">sarr</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">mask</span>                        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">sarr</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">deg</span>                         <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">key</span><span class="o">==</span><span class="s1">&#39;height&#39;</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">resd</span><span class="p">,</span> <span class="n">_</span>              <span class="o">=</span> <span class="n">fit2D</span><span class="p">(</span><span class="n">sarr</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">pix_size</span><span class="o">=</span><span class="n">pix_sz</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="n">deg</span><span class="p">,</span> <span class="n">retResd</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">rmsResd</span>                 <span class="o">=</span> <span class="n">rms</span><span class="p">(</span><span class="n">resd</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">j</span><span class="p">,:,:]</span>             <span class="o">=</span> <span class="n">resd</span> <span class="o">&lt;</span> <span class="n">maxStd</span><span class="o">*</span><span class="n">rmsResd</span>
    <span class="k">return</span> <span class="n">mask</span></div>

<div class="viewcode-block" id="optimize_correctors"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_stitching.optimize_correctors">[docs]</a><span class="k">def</span> <span class="nf">optimize_correctors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">P0</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">show_cost</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">P</span>               <span class="o">=</span> <span class="n">P0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">show_cost</span>  <span class="o">=</span> <span class="n">show_cost</span>
    <span class="n">E</span>               <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">E</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">E</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">constraint</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_extract_type</span><span class="o">==</span><span class="s1">&#39;full&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint_zero_sum</span><span class="p">:</span>
            <span class="n">constraint</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">LinearConstraint</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">P0</span><span class="p">),</span> <span class="n">lb</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ub</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bound_nstd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">bound_nstd</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">subap_avg_rms</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">bound_nstd</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">subap_avg_rms</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">P0</span><span class="p">]</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;least_squares_nonlinear&#39;</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">least_squares</span><span class="p">(</span><span class="n">errfunc</span><span class="p">,</span> <span class="n">P0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">E</span><span class="p">))</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
    <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;least_squares_linear&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">bound_nstd</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">subap_avg_rms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bound_nstd</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">subap_avg_rms</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">lsq_linear</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">E</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">lsq_linear</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">E</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
    <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;minimize&#39;</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">costfunc</span><span class="p">,</span> <span class="n">P0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">E</span><span class="p">),</span> <span class="n">constraints</span><span class="o">=</span><span class="n">constraint</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">P0</span>
        <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Result : &#39;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">default_timer</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time: &#39;</span><span class="p">,</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">P</span></div>

<div class="viewcode-block" id="errfunc"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_stitching.errfunc">[docs]</a><span class="k">def</span> <span class="nf">errfunc</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">E</span><span class="p">):</span>
    <span class="n">AP</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="n">AP</span> <span class="o">=</span> <span class="n">AP</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">err_F</span> <span class="o">=</span> <span class="n">AP</span> <span class="o">-</span> <span class="n">E</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;rms(err_F): </span><span class="si">{:.5f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rms</span><span class="p">(</span><span class="n">err_F</span><span class="p">)))</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_cost</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_info</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">err_F</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;costfunc&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">err_F</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">err_F</span><span class="p">)]</span></div>

<div class="viewcode-block" id="costfunc"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_stitching.costfunc">[docs]</a><span class="k">def</span> <span class="nf">costfunc</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">E</span><span class="p">):</span>
    <span class="n">AP</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="n">AP</span> <span class="o">=</span> <span class="n">AP</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">err_F</span> <span class="o">=</span> <span class="n">AP</span> <span class="o">-</span> <span class="n">E</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;rms(costfunc): </span><span class="si">{:.5f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rms</span><span class="p">(</span><span class="n">err_F</span><span class="p">)))</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_cost</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_info</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">err_F</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;costfunc&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">err_F</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_sparse_inv"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_stitching.get_sparse_inv">[docs]</a><span class="k">def</span> <span class="nf">get_sparse_inv</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">E</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">asfptype</span><span class="p">()</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">vt</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svds</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">invA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">s</span><span class="p">),</span> <span class="n">u</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">invA</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span></div>

<div class="viewcode-block" id="calc_inverse"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_stitching.calc_inverse">[docs]</a><span class="k">def</span> <span class="nf">calc_inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">E</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># square</span>
        <span class="k">return</span> <span class="n">spsolve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spsolve</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">A</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">E</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_type</span><span class="o">==</span><span class="s1">&#39;SVD&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">get_sparse_inv</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">invA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">toarray</span><span class="p">())</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">invA</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="get_A_allpix"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_stitching.get_A_allpix">[docs]</a><span class="k">def</span> <span class="nf">get_A_allpix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">sdiff</span><span class="p">,</span> <span class="n">mX</span><span class="p">,</span> <span class="n">mY</span><span class="p">,</span> <span class="n">pix_size</span><span class="p">,</span> <span class="n">res_item</span><span class="p">,</span> <span class="n">otype</span><span class="p">,</span> <span class="n">prog_block</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    :param A: IndexMatrix</span>
<span class="sd">    :param sdiff: Overlap errors array of all pixels</span>
<span class="sd">    :param oXArr: Translation offset array</span>
<span class="sd">    :return: Correctors array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask_mir</span>            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">res_item</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">xx_mir</span><span class="p">,</span> <span class="n">yy_mir</span>      <span class="o">=</span> <span class="n">getXYGrid</span><span class="p">(</span><span class="n">mask_mir</span><span class="p">,</span> <span class="n">pix_size</span><span class="o">=</span><span class="n">pix_size</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask_mir</span><span class="p">)</span>

    <span class="n">nbPat</span>               <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mX</span><span class="p">)</span>
    <span class="n">rows</span>                <span class="o">=</span> <span class="p">[]</span>        <span class="c1"># counts overlaps x valid pixels in each ovrlap</span>
    <span class="n">cols</span>                <span class="o">=</span> <span class="p">[]</span>        <span class="c1"># counts number of subapertures x number of fit params (e.g. 3 for piston/pitch/roll)</span>
    <span class="n">data</span>                <span class="o">=</span> <span class="p">[]</span>
    <span class="n">row</span>                 <span class="o">=</span> <span class="mi">0</span>
    <span class="n">new_block</span> <span class="o">=</span> <span class="n">prog_block</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Building full matrix : </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">key</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sdiff</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="n">osz</span> <span class="o">=</span> <span class="n">sdiff</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>

        <span class="n">ox</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">mX</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mX</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">oy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">mY</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mY</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">slc</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">oy</span><span class="p">,</span> <span class="n">oy</span> <span class="o">+</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span><span class="nb">slice</span><span class="p">(</span><span class="n">ox</span><span class="p">,</span> <span class="n">ox</span> <span class="o">+</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">xm</span> <span class="o">=</span> <span class="n">xx_mir</span><span class="p">[</span><span class="n">slc</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">ym</span> <span class="o">=</span> <span class="n">yy_mir</span><span class="p">[</span><span class="n">slc</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">osz</span><span class="p">):</span>
            <span class="n">rows</span> <span class="o">+=</span> <span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="k">if</span> <span class="n">otype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">,</span> <span class="s1">&#39;slopes_y&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">6</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">otype</span><span class="o">==</span><span class="s1">&#39;height&#39;</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">nbPat</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nbPat</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">key</span><span class="p">])</span><span class="o">*</span><span class="n">osz</span>
        <span class="k">elif</span> <span class="n">otype</span><span class="o">==</span><span class="s1">&#39;slopes_y&#39;</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">+=</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">nbPat</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">key</span><span class="p">]</span><span class="o">*</span><span class="n">osz</span>
        <span class="k">elif</span> <span class="n">otype</span><span class="o">==</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">+=</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nbPat</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">key</span><span class="p">]</span><span class="o">*</span><span class="n">osz</span>
        <span class="n">data</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">*</span><span class="n">osz</span> <span class="k">if</span> <span class="n">otype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">,</span> <span class="s1">&#39;slopes_y&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">flatten_list</span><span class="p">([(</span><span class="nb">list</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">+</span> <span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="n">ym</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">A</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="n">xm</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">A</span><span class="p">[</span><span class="n">key</span><span class="p">]])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">osz</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">increment_progress</span><span class="p">(</span><span class="n">new_block</span><span class="p">)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">nbPat</span><span class="p">)</span>  <span class="c1"># piston/pitch/roll</span>
    <span class="n">A_coo</span> <span class="o">=</span> <span class="n">coo_matrix</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)),</span> <span class="n">shape</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">increment_progress</span><span class="p">(</span><span class="n">prog_block</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">A_coo</span></div>

<div class="viewcode-block" id="get_sparse_from_dict"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_stitching.get_sparse_from_dict">[docs]</a><span class="k">def</span> <span class="nf">get_sparse_from_dict</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">no</span><span class="p">,</span> <span class="n">np</span> <span class="o">=</span> <span class="n">shape</span>
    <span class="n">shape_coo</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">no</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="p">)</span> <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="mi">2</span> <span class="k">else</span> <span class="n">shape</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># Correctors as overlaps x 3 matrix</span>
            <span class="n">rows</span> <span class="o">+=</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">cols</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">mode</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="c1"># Correctors as overlaps * 3 array</span>
            <span class="n">rows</span> <span class="o">+=</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">no</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">no</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">no</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">no</span><span class="p">]</span>
            <span class="n">cols</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="p">,</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">*</span><span class="mi">3</span>

    <span class="k">return</span> <span class="n">coo_matrix</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)),</span> <span class="n">shape_coo</span><span class="p">)</span></div>


<div class="viewcode-block" id="getOverlaps2D"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_stitching.getOverlaps2D">[docs]</a><span class="k">def</span> <span class="nf">getOverlaps2D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oXArr</span><span class="p">,</span> <span class="n">oYArr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">otype</span><span class="p">,</span> <span class="n">pix_sz</span><span class="p">,</span> <span class="n">cor_terms</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span> <span class="n">cor_ref</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fit_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showPlots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prog_block</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build overlap errors</span>

<span class="sd">    :param self: Stitching function reference object</span>
<span class="sd">    :param oXArr: Translation offset array</span>
<span class="sd">    :param data: Subaperture array</span>
<span class="sd">    :param otype: Data type slope/height</span>
<span class="sd">    :param cor_terms: Correction terms - piston/roll/pitch</span>
<span class="sd">    :param extractRef: Flag to retrieve reference from fitting polynomial</span>
<span class="sd">    :param degRef: Polynomial degree to use for extracting reference from fitting</span>
<span class="sd">    :param startDegRef: Start degree for reference. Usually degree&lt;2 are excluded as theses reference orders cannot be extracted from measured data</span>
<span class="sd">    :return: IndexMatrix, overlaps matrix, overalap errors pitch/roll/piston, max overlap count, valid overlaps, valid subapertures, subaperture array, maximum overlap order, piston array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nPat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">oXArr</span><span class="p">)</span>
    <span class="n">validPatches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">([</span><span class="n">nPat</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">otype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">,</span> <span class="s1">&#39;slopes_y&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">]:</span>
        <span class="n">sarr</span>                <span class="o">=</span> <span class="n">data</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_exclude_subaps</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">sarr</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">num_exclude_subaps</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">sarr</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">num_exclude_subaps</span><span class="p">:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">sarr_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sarr</span><span class="p">)</span>
        <span class="c1">## Filter: bad pixels above n*std from ideal shape</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filt_bad_pix</span><span class="p">:</span>
            <span class="n">maskBadPix</span>          <span class="o">=</span> <span class="n">filtBadPixels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sarr</span><span class="p">,</span> <span class="n">pix_sz</span><span class="p">,</span> <span class="n">otype</span><span class="p">)</span>
            <span class="n">sarr_mask</span>           <span class="o">=</span> <span class="n">sarr_mask</span> <span class="o">*</span> <span class="n">maskBadPix</span>
            <span class="n">sarr</span><span class="p">[</span><span class="o">~</span><span class="n">sarr_mask</span><span class="p">]</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">res_mask_szY</span>        <span class="o">=</span> <span class="n">sarr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="nb">max</span><span class="p">(</span><span class="n">oYArr</span><span class="p">)</span>
        <span class="n">res_mask_szX</span>        <span class="o">=</span> <span class="n">sarr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="nb">max</span><span class="p">(</span><span class="n">oXArr</span><span class="p">)</span>
        <span class="n">mask_mir</span>            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">([</span><span class="n">res_mask_szY</span><span class="p">,</span> <span class="n">res_mask_szX</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">xx_mir</span><span class="p">,</span> <span class="n">yy_mir</span>      <span class="o">=</span> <span class="n">getXYGrid</span><span class="p">(</span><span class="n">mask_mir</span><span class="p">,</span> <span class="n">pix_size</span><span class="o">=</span><span class="n">pix_sz</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask_mir</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fin prepare data objects&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_outlier_subapertures</span><span class="p">:</span>
            <span class="c1"># mask of validpatches: exclude outlier patches</span>
            <span class="n">sarr_rms</span>        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">((</span><span class="n">sarr</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">med_savg</span>        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sarr_rms</span><span class="p">[</span><span class="n">validPatches</span><span class="p">])</span>
            <span class="n">Q</span>               <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sarr_rms</span> <span class="o">-</span> <span class="n">med_savg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">sarr_rms</span><span class="p">[</span><span class="n">validPatches</span><span class="p">]</span> <span class="o">-</span> <span class="n">med_savg</span><span class="p">)</span>  <span class="c1"># TODO: use proximity to neighbours instead</span>
            <span class="n">sarr</span><span class="p">[</span><span class="o">~</span><span class="n">Q</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">sarr_mask</span><span class="p">[</span><span class="o">~</span><span class="n">Q</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">validPatches</span>    <span class="o">=</span> <span class="n">validPatches</span> <span class="o">*</span> <span class="n">Q</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fin remove outlier subapertures&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">showPlots</span><span class="p">:</span>
            <span class="n">plotSt</span><span class="p">(</span><span class="n">sarr</span><span class="p">,</span> <span class="n">oxArr</span><span class="o">=</span><span class="n">oXArr</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Data after pre processing&#39;</span><span class="p">)</span>

        <span class="n">sz</span> <span class="o">=</span> <span class="n">sarr</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">slc_i</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">slc_j</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sdiff</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">A</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">E</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">E_resd</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">increment_progress</span><span class="p">(</span><span class="n">prog_block</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="n">nPat</span><span class="o">*</span><span class="p">(</span><span class="n">nPat</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">new_block</span> <span class="o">=</span> <span class="n">prog_block</span> <span class="o">*</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="n">cnt</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">oxi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">oXArr</span><span class="p">):</span>
            <span class="n">oyi</span> <span class="o">=</span> <span class="n">oYArr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">oxj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">oXArr</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">:</span>
                    <span class="k">continue</span>  <span class="c1"># we already looped over these overlaps</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">validPatches</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">validPatches</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                    <span class="k">continue</span>

                <span class="n">oyj</span> <span class="o">=</span> <span class="n">oYArr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">dx</span> <span class="o">=</span> <span class="n">oxj</span> <span class="o">-</span> <span class="n">oxi</span>
                <span class="n">dy</span> <span class="o">=</span> <span class="n">oyj</span> <span class="o">-</span> <span class="n">oyi</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dx</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dy</span><span class="p">))</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_overlap</span> <span class="o">*</span> <span class="n">sz</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">sz</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="k">continue</span>  <span class="c1"># not enough overlap (first approximation)</span>

                <span class="n">slc_i</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="n">dy</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">dy</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="k">else</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">dy</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">dx</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="k">else</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">dx</span><span class="p">))</span>
                <span class="n">slc_j</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="n">dy</span><span class="p">)</span> <span class="k">if</span> <span class="n">dy</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="n">dy</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="n">dx</span><span class="p">)</span> <span class="k">if</span> <span class="n">dx</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="n">dx</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="n">sarr</span><span class="p">[</span><span class="n">slc_i</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)]]</span> <span class="o">-</span> <span class="n">sarr</span><span class="p">[</span><span class="n">slc_j</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)]]</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_overlap</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sarr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">())),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sarr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))]):</span>
                    <span class="k">continue</span>  <span class="c1"># not enough overlap (second approximation excluding NaNs)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">ravel</span><span class="p">())):</span>
                    <span class="k">continue</span>

                <span class="n">sdiff</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="n">diff</span>
                <span class="n">A</span><span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">filt_terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span>
                <span class="n">filt_terms</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cor_terms</span>
                <span class="k">if</span> <span class="n">otype</span><span class="o">==</span><span class="s1">&#39;height&#39;</span> <span class="ow">and</span> <span class="n">fit_data</span><span class="p">:</span>
                    <span class="n">ox</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">oxi</span><span class="p">,</span> <span class="n">oxj</span><span class="p">)</span>
                    <span class="n">oy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">oyi</span><span class="p">,</span> <span class="n">oyj</span><span class="p">)</span>
                    <span class="n">slc_mir</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">oy</span><span class="p">,</span> <span class="n">oy</span><span class="o">+</span><span class="n">diff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">slice</span><span class="p">(</span><span class="n">ox</span><span class="p">,</span> <span class="n">ox</span><span class="o">+</span><span class="n">diff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">filt_terms</span><span class="p">):</span>
                        <span class="n">fo</span><span class="p">,</span> <span class="n">resd</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">fit2D</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">pix_size</span><span class="o">=</span><span class="n">pix_sz</span><span class="p">,</span> <span class="n">filter_terms_poly</span><span class="o">=</span><span class="n">filt_terms</span><span class="p">,</span>
                                            <span class="n">retResd</span><span class="o">=</span><span class="n">cor_ref</span><span class="p">,</span> <span class="n">xv</span><span class="o">=</span><span class="n">xx_mir</span><span class="p">[</span><span class="n">slc_mir</span><span class="p">],</span> <span class="n">yv</span><span class="o">=</span><span class="n">yy_mir</span><span class="p">[</span><span class="n">slc_mir</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">resd</span> <span class="o">=</span> <span class="n">diff</span>
                    <span class="n">E</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">fo</span><span class="p">[:</span><span class="mi">3</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="n">resd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">E_resd</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">resd</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
                <span class="k">elif</span> <span class="n">otype</span> <span class="o">==</span> <span class="s1">&#39;slopes_x&#39;</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cor_pitch</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="n">E</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span><span class="p">])</span>
                    <span class="n">E_resd</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">-</span> <span class="n">val</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">otype</span> <span class="o">==</span> <span class="s1">&#39;slopes_y&#39;</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cor_roll</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="n">E</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="n">E_resd</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">-</span> <span class="n">val</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">increment_progress</span><span class="p">(</span><span class="n">new_block</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">&lt;</span><span class="n">cnt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">increment_progress</span><span class="p">(</span><span class="n">prog_block</span> <span class="o">*</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="p">(</span><span class="n">cnt</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">))</span><span class="o">/</span><span class="n">cnt</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sdiff</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">E_resd</span><span class="p">,</span> <span class="n">validPatches</span><span class="p">,</span> <span class="n">slc_i</span><span class="p">,</span> <span class="n">slc_j</span></div>


<span class="c1">############################################</span>
<span class="c1"># Correct and join</span>
<div class="viewcode-block" id="correctAndJoin"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_stitching.correctAndJoin">[docs]</a><span class="k">def</span> <span class="nf">correctAndJoin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">sarr</span><span class="p">,</span> <span class="n">pix_size</span><span class="p">,</span> <span class="n">res_item</span><span class="p">,</span> <span class="n">res_intensity</span><span class="p">,</span> <span class="n">otype</span><span class="p">,</span> <span class="n">mX</span><span class="p">,</span> <span class="n">mY</span><span class="p">,</span> <span class="n">C_ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref_scale</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">prog_block</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply corrections and join the subapertures</span>

<span class="sd">    :param c: Correctors</span>
<span class="sd">    :param sarr: Subaperture array</span>
<span class="sd">    :param otype: Data type - slope/height</span>
<span class="sd">    :param oXArr: Translation offset array</span>
<span class="sd">    :return: Stitched image</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scan_item_cor</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">sarr</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">sarr</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">mask_mir</span>            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">res_item</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">xx</span><span class="p">,</span><span class="n">yy</span>               <span class="o">=</span> <span class="n">getXYGrid</span><span class="p">(</span><span class="n">mask_mir</span><span class="p">,</span> <span class="n">pix_size</span><span class="o">=</span><span class="n">pix_size</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask_mir</span><span class="p">)</span>
    <span class="n">nPat</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nx</span>          <span class="o">=</span> <span class="n">sarr</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ref_ext</span>             <span class="o">=</span> <span class="kc">None</span>

    <span class="n">f_ref</span> <span class="o">=</span> <span class="mf">0.3</span>
    <span class="n">f</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">f_ref</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cor_reference_extract</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">corRef</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cor_reference_extract</span><span class="p">:</span>
        <span class="n">xvRef</span><span class="p">,</span> <span class="n">yvRef</span>        <span class="o">=</span> <span class="n">getXYGrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">sarr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">),</span> <span class="n">pix_size</span><span class="o">=</span><span class="n">pix_size</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_extract_type</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="n">ref_ext</span> <span class="o">=</span> <span class="n">corRef</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">C_ref</span><span class="p">,</span> <span class="n">xvRef</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ref_ext</span> <span class="o">=</span> <span class="n">corRef</span>    <span class="o">=</span> <span class="n">getCorrectionReference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">C_ref</span><span class="p">,</span> <span class="n">xvRef</span><span class="o">/</span><span class="n">ref_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yvRef</span><span class="o">/</span><span class="n">ref_scale</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">increment_progress</span><span class="p">(</span><span class="n">prog_block</span> <span class="o">*</span> <span class="n">f_ref</span><span class="p">)</span>
    <span class="n">new_block</span> <span class="o">=</span> <span class="n">prog_block</span> <span class="o">*</span> <span class="n">f</span> <span class="o">*</span> <span class="mi">1</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">sarr</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sarr</span><span class="p">):</span>
        <span class="n">ox</span>                  <span class="o">=</span> <span class="n">mX</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">oy</span>                  <span class="o">=</span> <span class="n">mY</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">slc</span>                 <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">oy</span><span class="p">,</span> <span class="n">oy</span><span class="o">+</span><span class="n">ny</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="n">ox</span><span class="p">,</span> <span class="n">ox</span><span class="o">+</span><span class="n">nx</span><span class="p">))</span>
        <span class="n">cor</span>                 <span class="o">=</span> <span class="n">getCorrectionMap</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">j</span><span class="p">,:],</span> <span class="n">otype</span><span class="p">,</span> <span class="n">xx</span><span class="p">[</span><span class="n">slc</span><span class="p">],</span> <span class="n">yy</span><span class="p">[</span><span class="n">slc</span><span class="p">])</span>
        <span class="n">temp</span>                <span class="o">=</span> <span class="n">sarr</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">cor</span> <span class="o">+</span> <span class="n">corRef</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_threshold</span> <span class="o">==</span> <span class="s1">&#39;post_process&#39;</span><span class="p">:</span>
            <span class="n">temp</span>            <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maskByThreshold</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">sarr</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
        <span class="n">res_item</span><span class="p">[</span><span class="n">slc</span><span class="p">]</span>       <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">res_item</span><span class="p">[</span><span class="n">slc</span><span class="p">],</span> <span class="n">temp</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">res_intensity</span><span class="p">[</span><span class="n">slc</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">([</span><span class="n">res_intensity</span><span class="p">[</span><span class="n">slc</span><span class="p">],</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">temp</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">scan_item_cor</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>    <span class="o">=</span> <span class="n">temp</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">showPlots</span><span class="p">:</span>
            <span class="n">data</span>            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">res_item</span><span class="p">,</span> <span class="n">res_intensity</span><span class="p">)</span>
            <span class="n">plotSt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Stitched profile : &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">pauseTime</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">increment_progress</span><span class="p">(</span><span class="n">new_block</span><span class="p">)</span>

    <span class="n">sf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">res_item</span><span class="p">,</span> <span class="n">res_intensity</span><span class="p">)</span>
    <span class="n">err_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_algorithm_error</span><span class="p">(</span><span class="n">mX</span><span class="p">,</span> <span class="n">mY</span><span class="p">,</span> <span class="n">scan_item_cor</span><span class="p">,</span> <span class="n">sf</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">err_val</span><span class="p">,</span> <span class="n">sf</span><span class="p">,</span> <span class="n">scan_item_cor</span><span class="p">,</span> <span class="n">ref_ext</span></div>

<div class="viewcode-block" id="getCorrectionMap"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_stitching.getCorrectionMap">[docs]</a><span class="k">def</span> <span class="nf">getCorrectionMap</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">otype</span><span class="p">,</span> <span class="n">xx_j</span><span class="p">,</span> <span class="n">yy_j</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get correcion map for j&#39;th subaperture</span>

<span class="sd">    :param c: jth corrector</span>
<span class="sd">    :param xx_j: X-grid postions</span>
<span class="sd">    :param yy_j: Y-grid postions</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">otype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">,</span> <span class="s1">&#39;slopes_y&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">otype</span> <span class="o">==</span> <span class="s1">&#39;height&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">yy_j</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">xx_j</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span></div>


<span class="c1">##########################################</span>
<span class="c1">## Correction reference</span>
<span class="kn">from</span> <span class="nn">numpy.polynomial.legendre</span> <span class="kn">import</span> <span class="n">legvander2d</span><span class="p">,</span> <span class="n">legval2d</span>
<span class="kn">from</span> <span class="nn">PyLOSt.algorithms.util.util_poly</span> <span class="kn">import</span> <span class="n">zernike_xy</span>
<div class="viewcode-block" id="getCorrectionReference"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_stitching.getCorrectionReference">[docs]</a><span class="k">def</span> <span class="nf">getCorrectionReference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c_ref</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_extract_type</span><span class="o">==</span><span class="s1">&#39;poly&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">getCorrectionReferencePoly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c_ref</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_extract_type</span><span class="o">==</span><span class="s1">&#39;legendre&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">getCorrectionReferenceLegendre</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c_ref</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_extract_type</span><span class="o">==</span><span class="s1">&#39;zernike&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">getCorrectionReferenceZernike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c_ref</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">)</span></div>

<div class="viewcode-block" id="getCorrectionReferenceZernike"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_stitching.getCorrectionReferenceZernike">[docs]</a><span class="k">def</span> <span class="nf">getCorrectionReferenceZernike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c_ref</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">):</span>
    <span class="n">enDeg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_deg</span>
    <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">corRef</span> <span class="o">=</span> <span class="n">zernike_xy</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="n">enDeg</span><span class="p">,</span> <span class="n">coef</span><span class="o">=</span><span class="n">c_ref</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">corRef</span></div>

<div class="viewcode-block" id="getCorrectionReferenceLegendre"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_stitching.getCorrectionReferenceLegendre">[docs]</a><span class="k">def</span> <span class="nf">getCorrectionReferenceLegendre</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c_ref</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">):</span>
    <span class="c1"># nbStartTerms = nbTermsLegendre2D(startDeg-1)</span>
    <span class="c1"># if nbStartTerms &gt; 0: c_ref[0:nbStartTerms] = 0</span>
    <span class="n">corRef</span> <span class="o">=</span> <span class="n">legval2d</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">c_ref</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">corRef</span></div>

<div class="viewcode-block" id="getCorrectionReferencePoly"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_stitching.getCorrectionReferencePoly">[docs]</a><span class="k">def</span> <span class="nf">getCorrectionReferencePoly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c_ref</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    :param c_ref: reference coefficients♦</span>
<span class="sd">    :param xx: reference x grid</span>
<span class="sd">    :param yy: reference y grid</span>
<span class="sd">    :return: reference map</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">corRef</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">enDeg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_deg</span>
    <span class="n">stDeg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_deg</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">stDeg</span><span class="p">,</span> <span class="n">enDeg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">corRef</span> <span class="o">=</span> <span class="n">corRef</span> <span class="o">+</span> <span class="n">c_ref</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">xx</span> <span class="o">**</span> <span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">yy</span> <span class="o">**</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">k</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">corRef</span></div>


<div class="viewcode-block" id="plotSt"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_stitching.plotSt">[docs]</a><span class="k">def</span> <span class="nf">plotSt</span><span class="p">(</span><span class="n">a3</span><span class="p">,</span><span class="n">oxArr</span><span class="o">=</span><span class="p">[],</span> <span class="n">pnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;tilte&#39;</span><span class="p">,</span> <span class="n">pauseTime</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">szPat</span> <span class="o">=</span> <span class="n">a3</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">pnum</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a3</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">oxArr</span><span class="p">):</span>
                <span class="n">res_szX</span> <span class="o">=</span> <span class="n">szPat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">oxArr</span><span class="p">)</span>
                <span class="n">res_szY</span> <span class="o">=</span> <span class="n">szPat</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">();</span> <span class="n">axes</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">res_szX</span><span class="p">])</span>
                <span class="c1"># hold(True)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ox</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">oxArr</span><span class="p">):</span>
                    <span class="n">imshow</span><span class="p">(</span><span class="n">a3</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">ox</span><span class="p">,</span><span class="n">ox</span><span class="o">+</span><span class="n">szPat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="n">szPat</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]],</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.1</span> <span class="k">if</span> <span class="n">pauseTime</span><span class="o">&lt;=</span><span class="mi">0</span> <span class="k">else</span> <span class="n">pauseTime</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">a3</span><span class="p">:</span>
                    <span class="n">imshow</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.1</span> <span class="k">if</span> <span class="n">pauseTime</span><span class="o">&lt;=</span><span class="mi">0</span> <span class="k">else</span> <span class="n">pauseTime</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">a3</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">imshow</span><span class="p">(</span><span class="n">a3</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">a3</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">plot</span><span class="p">(</span><span class="n">a3</span><span class="p">)</span>
        <span class="c1"># plt.show()</span>
        <span class="k">if</span> <span class="n">pauseTime</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">pauseTime</span><span class="p">)</span>
            <span class="c1"># plt.close()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;plotSt &lt;- util_functions&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>


<div class="viewcode-block" id="binData"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_stitching.binData">[docs]</a><span class="k">def</span> <span class="nf">binData</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">binX</span><span class="p">,</span> <span class="n">binY</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bin data</span>

<span class="sd">    :param arr: Input data</span>
<span class="sd">    :param binX: Bin size along X</span>
<span class="sd">    :param binY: Bin size along Y</span>
<span class="sd">    :return: Binned data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">retArr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">dj</span> <span class="o">=</span> <span class="n">bin2DData</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">binX</span><span class="p">,</span> <span class="n">binY</span><span class="p">)</span>
            <span class="n">sdj</span> <span class="o">=</span> <span class="n">dj</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">retArr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">retArr</span><span class="p">,</span> <span class="n">dj</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">sdj</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">sdj</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">retArr</span><span class="p">)</span> <span class="k">else</span> <span class="n">dj</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">sdj</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">sdj</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">retArr</span> <span class="o">=</span> <span class="n">bin2DData</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">binX</span><span class="p">,</span> <span class="n">binY</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">retArr</span></div>


<div class="viewcode-block" id="bin2DData"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_stitching.bin2DData">[docs]</a><span class="k">def</span> <span class="nf">bin2DData</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">binX</span><span class="p">,</span> <span class="n">binY</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bin 2D data</span>

<span class="sd">    :param data:</span>
<span class="sd">    :param binX:</span>
<span class="sd">    :param binY:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sz</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">m_bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">binY</span><span class="p">)</span>
    <span class="n">n_bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">binX</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">m_bins</span><span class="o">*</span><span class="n">binY</span><span class="p">,</span> <span class="p">:</span><span class="n">n_bins</span><span class="o">*</span><span class="n">binX</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">m_bins</span><span class="p">,</span> <span class="n">binY</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">,</span> <span class="n">binX</span><span class="p">),</span><span class="mi">3</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">PyLOSt</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../PyLOSt.html">PyLOSt package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quick_guide.html">Quick Guide</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>