
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PyLOSt.algorithms.util.util_fit &#8212; PyLOSt  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/alabaster.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for PyLOSt.algorithms.util.util_fit</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>

<span class="kn">from</span> <span class="nn">PyLOSt.algorithms.util.util_math</span> <span class="kn">import</span> <span class="n">pv</span><span class="p">,</span> <span class="n">nbTermsPoly</span>
<span class="kn">from</span> <span class="nn">PyLOSt.algorithms.util.util_poly</span> <span class="kn">import</span> <span class="n">legendre_xy</span><span class="p">,</span> <span class="n">zernike_xy</span>


<div class="viewcode-block" id="fit1D"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_fit.fit1D">[docs]</a><span class="k">def</span> <span class="nf">fit1D</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span>  <span class="n">pix_size</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;LS&#39;</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">start_degree</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="s1">&#39;poly&#39;</span><span class="p">,</span> <span class="n">dtyp</span><span class="o">=</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="n">filter_terms_poly</span><span class="o">=</span><span class="p">[],</span>
          <span class="n">elp_params</span><span class="o">=</span><span class="p">[],</span> <span class="n">retResd</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit a polynomial to 1D data</span>

<span class="sd">    :param Z: 1D data</span>
<span class="sd">    :param pix_size: Pixel size in mm</span>
<span class="sd">    :param mask: Data mask</span>
<span class="sd">    :param method: Fit method</span>
<span class="sd">    :param degree: Polynomial degree</span>
<span class="sd">    :return: Coefficients, residuals</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">degree</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[],</span> <span class="n">Z</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">flatten</span><span class="p">()),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
    <span class="n">pix_size</span> <span class="o">=</span> <span class="n">getPixSz2D</span><span class="p">(</span><span class="n">pix_size</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">Zfit</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
    <span class="n">nx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nx</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">pix_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">xf</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">Zf</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">typ</span><span class="o">==</span><span class="s1">&#39;ellipse&#39;</span><span class="p">:</span> <span class="c1"># Tangential ellipse only</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elp_params</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">elp_params_check</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;elp_params_check&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;elp_params_check&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">x0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">=</span> <span class="n">calc_center_1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
            <span class="n">xf</span> <span class="o">=</span> <span class="n">xf</span><span class="o">-</span><span class="n">x0</span>
            <span class="n">Zf</span> <span class="o">=</span> <span class="n">Zf</span><span class="o">-</span><span class="n">z0</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sel_script&#39;</span><span class="p">,</span> <span class="s1">&#39;EllipsePylost&#39;</span><span class="p">)</span><span class="o">!=</span><span class="s1">&#39;EllipsePylost&#39;</span><span class="p">:</span>
                <span class="bp">cls</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sel_script_class&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">Zscale</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Zscale&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">pix_scale</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pix_scale&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">elp_params</span><span class="p">,</span> <span class="n">elp_params_check</span><span class="p">)</span>
                    <span class="n">C</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dtyp</span><span class="p">,</span> <span class="n">Zf</span><span class="o">*</span><span class="n">Zscale</span><span class="p">,</span> <span class="n">xf</span><span class="o">*</span><span class="n">pix_scale</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">retResd</span><span class="p">:</span> <span class="n">Zfit</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_ellipse</span><span class="p">(</span><span class="n">dtyp</span><span class="p">,</span> <span class="n">x</span><span class="o">*</span><span class="n">pix_scale</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">C</span><span class="p">)</span>
                    <span class="c1"># Rescale items</span>
                    <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mf">1e3</span> <span class="c1"># theta in mrad</span>
                    <span class="n">C</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="mf">1e3</span> <span class="c1"># center_offset in mm</span>
                    <span class="n">C</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="mf">1e3</span> <span class="c1"># rotate in mrad</span>
                    <span class="n">C</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="mf">1e9</span> <span class="c1"># piston in nm</span>
                    <span class="n">Zfit</span> <span class="o">=</span> <span class="n">Zfit</span><span class="o">/</span><span class="n">Zscale</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">err_func</span><span class="p">,</span> <span class="n">fn_filt</span> <span class="o">=</span> <span class="n">filter_func</span><span class="p">(</span><span class="n">elp_params_check</span><span class="p">,</span> <span class="n">dtyp</span><span class="p">,</span> <span class="n">ftyp</span><span class="o">=</span><span class="s1">&#39;ellipse&#39;</span><span class="p">,</span> <span class="n">elp_params</span><span class="o">=</span><span class="n">elp_params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                <span class="c1"># C, _ = curve_fit(err_func, (fn_filt, xf), Zf, p0=elp_params)</span>
                <span class="n">Cf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elp_params</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elp_params_check</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)]</span>
                <span class="n">Cnf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elp_params</span><span class="p">)[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elp_params_check</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)]</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">least_squares</span><span class="p">(</span><span class="n">err_func</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">Cf</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">Cnf</span><span class="p">,</span> <span class="n">xf</span><span class="p">,</span> <span class="n">Zf</span><span class="p">,</span> <span class="n">fn_filt</span><span class="p">),</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">ftol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span> <span class="n">gtol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">)</span>
                <span class="n">C</span> <span class="o">=</span> <span class="n">get_C</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">Cnf</span><span class="p">,</span> <span class="n">elp_params_check</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">retResd</span><span class="p">:</span>
                    <span class="n">Zfit</span> <span class="o">=</span> <span class="n">fn_filt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">C</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># polynomial by default</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">filter_terms_poly</span><span class="p">):</span>
            <span class="n">degree</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">matPoly</span><span class="p">(</span><span class="n">xf</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">degree</span><span class="p">,</span> <span class="n">start_degree</span><span class="p">,</span> <span class="n">nbVar</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">terms</span><span class="o">=</span><span class="n">filter_terms_poly</span><span class="p">,</span> <span class="n">dtyp</span><span class="o">=</span><span class="n">dtyp</span><span class="p">)</span>
        <span class="n">C</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Zf</span><span class="p">)</span>  <span class="c1"># coefficients C[0] + C[1]*X + C[2]*X2</span>
        <span class="k">if</span> <span class="n">retResd</span><span class="p">:</span>
            <span class="n">Zfit</span> <span class="o">=</span> <span class="n">evalPoly</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">degree</span><span class="p">,</span> <span class="n">start_degree</span><span class="p">,</span> <span class="n">nbVar</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">terms</span><span class="o">=</span><span class="n">filter_terms_poly</span><span class="p">,</span> <span class="n">dtyp</span><span class="o">=</span><span class="n">dtyp</span><span class="p">)</span>

    <span class="n">resd</span> <span class="o">=</span> <span class="n">Z</span> <span class="o">-</span> <span class="n">Zfit</span> <span class="k">if</span> <span class="n">retResd</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">C</span><span class="p">,</span> <span class="n">resd</span><span class="p">,</span> <span class="n">Zfit</span></div>

<div class="viewcode-block" id="fit_nD"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_fit.fit_nD">[docs]</a><span class="k">def</span> <span class="nf">fit_nD</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    :param Z:</span>
<span class="sd">    :param kwargs:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dim_detector</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dim_detector&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;dim_detector&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">axis_vals</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;axis_vals&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;axis_vals&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="p">[[]]</span><span class="o">*</span><span class="n">Z</span><span class="o">.</span><span class="n">ndim</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">dim_detector</span><span class="p">)</span> <span class="ow">and</span> <span class="kc">False</span> <span class="ow">in</span> <span class="n">dim_detector</span><span class="p">:</span>  <span class="c1">#Apply fit for selected detector dimensions.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim_detector</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>  <span class="c1">#only 1D or 2D</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="kc">None</span>
        <span class="n">shp_nondetctr</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">dim_detector</span><span class="p">)])</span>
        <span class="n">Zn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">Coeff_nD</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">Zn_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">idx_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="n">Z</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndindex</span><span class="p">(</span><span class="n">shp_nondetctr</span><span class="p">):</span>
            <span class="n">idx_full</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">dim_detector</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim_detector</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="c1">#2D surfaces</span>
                <span class="n">xv</span><span class="p">,</span><span class="n">yv</span> <span class="o">=</span> <span class="n">getGrid</span><span class="p">(</span><span class="n">axis_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">fit2D</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">idx_full</span><span class="p">)],</span> <span class="n">xv</span><span class="o">=</span><span class="n">xv</span><span class="p">,</span> <span class="n">yv</span><span class="o">=</span><span class="n">yv</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">#1D lines</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">fit1D</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">idx_full</span><span class="p">)],</span> <span class="n">x</span> <span class="o">=</span> <span class="n">axis_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Coeff_nD</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">Coeff_nD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shp_nondetctr</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">Coeff_nD</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">Zn</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">idx_full</span><span class="p">)],</span> <span class="n">Zn_fit</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">idx_full</span><span class="p">)]</span> <span class="o">=</span> <span class="n">output</span>

        <span class="k">return</span> <span class="n">Coeff_nD</span><span class="p">,</span> <span class="n">Zn</span><span class="p">,</span> <span class="n">Zn_fit</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Z</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fit1D</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">axis_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">Z</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">xv</span><span class="p">,</span><span class="n">yv</span> <span class="o">=</span> <span class="n">getGrid</span><span class="p">(</span><span class="n">axis_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">fit2D</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">xv</span><span class="o">=</span><span class="n">xv</span><span class="p">,</span> <span class="n">yv</span><span class="o">=</span><span class="n">yv</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Zn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">Coeff_nD</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">Zn_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndindex</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">xv</span><span class="p">,</span><span class="n">yv</span> <span class="o">=</span> <span class="n">getGrid</span><span class="p">(</span><span class="n">axis_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">fit2D</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">xv</span><span class="o">=</span><span class="n">xv</span><span class="p">,</span> <span class="n">yv</span><span class="o">=</span><span class="n">yv</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">Coeff_nD</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">Coeff_nD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">Coeff_nD</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">Zn</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">Zn_fit</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span>

            <span class="k">return</span> <span class="n">Coeff_nD</span><span class="p">,</span> <span class="n">Zn</span><span class="p">,</span> <span class="n">Zn_fit</span></div>


<div class="viewcode-block" id="getGrid"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_fit.getGrid">[docs]</a><span class="k">def</span> <span class="nf">getGrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">y</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">x</span><span class="p">))</span></div>


<div class="viewcode-block" id="fit2D"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_fit.fit2D">[docs]</a><span class="k">def</span> <span class="nf">fit2D</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">pix_size</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;LS&#39;</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">start_degree</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">retResd</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">useMaskForXY</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
          <span class="n">typ</span><span class="o">=</span><span class="s1">&#39;poly&#39;</span><span class="p">,</span> <span class="n">dtyp</span><span class="o">=</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="n">filter_terms_poly</span><span class="o">=</span><span class="p">[],</span> <span class="n">elp_params</span><span class="o">=</span><span class="p">[],</span> <span class="n">xv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit a polynomial to 2D data</span>

<span class="sd">    :param Z: Input data</span>
<span class="sd">    :param pix_size:  Pixel size</span>
<span class="sd">    :param mask: Data mask</span>
<span class="sd">    :param method: Fitting method e.g. least squares</span>
<span class="sd">    :param degree: Polynomial degree</span>
<span class="sd">    :param start_degree: Ignore polynomial coefficients below degree</span>
<span class="sd">    :param retResd: Flag return residuals</span>
<span class="sd">    :param useMaskForXY: Flag use a given mask or use mask on full data</span>
<span class="sd">    :param typ: Fit type e.g. polynomial, legendre etc...</span>
<span class="sd">    :param xv: X-grid positions</span>
<span class="sd">    :param yv: Y-grid positions</span>
<span class="sd">    :return: Fit coefficients, residuals</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">more_opts</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;more_opts&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">if</span> <span class="n">degree</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">C</span><span class="p">]),</span> <span class="n">Z</span><span class="o">-</span><span class="n">C</span><span class="p">,</span> <span class="n">C</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">xv</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">yv</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">useMaskForXY</span><span class="p">:</span>
            <span class="n">xv</span><span class="p">,</span> <span class="n">yv</span> <span class="o">=</span> <span class="n">getXYGrid</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">pix_size</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xv</span><span class="p">,</span> <span class="n">yv</span> <span class="o">=</span> <span class="n">getXYGrid</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">pix_size</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>

    <span class="n">Zvf</span> <span class="o">=</span> <span class="n">Z</span>
    <span class="n">xvf</span> <span class="o">=</span> <span class="n">xv</span>
    <span class="n">yvf</span> <span class="o">=</span> <span class="n">yv</span>
    <span class="k">if</span> <span class="s1">&#39;bin_fit&#39;</span> <span class="ow">in</span> <span class="n">more_opts</span> <span class="ow">and</span> <span class="n">more_opts</span><span class="p">[</span><span class="s1">&#39;bin_fit&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">more_opts</span><span class="p">[</span><span class="s1">&#39;bin_x&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">more_opts</span><span class="p">[</span><span class="s1">&#39;bin_y&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">xvf</span> <span class="o">=</span> <span class="n">xv</span><span class="p">[::</span><span class="n">more_opts</span><span class="p">[</span><span class="s1">&#39;bin_y&#39;</span><span class="p">],</span> <span class="p">::</span><span class="n">more_opts</span><span class="p">[</span><span class="s1">&#39;bin_x&#39;</span><span class="p">]]</span>
            <span class="n">yvf</span> <span class="o">=</span> <span class="n">yv</span><span class="p">[::</span><span class="n">more_opts</span><span class="p">[</span><span class="s1">&#39;bin_y&#39;</span><span class="p">],</span> <span class="p">::</span><span class="n">more_opts</span><span class="p">[</span><span class="s1">&#39;bin_x&#39;</span><span class="p">]]</span>
            <span class="n">Zvf</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[::</span><span class="n">more_opts</span><span class="p">[</span><span class="s1">&#39;bin_y&#39;</span><span class="p">],</span> <span class="p">::</span><span class="n">more_opts</span><span class="p">[</span><span class="s1">&#39;bin_x&#39;</span><span class="p">]]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[::</span><span class="n">more_opts</span><span class="p">[</span><span class="s1">&#39;bin_y&#39;</span><span class="p">],</span> <span class="p">::</span><span class="n">more_opts</span><span class="p">[</span><span class="s1">&#39;bin_x&#39;</span><span class="p">]]</span>

    <span class="n">xf</span> <span class="o">=</span> <span class="n">xvf</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">yf</span> <span class="o">=</span> <span class="n">yvf</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">Zf</span> <span class="o">=</span> <span class="n">Zvf</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="k">if</span> <span class="s1">&#39;center_data&#39;</span> <span class="ow">in</span> <span class="n">more_opts</span> <span class="ow">and</span> <span class="n">more_opts</span><span class="p">[</span><span class="s1">&#39;center_data&#39;</span><span class="p">]:</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">=</span> <span class="n">calc_center_2d</span><span class="p">(</span><span class="n">xvf</span><span class="p">,</span> <span class="n">yvf</span><span class="p">,</span> <span class="n">Zvf</span><span class="p">)</span>
        <span class="n">xf</span> <span class="o">=</span> <span class="n">xf</span> <span class="o">-</span> <span class="n">x0</span>
        <span class="n">Zf</span> <span class="o">=</span> <span class="n">Zf</span> <span class="o">-</span> <span class="n">z0</span>
    <span class="k">if</span> <span class="s1">&#39;rescale&#39;</span> <span class="ow">in</span> <span class="n">more_opts</span> <span class="ow">and</span> <span class="n">more_opts</span><span class="p">[</span><span class="s1">&#39;rescale&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;rescale_type&#39;</span> <span class="ow">in</span> <span class="n">more_opts</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">more_opts</span><span class="p">[</span><span class="s1">&#39;rescale_type&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c1">#Auto scale</span>
            <span class="n">rxy</span> <span class="o">=</span> <span class="n">pv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">xf</span><span class="p">,</span> <span class="n">yf</span><span class="p">]))</span>
            <span class="n">rz</span> <span class="o">=</span> <span class="n">pv</span><span class="p">(</span><span class="n">Zf</span><span class="p">)</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">rxy</span><span class="o">/</span><span class="n">rz</span>
            <span class="n">Zf</span> <span class="o">=</span> <span class="n">Zf</span><span class="o">*</span><span class="n">scale</span>

    <span class="n">A</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">Zfit</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">C</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">typ</span><span class="o">==</span><span class="s1">&#39;ellipse&#39;</span><span class="p">:</span> <span class="c1"># Tangential ellipse only</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elp_params</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">elp_params_check</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;elp_params_check&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;elp_params_check&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sel_script&#39;</span><span class="p">,</span> <span class="s1">&#39;EllipsePylost&#39;</span><span class="p">)</span><span class="o">!=</span><span class="s1">&#39;EllipsePylost&#39;</span><span class="p">:</span>
                <span class="bp">cls</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sel_script_class&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">Zscale</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Zscale&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">pix_scale</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pix_scale&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="n">elp_params_check</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">more_opts</span><span class="p">[</span><span class="s1">&#39;ellipse_rotation&#39;</span><span class="p">]</span> <span class="c1"># workaround to pass auto rotation option</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">elp_params</span><span class="p">,</span> <span class="n">elp_params_check</span><span class="p">)</span>
                    <span class="n">xo</span> <span class="o">=</span> <span class="n">xvf</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">xvf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="p">:]</span><span class="o">*</span><span class="n">pix_scale</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">yo</span> <span class="o">=</span> <span class="n">yvf</span><span class="p">[:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">yvf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)]</span><span class="o">*</span><span class="n">pix_scale</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">zo</span> <span class="o">=</span> <span class="n">Zvf</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">Zscale</span>
                    <span class="n">C</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">BA</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dtyp</span><span class="p">,</span> <span class="n">zo</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">Z</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="c1"># workaround to get the rotated data from external script (shape can change!)</span>
                    <span class="n">xv</span><span class="p">,</span> <span class="n">yv</span> <span class="o">=</span> <span class="n">getXYGrid</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">pix_size</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">retResd</span><span class="p">:</span> <span class="n">Zfit</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_ellipse</span><span class="p">(</span><span class="n">dtyp</span><span class="p">,</span> <span class="n">xv</span><span class="o">*</span><span class="n">pix_scale</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">C</span><span class="p">)</span>
                    <span class="c1"># Rescale items</span>
                    <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mf">1e3</span> <span class="c1"># theta in mrad</span>
                    <span class="n">C</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="mf">1e3</span> <span class="c1"># center_offset in mm</span>
                    <span class="n">C</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="mf">1e3</span> <span class="c1"># tilt in mrad</span>
                    <span class="n">C</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="mf">1e9</span> <span class="c1"># piston in nm</span>
                    <span class="n">C</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span>   <span class="c1"># rotation in deg</span>
                    <span class="n">Zfit</span> <span class="o">=</span> <span class="n">Zfit</span><span class="o">/</span><span class="n">Zscale</span>
                    <span class="k">if</span> <span class="n">BA</span><span class="p">:</span>
                        <span class="n">Zfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">Zfit</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">=</span> <span class="n">calc_center_2d</span><span class="p">(</span><span class="n">xvf</span><span class="p">,</span> <span class="n">yvf</span><span class="p">,</span> <span class="n">Zvf</span><span class="p">)</span>
                <span class="n">xf</span> <span class="o">=</span> <span class="n">xf</span> <span class="o">-</span> <span class="n">x0</span>
                <span class="n">Zf</span> <span class="o">=</span> <span class="n">Zf</span> <span class="o">-</span> <span class="n">z0</span>
                <span class="n">err_func</span><span class="p">,</span> <span class="n">fn_filt</span> <span class="o">=</span> <span class="n">filter_func</span><span class="p">(</span><span class="n">elp_params_check</span><span class="p">,</span> <span class="n">dtyp</span><span class="p">,</span> <span class="n">ftyp</span><span class="o">=</span><span class="s1">&#39;ellipse&#39;</span><span class="p">,</span> <span class="n">elp_params</span><span class="o">=</span><span class="n">elp_params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="c1"># C, _ = curve_fit(err_func, (fn_filt, xf), Zf, p0=elp_params)</span>
                <span class="n">Cf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elp_params</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elp_params_check</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)]</span>
                <span class="n">Cnf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elp_params</span><span class="p">)[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elp_params_check</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)]</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">least_squares</span><span class="p">(</span><span class="n">err_func</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">Cf</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">Cnf</span><span class="p">,</span> <span class="n">xf</span><span class="p">,</span> <span class="n">Zf</span><span class="p">,</span> <span class="n">fn_filt</span><span class="p">),</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">ftol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span> <span class="n">gtol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">)</span>
                <span class="n">C</span> <span class="o">=</span> <span class="n">get_C</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">Cnf</span><span class="p">,</span> <span class="n">elp_params_check</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">retResd</span><span class="p">:</span> <span class="n">Zfit</span> <span class="o">=</span> <span class="n">fn_filt</span><span class="p">(</span><span class="n">xv</span><span class="p">,</span> <span class="o">*</span><span class="n">C</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">typ</span><span class="o">==</span><span class="s1">&#39;legendre&#39;</span><span class="p">:</span>
        <span class="n">A</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">legendre_xy</span><span class="p">(</span><span class="n">xf</span><span class="p">,</span> <span class="n">yf</span><span class="p">,</span> <span class="n">start_degree</span><span class="o">=</span><span class="n">start_degree</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="n">degree</span><span class="p">)</span>
        <span class="n">C</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Zf</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">retResd</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">Zfit</span> <span class="o">=</span> <span class="n">zernike_xy</span><span class="p">(</span><span class="n">xv</span><span class="p">,</span> <span class="n">yv</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="n">degree</span><span class="p">,</span> <span class="n">coef</span> <span class="o">=</span> <span class="n">C</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">typ</span><span class="o">==</span><span class="s1">&#39;zernike&#39;</span><span class="p">:</span>
        <span class="n">A</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">zernike_xy</span><span class="p">(</span><span class="n">xf</span><span class="p">,</span> <span class="n">yf</span><span class="p">,</span> <span class="n">start_degree</span><span class="o">=</span><span class="n">start_degree</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="n">degree</span><span class="p">)</span>
        <span class="n">C</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Zf</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">retResd</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">Zfit</span> <span class="o">=</span> <span class="n">zernike_xy</span><span class="p">(</span><span class="n">xv</span><span class="p">,</span> <span class="n">yv</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="n">degree</span><span class="p">,</span> <span class="n">coef</span> <span class="o">=</span> <span class="n">C</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># polynomial by default</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">filter_terms_poly</span><span class="p">):</span>
            <span class="n">degree</span><span class="o">=-</span><span class="mi">1</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">matPoly</span><span class="p">(</span><span class="n">xf</span><span class="p">,</span> <span class="n">yf</span><span class="p">,</span> <span class="n">degree</span><span class="p">,</span> <span class="n">start_degree</span><span class="p">,</span> <span class="n">nbVar</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">terms</span><span class="o">=</span><span class="n">filter_terms_poly</span><span class="p">,</span> <span class="n">dtyp</span><span class="o">=</span><span class="n">dtyp</span><span class="p">)</span>
        <span class="n">C</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Zf</span><span class="p">)</span>  <span class="c1"># coefficients C[0] + C[1]*Y + C[2]*X + C[3]*Y2+ C[4]*XY + C[5]*X2</span>
        <span class="k">if</span> <span class="n">retResd</span><span class="p">:</span> <span class="n">Zfit</span> <span class="o">=</span> <span class="n">evalPoly</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">xv</span><span class="p">,</span> <span class="n">yv</span><span class="p">,</span> <span class="n">degree</span><span class="p">,</span> <span class="n">start_degree</span><span class="p">,</span> <span class="n">nbVar</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">terms</span><span class="o">=</span><span class="n">filter_terms_poly</span><span class="p">,</span> <span class="n">dtyp</span><span class="o">=</span><span class="n">dtyp</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;rescale&#39;</span> <span class="ow">in</span> <span class="n">more_opts</span> <span class="ow">and</span> <span class="n">more_opts</span><span class="p">[</span><span class="s1">&#39;rescale&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;rescale_type&#39;</span> <span class="ow">in</span> <span class="n">more_opts</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">more_opts</span><span class="p">[</span><span class="s1">&#39;rescale_type&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c1">#Auto scale</span>
            <span class="n">Zfit</span> <span class="o">=</span> <span class="n">Zfit</span> <span class="o">/</span> <span class="n">scale</span>
    <span class="k">if</span> <span class="s1">&#39;center_data&#39;</span> <span class="ow">in</span> <span class="n">more_opts</span> <span class="ow">and</span> <span class="n">more_opts</span><span class="p">[</span><span class="s1">&#39;center_data&#39;</span><span class="p">]:</span>
        <span class="n">Zfit</span> <span class="o">=</span> <span class="n">Zfit</span> <span class="o">+</span> <span class="n">z0</span>
    <span class="n">resd</span> <span class="o">=</span> <span class="n">Z</span> <span class="o">-</span> <span class="n">Zfit</span> <span class="k">if</span> <span class="n">retResd</span> <span class="ow">and</span> <span class="p">(</span><span class="n">Zfit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">C</span><span class="p">,</span> <span class="n">resd</span><span class="p">,</span> <span class="n">Zfit</span></div>

<div class="viewcode-block" id="calc_center_2d"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_fit.calc_center_2d">[docs]</a><span class="k">def</span> <span class="nf">calc_center_2d</span><span class="p">(</span><span class="n">xvf</span><span class="p">,</span> <span class="n">yvf</span><span class="p">,</span> <span class="n">Zvf</span><span class="p">):</span>
    <span class="n">xo</span> <span class="o">=</span> <span class="n">xvf</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">xvf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="p">:]</span>
    <span class="n">yo</span> <span class="o">=</span> <span class="n">yvf</span><span class="p">[:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">yvf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)]</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">xo</span><span class="p">)</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">yo</span><span class="p">)</span>
    <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">xo</span><span class="o">-</span><span class="n">x0</span><span class="p">))</span>
    <span class="n">iy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">yo</span><span class="o">-</span><span class="n">y0</span><span class="p">))</span>
    <span class="n">z0</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp2d</span><span class="p">(</span><span class="n">xo</span><span class="p">[</span><span class="n">ix</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="n">ix</span><span class="o">+</span><span class="mi">4</span><span class="p">],</span> <span class="n">yo</span><span class="p">[</span><span class="n">iy</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="n">iy</span><span class="o">+</span><span class="mi">4</span><span class="p">],</span> <span class="n">Zvf</span><span class="p">[</span><span class="n">iy</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="n">iy</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="n">ix</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="n">ix</span><span class="o">+</span><span class="mi">4</span><span class="p">])(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span></div>

<div class="viewcode-block" id="calc_center_1d"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_fit.calc_center_1d">[docs]</a><span class="k">def</span> <span class="nf">calc_center_1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Z</span><span class="p">):</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">x0</span><span class="p">))</span>
    <span class="n">z0</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">ix</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="n">ix</span><span class="o">+</span><span class="mi">4</span><span class="p">],</span> <span class="n">Z</span><span class="p">[</span><span class="n">ix</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="n">ix</span><span class="o">+</span><span class="mi">4</span><span class="p">])(</span><span class="n">x0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x0</span><span class="p">,</span> <span class="n">z0</span></div>

<div class="viewcode-block" id="filter_func"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_fit.filter_func">[docs]</a><span class="k">def</span> <span class="nf">filter_func</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">dtyp</span><span class="p">,</span> <span class="n">ftyp</span><span class="o">=</span><span class="s1">&#39;poly&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ftyp</span><span class="o">==</span><span class="s1">&#39;poly&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dtyp</span> <span class="o">==</span> <span class="s1">&#39;height&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">lambda</span> <span class="n">xy</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">:</span> <span class="n">F</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">a</span> <span class="o">+</span> <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">F</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">c</span><span class="o">*</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">F</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">d</span><span class="o">*</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span> <span class="n">F</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">e</span><span class="o">*</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">F</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">f</span><span class="o">*</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">F</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">g</span><span class="o">*</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtyp</span><span class="o">==</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">lambda</span> <span class="n">xy</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">:</span>  <span class="n">F</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="n">F</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">e</span><span class="o">*</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">F</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">f</span><span class="o">*</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">dtyp</span><span class="o">==</span><span class="s1">&#39;slopes_y&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">lambda</span> <span class="n">xy</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">:</span>  <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">b</span> <span class="o">+</span> <span class="n">F</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">e</span><span class="o">*</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">F</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">d</span><span class="o">*</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">ftyp</span><span class="o">==</span><span class="s1">&#39;ellipse&#39;</span><span class="p">:</span>
        <span class="n">filter_items</span><span class="o">=</span><span class="n">F</span>
        <span class="n">elp_params_init</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;elp_params&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;elp_params&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span>
        <span class="n">Zscale</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;Zscale&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;Zscale&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">pix_scale</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pix_scale&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;pix_scale&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dtyp</span> <span class="o">==</span> <span class="s1">&#39;height&#39;</span><span class="p">:</span>
            <span class="n">hgt_scale</span> <span class="o">=</span> <span class="n">Zscale</span>
            <span class="n">slp_scale</span> <span class="o">=</span> <span class="n">Zscale</span><span class="o">/</span><span class="n">pix_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hgt_scale</span> <span class="o">=</span> <span class="n">Zscale</span><span class="o">*</span><span class="n">pix_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">slp_scale</span> <span class="o">=</span> <span class="n">Zscale</span>
        <span class="k">def</span> <span class="nf">elp_sfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">rotate</span><span class="p">,</span> <span class="n">piston</span><span class="p">):</span>
            <span class="n">theta_si</span> <span class="o">=</span> <span class="n">theta</span><span class="o">*</span><span class="mf">1e-3</span>
            <span class="n">center_si</span> <span class="o">=</span> <span class="n">center</span><span class="o">*</span><span class="mf">1e-3</span>
            <span class="n">rotate_si</span> <span class="o">=</span> <span class="n">rotate</span><span class="o">*</span><span class="mf">1e-3</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">pix_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">center_si</span>
            <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_si</span><span class="p">)</span>
            <span class="n">F</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">-</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">theta_si</span><span class="p">)))</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">F</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">-</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">theta_si</span><span class="p">)))</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">-</span><span class="n">theta_si</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">F</span> <span class="o">-</span> <span class="n">q</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
            <span class="c1"># y0 = -b*np.sqrt(1-(x0/a)**2)</span>

            <span class="n">sx_fit_fn</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="p">(</span>
                                                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">x0</span><span class="p">)</span><span class="o">/</span>
                                                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">x0</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">x0</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                                            <span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">mu</span><span class="p">)</span> <span class="o">+</span> <span class="n">rotate_si</span>
            <span class="n">sx_fit_fn</span> <span class="o">=</span> <span class="n">sx_fit_fn</span> <span class="o">/</span> <span class="n">slp_scale</span> <span class="c1">#*1e6</span>

            <span class="k">return</span> <span class="n">sx_fit_fn</span>

        <span class="k">def</span> <span class="nf">elp_hfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">rotate</span><span class="p">,</span> <span class="n">piston</span><span class="p">):</span>
            <span class="n">theta_si</span> <span class="o">=</span> <span class="n">theta</span><span class="o">*</span><span class="mf">1e-3</span>
            <span class="n">center_si</span> <span class="o">=</span> <span class="n">center</span><span class="o">*</span><span class="mf">1e-3</span>
            <span class="n">rotate_si</span> <span class="o">=</span> <span class="n">rotate</span><span class="o">*</span><span class="mf">1e-3</span>
            <span class="n">piston_si</span> <span class="o">=</span> <span class="n">piston</span><span class="o">*</span><span class="mf">1e-9</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">pix_scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">center_si</span>
            <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_si</span><span class="p">)</span>
            <span class="n">F</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">-</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">theta_si</span><span class="p">)))</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">F</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">-</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">theta_si</span><span class="p">)))</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">-</span> <span class="n">theta_si</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">F</span> <span class="o">-</span> <span class="n">q</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">x0</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">z1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">((</span><span class="n">x</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span><span class="o">+</span><span class="n">x0</span><span class="p">)</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="n">y0</span><span class="p">)</span>
            <span class="n">z2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">mu</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
            <span class="n">z3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y0</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">x0</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
            <span class="n">z_fit_fn</span> <span class="o">=</span> <span class="n">z1</span><span class="o">+</span><span class="n">z2</span><span class="o">+</span><span class="n">z3</span>

            <span class="c1"># rotate</span>
            <span class="k">if</span> <span class="n">rotate</span><span class="p">:</span>
                <span class="c1"># x        = x * np.cos(rotate_si) + z_fit_fn * np.sin(rotate_si)</span>
                <span class="n">z_fit_fn</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rotate_si</span><span class="p">)</span> <span class="o">+</span> <span class="n">z_fit_fn</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rotate_si</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">piston</span><span class="p">:</span>
                <span class="n">z_fit_fn</span> <span class="o">=</span> <span class="n">z_fit_fn</span> <span class="o">+</span> <span class="n">piston_si</span>

            <span class="n">z_fit_fn</span> <span class="o">=</span> <span class="n">z_fit_fn</span> <span class="o">/</span> <span class="n">hgt_scale</span> <span class="c1">#*1e9</span>

            <span class="k">return</span> <span class="n">z_fit_fn</span>

        <span class="k">def</span> <span class="nf">err_func_cfit</span><span class="p">(</span><span class="n">xf</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">rotate</span><span class="p">,</span> <span class="n">piston</span><span class="p">):</span>
            <span class="n">fn_filt</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">xf</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="k">if</span> <span class="n">filter_items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">elp_params_init</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="k">if</span> <span class="n">filter_items</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">elp_params_init</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span> <span class="k">if</span> <span class="n">filter_items</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">elp_params_init</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">center</span> <span class="k">if</span> <span class="n">filter_items</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">elp_params_init</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">rotate</span> <span class="o">=</span> <span class="n">rotate</span> <span class="k">if</span> <span class="n">filter_items</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">elp_params_init</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">piston</span> <span class="o">=</span> <span class="n">piston</span> <span class="k">if</span> <span class="n">filter_items</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">elp_params_init</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">fn_filt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">rotate</span><span class="p">,</span> <span class="n">piston</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">err_func</span><span class="p">(</span><span class="n">Cf</span><span class="p">,</span> <span class="n">Cnf</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">fn_filt</span><span class="p">):</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">get_C</span><span class="p">(</span><span class="n">Cf</span><span class="p">,</span> <span class="n">Cnf</span><span class="p">,</span> <span class="n">filter_items</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{:.7f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">C</span><span class="p">]))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">fn_filt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">C</span><span class="p">)</span> <span class="o">-</span> <span class="n">z</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">err</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">err</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">dtyp</span> <span class="o">==</span> <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">err_func</span><span class="p">,</span> <span class="n">elp_hfit</span>
        <span class="k">elif</span> <span class="n">dtyp</span> <span class="o">==</span> <span class="s1">&#39;slopes_x&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">err_func</span><span class="p">,</span> <span class="n">elp_sfit</span></div>

<div class="viewcode-block" id="get_C"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_fit.get_C">[docs]</a><span class="k">def</span> <span class="nf">get_C</span><span class="p">(</span><span class="n">Cf</span><span class="p">,</span> <span class="n">Cnf</span><span class="p">,</span> <span class="n">filter_items</span><span class="p">):</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">filter_items</span><span class="p">))</span>
    <span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">filter_items</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)]</span> <span class="o">=</span> <span class="n">Cf</span>
    <span class="n">C</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">filter_items</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)]</span> <span class="o">=</span> <span class="n">Cnf</span>
    <span class="k">return</span> <span class="n">C</span></div>

<div class="viewcode-block" id="matPoly"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_fit.matPoly">[docs]</a><span class="k">def</span> <span class="nf">matPoly</span><span class="p">(</span><span class="n">xf</span><span class="p">,</span> <span class="n">yf</span><span class="p">,</span> <span class="n">enDeg</span><span class="p">,</span> <span class="n">stDeg</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nbVar</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">terms</span><span class="o">=</span><span class="p">[],</span> <span class="n">dtyp</span><span class="o">=</span><span class="s1">&#39;height&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Expand IndexMatrix with polynomial terms</span>
<span class="sd">    # For filter of terms (bivariate)</span>
<span class="sd">    # Format C[0] + C[1]*Y + C[2]*X + C[3]*Y2+ C[4]*XY + C[5]*X2 + C[6]*(Y2+X2) for heights</span>
<span class="sd">    # Format C[2] + C[4]*Y + 2*C[5]*X for slopes x</span>
<span class="sd">    # Format C[1] + C[4]*X + 2*C[3]*Y for slopes y</span>

<span class="sd">    :param xf: X-position array</span>
<span class="sd">    :param yf: Y-position array</span>
<span class="sd">    :param enDeg: Polynomial degree</span>
<span class="sd">    :return: Expanded IndexMatrix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">A</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">terms</span>
    <span class="k">if</span> <span class="n">nbVar</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span> <span class="ow">and</span> <span class="n">enDeg</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xf</span><span class="p">),</span> <span class="mi">7</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dtyp</span> <span class="o">==</span> <span class="s1">&#39;height&#39;</span><span class="p">:</span>
                <span class="n">A</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span>
                <span class="n">A</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">yf</span>
                <span class="n">A</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">xf</span>
                <span class="n">A</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">yf</span><span class="o">**</span><span class="mi">2</span>
                <span class="n">A</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">xf</span><span class="o">*</span><span class="n">yf</span>
                <span class="n">A</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">xf</span><span class="o">**</span><span class="mi">2</span>
                <span class="n">A</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">xf</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">yf</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dtyp</span> <span class="o">==</span> <span class="s1">&#39;slopes_x&#39;</span><span class="p">:</span>
                <span class="n">A</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span>
                <span class="n">A</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">yf</span>
                <span class="n">A</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">xf</span>
            <span class="k">elif</span> <span class="n">dtyp</span> <span class="o">==</span> <span class="s1">&#39;slopes_y&#39;</span><span class="p">:</span>
                <span class="n">A</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span>
                <span class="n">A</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">yf</span>
                <span class="n">A</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">xf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="n">nbTermsPoly</span><span class="p">(</span><span class="n">stDeg</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">enDeg</span><span class="p">)</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xf</span><span class="p">),</span> <span class="n">cols</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">stDeg</span><span class="p">,</span> <span class="n">enDeg</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="c1"># b = np.reshape(xf**(k)*yf**(n-k),(len(xf),1))</span>
                    <span class="c1"># A = b if A is None else np.concatenate((A, b),axis=1)</span>
                    <span class="n">A</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xf</span><span class="o">**</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">yf</span><span class="o">**</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">k</span><span class="p">)</span>
                    <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="k">elif</span> <span class="n">nbVar</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span> <span class="ow">and</span> <span class="n">enDeg</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xf</span><span class="p">),</span> <span class="mi">7</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dtyp</span> <span class="o">==</span> <span class="s1">&#39;height&#39;</span><span class="p">:</span>
                <span class="n">A</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span>
                <span class="n">A</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">xf</span>
                <span class="n">A</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">xf</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">elif</span> <span class="n">dtyp</span> <span class="o">==</span> <span class="s1">&#39;slopes_x&#39;</span><span class="p">:</span>
                <span class="n">A</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span>
                <span class="n">A</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">xf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">stDeg</span><span class="p">,</span> <span class="n">enDeg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xf</span> <span class="o">**</span> <span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xf</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">xf</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">A</span></div>


<div class="viewcode-block" id="evalPoly"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_fit.evalPoly">[docs]</a><span class="k">def</span> <span class="nf">evalPoly</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">xv</span><span class="p">,</span> <span class="n">yv</span><span class="p">,</span> <span class="n">enDeg</span><span class="p">,</span> <span class="n">stDeg</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nbVar</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">terms</span><span class="o">=</span><span class="p">[],</span> <span class="n">dtyp</span><span class="o">=</span><span class="s1">&#39;height&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate 2D polynomial</span>

<span class="sd">    :param C: Coefficients of polynomial</span>
<span class="sd">    :param xv: X-position array</span>
<span class="sd">    :param yv: Y-position array</span>
<span class="sd">    :param degree: Polynomial degree</span>
<span class="sd">    :return: Evaluated data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Zfit</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">terms</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">C</span><span class="o">.</span><span class="n">ndim</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rollaxis</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nbVar</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">*</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">nbVar</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">*</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">nbVar</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span> <span class="ow">and</span> <span class="n">enDeg</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dtyp</span> <span class="o">==</span> <span class="s1">&#39;height&#39;</span><span class="p">:</span>
                <span class="n">Zfit</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span> <span class="o">+</span> <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">yv</span> <span class="o">+</span> <span class="n">F</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">xv</span> <span class="o">+</span> <span class="n">F</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">yv</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">F</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">xv</span><span class="o">*</span><span class="n">yv</span> <span class="o">+</span> <span class="n">F</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">xv</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">F</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">xv</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">yv</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dtyp</span> <span class="o">==</span> <span class="s1">&#39;slopes_x&#39;</span><span class="p">:</span>
                <span class="n">Zfit</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span> <span class="o">+</span> <span class="n">F</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">yv</span> <span class="o">+</span> <span class="n">F</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">xv</span>
            <span class="k">elif</span> <span class="n">dtyp</span> <span class="o">==</span> <span class="s1">&#39;slopes_y&#39;</span><span class="p">:</span>
                <span class="n">Zfit</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span> <span class="o">+</span> <span class="n">F</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">yv</span> <span class="o">+</span> <span class="n">F</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">xv</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">stDeg</span><span class="p">,</span> <span class="n">enDeg</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">xv</span><span class="o">**</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">yv</span><span class="o">**</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">Zfit</span> <span class="o">=</span> <span class="n">val</span> <span class="k">if</span> <span class="n">Zfit</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">Zfit</span> <span class="o">+</span> <span class="n">val</span>
                    <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="k">elif</span> <span class="n">nbVar</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span> <span class="ow">and</span> <span class="n">enDeg</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dtyp</span> <span class="o">==</span> <span class="s1">&#39;height&#39;</span><span class="p">:</span>
                <span class="n">Zfit</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span> <span class="o">+</span> <span class="n">F</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">xv</span> <span class="o">+</span> <span class="n">F</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">xv</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">elif</span> <span class="n">dtyp</span> <span class="o">==</span> <span class="s1">&#39;slopes_x&#39;</span><span class="p">:</span>
                <span class="n">Zfit</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span> <span class="o">+</span> <span class="n">F</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">xv</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">stDeg</span><span class="p">,</span> <span class="n">enDeg</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">Zfit</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">n</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="n">Zfit</span><span class="o">+</span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">xv</span><span class="o">**</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">Zfit</span></div>


<div class="viewcode-block" id="getXYGrid"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_fit.getXYGrid">[docs]</a><span class="k">def</span> <span class="nf">getXYGrid</span><span class="p">(</span><span class="n">oarr</span><span class="p">,</span> <span class="n">pix_size</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get XY grid of positions</span>

<span class="sd">    :param oarr: Input data</span>
<span class="sd">    :param pix_size: Pixel size</span>
<span class="sd">    :param order: Dimensions of input data</span>
<span class="sd">    :param mask: Input mask</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">oarr</span><span class="o">.</span><span class="n">ndim</span>
    <span class="n">pix_size</span> <span class="o">=</span> <span class="n">getPixSz2D</span><span class="p">(</span><span class="n">pix_size</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">order</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">patch_count</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nx</span>           <span class="o">=</span> <span class="n">oarr</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">mask</span>                        <span class="o">=</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="k">else</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">oarr</span><span class="p">)</span>
        <span class="n">xx</span>                          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">mask</span><span class="o">*</span><span class="mf">1.0</span>
        <span class="n">yy</span>                          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span><span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">mask</span><span class="o">*</span><span class="mf">1.0</span>
        <span class="n">xx</span><span class="p">[</span><span class="n">xx</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>                   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">yy</span><span class="p">[</span><span class="n">yy</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>                   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">xx</span>                          <span class="o">=</span> <span class="n">pix_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">xx</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">patch_count</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">yy</span>                          <span class="o">=</span> <span class="n">pix_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">yy</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">patch_count</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="c1"># xx                          = pix_size[0]*(xx - np.nanmean(xx,axis=-1).reshape(patch_count,ny,1))</span>
        <span class="c1"># yy                          = pix_size[1]*(yy - np.nanmean(yy,axis=-2).reshape(patch_count,1,nx))</span>
        <span class="k">return</span> <span class="n">xx</span><span class="p">,</span><span class="n">yy</span>
    <span class="k">elif</span> <span class="n">order</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">ny</span><span class="p">,</span><span class="n">nx</span>                       <span class="o">=</span> <span class="n">oarr</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">mask</span>                        <span class="o">=</span> <span class="n">mask</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="k">else</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">oarr</span><span class="p">)</span>
        <span class="n">xx</span>                          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">mask</span><span class="o">*</span><span class="mf">1.0</span>
        <span class="n">yy</span>                          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span><span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">mask</span><span class="o">*</span><span class="mf">1.0</span>
        <span class="n">xx</span><span class="p">[</span><span class="n">xx</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>                   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">yy</span><span class="p">[</span><span class="n">yy</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>                   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">xx</span>                          <span class="o">=</span> <span class="n">pix_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">xx</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
        <span class="n">yy</span>                          <span class="o">=</span> <span class="n">pix_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">yy</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
        <span class="c1"># xx                          = pix_size[0]*(xx - np.nanmean(xx,axis=-1).reshape(ny,1))</span>
        <span class="c1"># yy                          = pix_size[1]*(yy - np.nanmean(yy,axis=-2).reshape(1,nx))</span>
        <span class="k">return</span> <span class="n">xx</span><span class="p">,</span><span class="n">yy</span></div>


<div class="viewcode-block" id="getPixSz2D"><a class="viewcode-back" href="../../../../PyLOSt.algorithms.util.html#PyLOSt.algorithms.util.util_fit.getPixSz2D">[docs]</a><span class="k">def</span> <span class="nf">getPixSz2D</span><span class="p">(</span><span class="n">pix_size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if input is array, tuple or list and return pixel size in x and y</span>

<span class="sd">    :param pix_size: Pixel size in differnt formats</span>
<span class="sd">    :return: Pixel size XY array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pix_size</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">pix_size</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pix_size</span><span class="p">)</span><span class="o">!=</span><span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">pix_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pix_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pix_size</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">pix_size</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">pix_size</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">pix_size</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">pix_size</span><span class="p">,</span> <span class="n">pix_size</span><span class="p">]</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">PyLOSt</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../PyLOSt.html">PyLOSt package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quick_guide.html">Quick Guide</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>