
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PyLOSt.data_in.francois_esrf.generic &#8212; PyLOSt  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/alabaster.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for PyLOSt.data_in.francois_esrf.generic</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="sd">http://hplgit.github.io/primer.html/doc/pub/class/._class-solarized003.html</span>

<span class="sd">https://docs.python.org/3/glossary.html#term-bytecode</span>

<span class="sd">https://realpython.com/python-descriptors/</span>

<span class="sd">https://stackoverflow.com/questions/2278426/inner-classes-how-can-i-get-the-outer-class-object-at-construction-time</span>

<span class="sd">https://medium.com/@vadimpushtaev/decorator-inside-python-class-1e74d23107f6</span>

<span class="sd">https://docs.scipy.org/doc/scipy/reference/tutorial/interpolate.html#spline-interpolation</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># pylint: disable=C0103, C0115, C0116</span>
<span class="c1"># pylint: disable=C0415</span>
<span class="c1"># pylint: disable=R0902, R0903, R0904, R0913, R0914</span>


<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">perf_counter</span>

<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">numpy.polynomial.polynomial</span> <span class="kn">import</span> <span class="n">polyfit</span><span class="p">,</span> <span class="n">polyval</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span><span class="p">,</span> <span class="n">BSpline</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">simps</span><span class="p">,</span> <span class="n">romb</span>


<div class="viewcode-block" id="ProtoData"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ProtoData">[docs]</a><span class="k">class</span> <span class="nc">ProtoData</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coords</span><span class="p">):</span>
                <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># if isinstance(units, tuple):</span>
        <span class="c1">#     units = {&#39;coords&#39;: units[0], &#39;values&#39;: [1]}</span>
        <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">units</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;coords&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>

        <span class="n">initial</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;initial&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">initial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;initial&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">initial</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ellipse</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="c1"># ----properties----</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">coords_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_coords_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">values_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_values_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hasnan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>

    <span class="c1"># ----common functions----</span>
<div class="viewcode-block" id="ProtoData.duplicate"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ProtoData.duplicate">[docs]</a>    <span class="k">def</span> <span class="nf">duplicate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span></div>
<div class="viewcode-block" id="ProtoData.reload"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ProtoData.reload">[docs]</a>    <span class="k">def</span> <span class="nf">reload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">coords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">units</span></div>
<div class="viewcode-block" id="ProtoData.masking"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ProtoData.masking">[docs]</a>    <span class="k">def</span> <span class="nf">masking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rms</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">median</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold</span> <span class="c1"># or mean_removal ?</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span></div>

    <span class="c1"># ----units functions----</span>
<div class="viewcode-block" id="ProtoData.auto_units"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ProtoData.auto_units">[docs]</a>    <span class="k">def</span> <span class="nf">auto_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_coords_unit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_values_unit</span><span class="p">()</span></div>
<div class="viewcode-block" id="ProtoData.auto_coords_unit"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ProtoData.auto_coords_unit">[docs]</a>    <span class="k">def</span> <span class="nf">auto_coords_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">new_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_unit</span><span class="o">.</span><span class="n">auto</span><span class="p">(</span><span class="n">pv</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_coords_unit</span><span class="p">(</span><span class="n">new_unit</span><span class="p">)</span></div>
<div class="viewcode-block" id="ProtoData.auto_values_unit"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ProtoData.auto_values_unit">[docs]</a>    <span class="k">def</span> <span class="nf">auto_values_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">new_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_unit</span><span class="o">.</span><span class="n">auto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_values_unit</span><span class="p">(</span><span class="n">new_unit</span><span class="p">)</span></div>
<div class="viewcode-block" id="ProtoData.reset_units"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ProtoData.reset_units">[docs]</a>    <span class="k">def</span> <span class="nf">reset_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_coords_unit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_values_unit</span><span class="p">()</span></div>
<div class="viewcode-block" id="ProtoData.reset_coords_unit"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ProtoData.reset_coords_unit">[docs]</a>    <span class="k">def</span> <span class="nf">reset_coords_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_coords_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">coords_unit</span><span class="p">)</span></div>
<div class="viewcode-block" id="ProtoData.reset_values_unit"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ProtoData.reset_values_unit">[docs]</a>    <span class="k">def</span> <span class="nf">reset_values_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_values_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">values_unit</span><span class="p">)</span></div>
<div class="viewcode-block" id="ProtoData.change_defaults_units"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ProtoData.change_defaults_units">[docs]</a>    <span class="k">def</span> <span class="nf">change_defaults_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_units</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_units</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">new_units</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_units</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_units</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>
<div class="viewcode-block" id="ProtoData.change_units"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ProtoData.change_units">[docs]</a>    <span class="k">def</span> <span class="nf">change_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_units</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_units</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">change_coords_unit</span><span class="p">(</span><span class="n">new_units</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">change_values_unit</span><span class="p">(</span><span class="n">new_units</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">])</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_coords_unit</span><span class="p">(</span><span class="n">new_units</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_values_unit</span><span class="p">(</span><span class="n">new_units</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>
<div class="viewcode-block" id="ProtoData.change_coords_unit"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ProtoData.change_coords_unit">[docs]</a>    <span class="k">def</span> <span class="nf">change_coords_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_unit</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">new_unit</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_unit</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">new_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_unit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_unit</span></div>
<div class="viewcode-block" id="ProtoData.change_values_unit"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ProtoData.change_values_unit">[docs]</a>    <span class="k">def</span> <span class="nf">change_values_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_unit</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">new_unit</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_unit</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">new_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_unit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_unit</span></div>
<div class="viewcode-block" id="ProtoData.units_to_SI"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ProtoData.units_to_SI">[docs]</a>    <span class="k">def</span> <span class="nf">units_to_SI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords_unit_to_SI</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values_unit_to_SI</span><span class="p">()</span></div>
<div class="viewcode-block" id="ProtoData.coords_unit_to_SI"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ProtoData.coords_unit_to_SI">[docs]</a>    <span class="k">def</span> <span class="nf">coords_unit_to_SI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_coords_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords_unit</span><span class="o">.</span><span class="n">SI_unit</span><span class="p">)</span></div>
<div class="viewcode-block" id="ProtoData.values_unit_to_SI"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ProtoData.values_unit_to_SI">[docs]</a>    <span class="k">def</span> <span class="nf">values_unit_to_SI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_values_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values_unit</span><span class="o">.</span><span class="n">SI_unit</span><span class="p">)</span></div>

    <span class="c1"># ----ellipse----</span>
<div class="viewcode-block" id="ProtoData.set_ellipse"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ProtoData.set_ellipse">[docs]</a>    <span class="k">def</span> <span class="nf">set_ellipse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.ellipse</span> <span class="kn">import</span> <span class="n">Ellipse</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ellipse</span> <span class="o">=</span> <span class="n">Ellipse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ellipse</span></div>


    <span class="c1"># ----analysis----</span>
<div class="viewcode-block" id="ProtoData.center_coordinates"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ProtoData.center_coordinates">[docs]</a>    <span class="k">def</span> <span class="nf">center_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">coords</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span> <span class="o">-</span> <span class="n">coords</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span></div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">min</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">median</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<div class="viewcode-block" id="ProtoData.min_removal"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ProtoData.min_removal">[docs]</a>    <span class="k">def</span> <span class="nf">min_removal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Substract the minimum of the values.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span></div>
<div class="viewcode-block" id="ProtoData.mean_removal"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ProtoData.mean_removal">[docs]</a>    <span class="k">def</span> <span class="nf">mean_removal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Substract the average of the values.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span></div></div>

    <span class="c1"># --------misc--------</span>
    <span class="c1"># def exclude_scans(scanarray, polyorder=1, criteria=0.15):</span>
    <span class="c1">#     &quot;&quot;&quot;Remove the bad scans from a measurement array.&quot;&quot;&quot;</span>
    <span class="c1">#     cpy_array = np.copy(scanarray)</span>
    <span class="c1">#     for idx, scan in enumerate(cpy_array):</span>
    <span class="c1">#         cpy_array[idx, :] = polynomial_removal(scan, polyorder)[0]</span>
    <span class="c1">#     left = cpy_array.shape[0]</span>
    <span class="c1">#     while left &gt; 1:</span>
    <span class="c1">#         cpy_array = cpy_array - np.nanmean(cpy_array, axis=0)[np.newaxis, :]</span>
    <span class="c1">#         std = np.nanstd(cpy_array, axis=1)</span>
    <span class="c1">#         if np.nanmax(std) &gt; criteria:</span>
    <span class="c1">#             cpy_array[np.nanargmax(std)] = np.nan</span>
    <span class="c1">#             scanarray[np.nanargmax(std)] = np.nan</span>
    <span class="c1">#             left = left - 1</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             break</span>
    <span class="c1">#     return scanarray</span>


<div class="viewcode-block" id="Profile"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.Profile">[docs]</a><span class="k">class</span> <span class="nc">Profile</span><span class="p">(</span><span class="n">ProtoData</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># ----maths----</span>
<div class="viewcode-block" id="Profile.derivative"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.Profile.derivative">[docs]</a>    <span class="k">def</span> <span class="nf">derivative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;gradient&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;methods: gradient, cubicbspline, &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">Profile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">units_to_SI</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;gradient&#39;</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;cubicbspline&#39;</span><span class="p">:</span>
            <span class="n">spline</span> <span class="o">=</span> <span class="n">BSpline</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">(),</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1"># deriv = spline.derivative()</span>
            <span class="n">res</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">spline</span><span class="o">.</span><span class="n">derivative</span><span class="p">()(</span><span class="n">res</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
            <span class="c1"># res.coords = res.coords[:-1] + res.mean_step/2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">res</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;heights&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;heights&#39;</span><span class="p">,</span> <span class="s1">&#39;slopes&#39;</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">values_unit</span><span class="o">.</span><span class="n">angle</span>
        <span class="k">elif</span> <span class="s1">&#39;slopes&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;slopes&#39;</span><span class="p">,</span> <span class="s1">&#39;curvature&#39;</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">values_unit</span><span class="o">.</span><span class="n">curvature</span>
        <span class="n">res</span><span class="o">.</span><span class="n">auto_units</span><span class="p">()</span>
        <span class="n">res</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">duplicate</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="Profile.integral"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.Profile.integral">[docs]</a>    <span class="k">def</span> <span class="nf">integral</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;simpson&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;methods: trapezoidal, simpson, romb, cubicbspline, &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">Profile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">units_to_SI</span><span class="p">()</span>
        <span class="n">res</span><span class="o">.</span><span class="n">level_profile</span><span class="p">()</span>
        <span class="n">integr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;cubicbspline&#39;</span><span class="p">:</span>
            <span class="n">spline</span> <span class="o">=</span> <span class="n">BSpline</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">(),</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">integr</span> <span class="o">=</span> <span class="p">[</span><span class="n">spline</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">res</span><span class="o">.</span><span class="n">mean_step</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span>
                                       <span class="n">res</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">res</span><span class="o">.</span><span class="n">mean_step</span><span class="o">*</span><span class="mf">1.5</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;trapezoidal&#39;</span><span class="p">:</span>
                <span class="n">integr</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">res</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;simpson&#39;</span><span class="p">:</span>
                <span class="n">integr</span> <span class="o">=</span> <span class="p">[</span><span class="n">simps</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">res</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;romberg&#39;</span><span class="p">:</span>
                <span class="n">integr</span> <span class="o">=</span> <span class="p">[</span><span class="n">romb</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">res</span><span class="o">.</span><span class="n">mean_step</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="n">res</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">coords</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">res</span><span class="o">.</span><span class="n">mean_step</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">res</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">integr</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;slopes&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;slopes&#39;</span><span class="p">,</span> <span class="s1">&#39;heights&#39;</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">values_unit</span><span class="o">.</span><span class="n">length</span>
        <span class="n">res</span><span class="o">.</span><span class="n">auto_units</span><span class="p">()</span>
        <span class="n">res</span><span class="o">.</span><span class="n">min_removal</span><span class="p">()</span>
        <span class="n">res</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">duplicate</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="Profile.interpolation"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.Profile.interpolation">[docs]</a>    <span class="k">def</span> <span class="nf">interpolation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;cubicbspline&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;methods: cubicbspline,  &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;cubicbspline&#39;</span><span class="p">:</span>
            <span class="n">spline</span> <span class="o">=</span> <span class="n">BSpline</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">spline</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">res</span></div>

    <span class="c1"># ----analysis----</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mean_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<div class="viewcode-block" id="Profile.reverse"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.Profile.reverse">[docs]</a>    <span class="k">def</span> <span class="nf">reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;slopes: Flip the X coordinates and negate the values.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;slopes&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">negative</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span></div>
<div class="viewcode-block" id="Profile.offsetting"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.Profile.offsetting">[docs]</a>    <span class="k">def</span> <span class="nf">offsetting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="c1"># left = self.values[0] + np.diff(self.values[:3]).mean() * np.sign(self.coords[0])</span>
        <span class="c1"># right = self.values[-1] + np.diff(self.values[-3:]).mean() * np.sign(self.coords[-1])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">+</span><span class="n">offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                <span class="c1"># left=left, right=right,</span>
                                <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span></div>
<div class="viewcode-block" id="Profile.level_profile"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.Profile.level_profile">[docs]</a>    <span class="k">def</span> <span class="nf">level_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Level the central value to zero and return the new values.</span>
<span class="sd">        Perform a small interpolation if case of even number of points.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">center</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># odd --&gt; no problem</span>
            <span class="n">center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="o">/</span><span class="mi">2</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># even --&gt; quadratic interpolation over the central 4 points</span>
                <span class="n">first</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>
                <span class="n">last</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
                <span class="n">interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="p">],</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="p">],</span>
                                  <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;quadratic&#39;</span><span class="p">)</span>
                <span class="n">center</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">-=</span> <span class="n">center</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span></div>
<div class="viewcode-block" id="Profile.profile_range"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.Profile.profile_range">[docs]</a>    <span class="k">def</span> <span class="nf">profile_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xrangearray</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;profile: Cut the data to the x coordinates given by [Xmin, Xmax].&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">xrangearray</span><span class="p">:</span>
            <span class="n">xrangearray</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_step</span><span class="o">/</span><span class="mf">4.0</span>
            <span class="n">split_at</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">xrangearray</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">split_at</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">split_at</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">split_at</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">split_at</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span></div>
<div class="viewcode-block" id="Profile.polynomial_removal"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.Profile.polynomial_removal">[docs]</a>    <span class="k">def</span> <span class="nf">polynomial_removal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove a polynomial fit from the values.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">-=</span> <span class="n">polyval</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">polyfit</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">order</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span></div>

<div class="viewcode-block" id="Profile.plot"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.Profile.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="p">())</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="Surface"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.Surface">[docs]</a><span class="k">class</span> <span class="nc">Surface</span><span class="p">(</span><span class="n">ProtoData</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap_prms</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># x, y = np.meshgrid(self.x, self.y, indexing=&#39;ij&#39;)</span>
        <span class="c1"># return x, y, self.values</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># ----overriding units functions----</span>
<div class="viewcode-block" id="Surface.auto_coords_unit"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.Surface.auto_coords_unit">[docs]</a>    <span class="k">def</span> <span class="nf">auto_coords_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pv</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">),</span>
              <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">new_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy_unit</span><span class="o">.</span><span class="n">auto</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">pv</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_coords_unit</span><span class="p">(</span><span class="n">new_unit</span><span class="p">)</span></div>
<div class="viewcode-block" id="Surface.change_coords_unit"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.Surface.change_coords_unit">[docs]</a>    <span class="k">def</span> <span class="nf">change_coords_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_unit</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">new_unit</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_unit</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_unit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_unit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_unit</span></div>

    <span class="c1"># ----properties----</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xy_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">z</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">z_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_unit</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">valid_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">valid_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_mask</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">invalid_pts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_mask</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">invalid_pct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">100</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">invalid_pts</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">size</span>

    <span class="c1"># ----analysis----</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_plane2D</span><span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="n">coef</span>
        <span class="k">return</span> <span class="n">z</span> <span class="o">-</span> <span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">B</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="n">C</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_conic2D</span><span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">xy</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">F</span> <span class="o">=</span> <span class="n">coef</span>
        <span class="k">return</span> <span class="n">z</span> <span class="o">-</span> <span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">xx</span> <span class="o">+</span> <span class="n">B</span><span class="o">*</span><span class="n">xy</span> <span class="o">+</span> <span class="n">C</span><span class="o">*</span><span class="n">yy</span> <span class="o">+</span> <span class="n">D</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">E</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="n">F</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_sphere2D</span><span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">coef</span>
        <span class="k">return</span> <span class="n">z</span> <span class="o">-</span> <span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="p">(</span><span class="n">xx</span> <span class="o">+</span> <span class="n">yy</span><span class="p">)</span> <span class="o">+</span> <span class="n">B</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">C</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="n">D</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_ellipse2D</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;theoretical ellipse (meter, radian). Returns slopes and heights&quot;&quot;&quot;</span>
        <span class="n">q</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">piston</span><span class="p">,</span> <span class="n">tilt</span> <span class="o">=</span> <span class="n">var</span>
        <span class="c1"># x += offset</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">q</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="c1"># semi-major axis</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="c1"># semi-minor axis</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># linear eccentricity</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">theta</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">F</span><span class="p">))</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">-</span> <span class="n">theta</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">F</span> <span class="o">-</span> <span class="n">q</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
            <span class="c1"># # slopes</span>
            <span class="c1"># s1n = (b/a) * (np.cos(mu))**2 * (x0+x*np.cos(mu))</span>
            <span class="c1"># s1d = a**2 - x0**2 - (x*np.cos(mu))**2 - 2.0*x*x0*np.cos(mu)</span>
            <span class="c1"># s1 = s1n / np.sqrt(s1d)</span>
            <span class="c1"># s2 = np.cos(mu) * -np.sin(mu)</span>
            <span class="c1"># sx = s1 + s2</span>
            <span class="c1"># sx = sx + tilt</span>
        <span class="c1"># heights</span>
        <span class="c1"># y0 = -b*np.sqrt(1 - (x0/a)**2)</span>
        <span class="n">z1</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
        <span class="n">z2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">x0</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">z3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">((</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">hx</span> <span class="o">=</span> <span class="n">z1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">z2</span> <span class="o">-</span> <span class="n">z3</span><span class="p">)</span>
            <span class="c1"># return sx, hx</span>

        <span class="n">hx</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">tilt</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tilt</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">hx</span><span class="o">-</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">hx</span> <span class="o">+=</span> <span class="n">piston</span>

        <span class="k">return</span> <span class="n">z</span> <span class="o">-</span> <span class="n">hx</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_fit2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="s1">&#39;plane&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">):</span> <span class="c1"># pylint: disable=W1113</span>
        <span class="n">tic</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fit</span> <span class="o">==</span> <span class="s1">&#39;ellipse&#39;</span><span class="p">:</span>
            <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">params</span>
            <span class="kn">from</span> <span class="nn">scipy.optimize.minpack</span> <span class="kn">import</span> <span class="n">leastsq</span>
            <span class="n">popt</span> <span class="o">=</span> <span class="n">leastsq</span><span class="p">(</span><span class="n">Surface</span><span class="o">.</span><span class="n">_ellipse2D</span><span class="p">,</span> <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                           <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span> <span class="n">p</span><span class="p">,</span> <span class="n">z</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]),</span>
                           <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-14</span><span class="p">,</span> <span class="n">ftol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span> <span class="n">gtol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">,</span>
                           <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">toc</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;applying </span><span class="si">{</span><span class="n">fit</span><span class="si">}</span><span class="s1"> least square fit to data (</span><span class="si">{</span><span class="p">(</span><span class="n">toc</span><span class="o">-</span><span class="n">tic</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-6</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">ms)&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">popt</span>
        <span class="n">one</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">one</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">fit</span> <span class="o">==</span> <span class="s1">&#39;conic&#39;</span><span class="p">:</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="n">M</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">fit</span> <span class="o">==</span> <span class="s1">&#39;sphere&#39;</span><span class="p">:</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="p">),</span> <span class="n">M</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">M</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># return np.linalg.lstsq(M[~mask], z[~mask], rcond=None)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">toc</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;applying </span><span class="si">{</span><span class="n">fit</span><span class="si">}</span><span class="s1"> least square fit to data (</span><span class="si">{</span><span class="p">(</span><span class="n">toc</span><span class="o">-</span><span class="n">tic</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-6</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">ms)&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="Surface.plane_removal"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.Surface.plane_removal">[docs]</a>    <span class="k">def</span> <span class="nf">plane_removal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meshgrid</span>
        <span class="n">pla</span> <span class="o">=</span> <span class="n">Surface</span><span class="o">.</span><span class="n">_fit2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="s1">&#39;plane&#39;</span><span class="p">)</span>
        <span class="n">tilt_x</span><span class="p">,</span> <span class="n">tilt_y</span><span class="p">,</span> <span class="n">piston</span> <span class="o">=</span> <span class="n">pla</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">Surface</span><span class="o">.</span><span class="n">_plane2D</span><span class="p">(</span><span class="n">pla</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">piston</span><span class="p">,</span> <span class="n">tilt_x</span><span class="p">,</span> <span class="n">tilt_y</span></div>

<div class="viewcode-block" id="Surface.cylinder_removal"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.Surface.cylinder_removal">[docs]</a>    <span class="k">def</span> <span class="nf">cylinder_removal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meshgrid</span>
        <span class="n">cyl</span> <span class="o">=</span> <span class="n">Surface</span><span class="o">.</span><span class="n">_fit2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="s1">&#39;conic&#39;</span><span class="p">)</span>
        <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">F</span> <span class="o">=</span> <span class="n">cyl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">B</span><span class="o">/</span><span class="p">(</span><span class="n">A</span><span class="o">-</span><span class="n">C</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">C</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">theta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">theta</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
            <span class="k">elif</span> <span class="n">theta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">theta</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">rot_xy</span> <span class="o">=</span> <span class="n">theta</span>
        <span class="n">Arot</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
              <span class="o">+</span> <span class="n">B</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
              <span class="o">+</span> <span class="n">C</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
        <span class="n">majcyl</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Arot</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">Arot</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
              <span class="o">+</span> <span class="n">B</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
              <span class="o">+</span> <span class="n">C</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
        <span class="n">mincyl</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Arot</span><span class="p">)</span>
        <span class="n">tilt_x</span> <span class="o">=</span> <span class="n">D</span>
        <span class="n">tilt_y</span> <span class="o">=</span> <span class="n">E</span>
        <span class="n">piston</span> <span class="o">=</span> <span class="n">F</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">Surface</span><span class="o">.</span><span class="n">_conic2D</span><span class="p">(</span><span class="n">cyl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">piston</span><span class="p">,</span> <span class="n">tilt_x</span><span class="p">,</span> <span class="n">tilt_y</span><span class="p">,</span> <span class="n">rot_xy</span><span class="p">,</span> <span class="n">majcyl</span><span class="p">,</span> <span class="n">mincyl</span></div>

<div class="viewcode-block" id="Surface.sphere_removal"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.Surface.sphere_removal">[docs]</a>    <span class="k">def</span> <span class="nf">sphere_removal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meshgrid</span>
        <span class="n">sph</span> <span class="o">=</span> <span class="n">Surface</span><span class="o">.</span><span class="n">_fit2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="s1">&#39;sphere&#39;</span><span class="p">)</span>
        <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">sph</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">curv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">A</span><span class="p">)</span>
        <span class="n">tilt_x</span> <span class="o">=</span> <span class="n">B</span>
        <span class="n">tilt_y</span> <span class="o">=</span> <span class="n">C</span>
        <span class="n">piston</span> <span class="o">=</span> <span class="n">D</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">Surface</span><span class="o">.</span><span class="n">_sphere2D</span><span class="p">(</span><span class="n">sph</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">piston</span><span class="p">,</span> <span class="n">tilt_x</span><span class="p">,</span> <span class="n">tilt_y</span><span class="p">,</span> <span class="n">curv</span></div>

<div class="viewcode-block" id="Surface.ellipse_removal"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.Surface.ellipse_removal">[docs]</a>    <span class="k">def</span> <span class="nf">ellipse_removal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>

        <span class="c1"># piston, tilts corrections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_coordinates</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plane_removal</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_removal</span><span class="p">()</span>

        <span class="c1"># rotation to get heights=0 at x=0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">units_to_SI</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meshgrid</span>
        <span class="n">ell</span> <span class="o">=</span> <span class="n">Surface</span><span class="o">.</span><span class="n">_fit2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s1">&#39;ellipse&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">theta</span><span class="o">*</span><span class="mf">1e-3</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">Surface</span><span class="o">.</span><span class="n">_ellipse2D</span><span class="p">(</span><span class="n">ell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">*</span><span class="mf">1e9</span>
        <span class="c1"># self.coords = self.coords*1e3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plane_removal</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean_removal</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ell</span></div>

    <span class="c1"># ----export----</span>
<div class="viewcode-block" id="Surface.writeMetroprofile"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.Surface.writeMetroprofile">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">writeMetroprofile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">frame_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phase_res</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        data heights array and pixel_size in meters,</span>
<span class="sd">        frame_size as tuple (width, height), data.shape by default</span>
<span class="sd">        phase_res: present in the Metropro file format v3, default 1 -&gt; 32768</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
        <span class="kn">from</span> <span class="nn">PyLOSt.data_in.francois_esrf.zygo</span> <span class="kn">import</span> <span class="n">MetroProData</span>
        <span class="n">new_data</span> <span class="o">=</span> <span class="n">MetroProData</span><span class="p">()</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;header_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4096</span>
        <span class="c1"># new_data.header[&#39;swinfo.date&#39;] = dt.datetime.now().strftime(&#39;%a %b %d %H:%M:%S %Y&#39;)</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;time_stamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;file created from imported data&#39;</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;lateral_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixel_size</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">_raw_shape</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">new_data</span><span class="o">.</span><span class="n">_raw_shape</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;cn_width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">width</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;cn_height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">height</span>
        <span class="k">if</span> <span class="n">frame_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="n">frame_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="n">frame_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Frame size not consistent with the data size, input ignored!&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">frame_size</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ac_width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">width</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ac_height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">height</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;cn_n_bytes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">width</span><span class="o">*</span><span class="n">height</span><span class="o">*</span><span class="mi">4</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;camera_width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">width</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;camera_height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">height</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header_dict_to_class</span><span class="p">()</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">Surface</span><span class="p">((</span><span class="n">new_data</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">new_data</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span>
                                   <span class="n">new_data</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">new_data</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span>
                                   <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="mf">6.327999813038332e-07</span><span class="p">)</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;wavelength_in&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">W</span>
        <span class="n">S</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;intf_scale_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span>
        <span class="n">O</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;obliquity_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">O</span>
        <span class="n">R</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">32768</span><span class="p">,</span> <span class="mi">131072</span><span class="p">]</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;phase_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_res</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">data</span> <span class="o">*</span> <span class="n">R</span><span class="p">[</span><span class="n">phase_res</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">W</span> <span class="o">*</span> <span class="n">S</span> <span class="o">*</span> <span class="n">O</span><span class="p">)</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">writefile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_data</span></div>


    <span class="c1"># ----roughness----</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ra</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">))</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_size</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rms</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pv</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rsk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_size</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rq</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rku</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_size</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rq</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filt_rz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>

<div class="viewcode-block" id="Surface.filt_rz"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.Surface.filt_rz">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">filt_rz</span><span class="p">(</span><span class="n">surfacedata</span><span class="p">,</span> <span class="n">num_pts</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">surfacedata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">window</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">window</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;rz calc: invalid data&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">window</span> <span class="o">=</span> <span class="n">window</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">*</span><span class="n">window</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">*</span><span class="n">window</span><span class="p">),</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
        <span class="n">hi</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lo</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_pts</span><span class="p">):</span> <span class="c1"># pylint: disable=unused-variable</span>
            <span class="n">iloc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">hi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">iloc</span><span class="p">])</span>
            <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">iloc</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span> <span class="c1"># pylint: disable=unbalanced-tuple-unpacking</span>
            <span class="n">locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">(</span>
                <span class="p">((</span><span class="n">row</span> <span class="o">+</span> <span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="p">(</span><span class="n">col</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()),</span>
                <span class="n">shape</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;clip&#39;</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">locs</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">iloc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmin</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">lo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">iloc</span><span class="p">])</span>
            <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">iloc</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span> <span class="c1"># pylint: disable=unbalanced-tuple-unpacking</span>
            <span class="n">locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">(</span>
                <span class="p">((</span><span class="n">row</span> <span class="o">+</span> <span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="p">(</span><span class="n">col</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()),</span>
                <span class="n">shape</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;clip&#39;</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">locs</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">rz</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">hi</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">lo</span><span class="p">))</span><span class="o">/</span><span class="n">num_pts</span>
        <span class="c1"># del data</span>
        <span class="k">return</span> <span class="n">rz</span></div>

    <span class="c1"># ----z scale----</span>
<div class="viewcode-block" id="Surface.calc_colormap"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.Surface.calc_colormap">[docs]</a>    <span class="k">def</span> <span class="nf">calc_colormap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">):</span>
        <span class="n">colorscale</span> <span class="o">=</span> <span class="n">Surface</span><span class="o">.</span><span class="n">ColorScale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">colorscale</span><span class="o">.</span><span class="n">cmap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap_prms</span> <span class="o">=</span> <span class="n">colorscale</span><span class="o">.</span><span class="n">cmap_prms</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap_prms</span></div>

<div class="viewcode-block" id="Surface.ColorScale"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.Surface.ColorScale">[docs]</a>    <span class="k">class</span> <span class="nc">ColorScale</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        base: &#39;ra&#39;, &#39;rq&#39;, &#39;pv&#39;, &#39;fixed&#39;</span>
<span class="sd">        params: list</span>
<span class="sd">            if stats based:  &#39;factor&#39; as stretching factor</span>
<span class="sd">            if manual scale: &#39;zmin, zmax, z_lo, z_hi&#39;</span>
<span class="sd">                             or &#39;default&#39; as half-scale default values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LinearSegmentedColormap</span> <span class="k">as</span> <span class="n">lsc</span>
        <span class="kn">from</span> <span class="nn">PyLOSt.data_in.francois_esrf.turbo_colormap_mpl</span> <span class="kn">import</span> <span class="n">turbo_colormap_data</span><span class="p">,</span> <span class="n">RGBToPyCmap</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">surface</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">):</span> <span class="c1"># pylint: disable=keyword-arg-before-vararg</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">=</span> <span class="n">surface</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factor</span> <span class="o">=</span> <span class="mf">2.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap_prms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">base</span> <span class="o">==</span> <span class="s1">&#39;fixed&#39;</span><span class="p">:</span>
                <span class="n">new_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_based</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_params</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s1">_based&#39;</span><span class="p">)(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">factor</span> <span class="o">=</span> <span class="n">new_params</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_cmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">turbo_colormap_data</span><span class="p">,</span> <span class="n">new_params</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_ra_based</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span> <span class="c1"># pylint: disable=keyword-arg-before-vararg, unused-argument</span>
            <span class="n">ra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="o">.</span><span class="n">ra</span>
            <span class="n">rq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="o">.</span><span class="n">rq</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="o">.</span><span class="n">masking</span><span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">rq</span><span class="p">)</span>
            <span class="n">median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">z_lo</span> <span class="o">=</span> <span class="o">-</span><span class="n">factor</span> <span class="o">*</span> <span class="n">ra</span> <span class="o">+</span> <span class="n">median</span>
            <span class="n">z_hi</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">ra</span> <span class="o">+</span> <span class="n">median</span>
            <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">z_lo</span><span class="p">,</span> <span class="n">z_hi</span><span class="p">,</span> <span class="n">factor</span>

        <span class="k">def</span> <span class="nf">_rq_based</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span> <span class="c1"># pylint: disable=keyword-arg-before-vararg, unused-argument</span>
            <span class="n">rq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="o">.</span><span class="n">rq</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="o">.</span><span class="n">masking</span><span class="p">(</span><span class="mf">6.0</span><span class="o">*</span><span class="n">rq</span><span class="p">)</span>
            <span class="n">median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">z_lo</span> <span class="o">=</span> <span class="o">-</span><span class="n">factor</span> <span class="o">*</span> <span class="n">rq</span> <span class="o">+</span> <span class="n">median</span>
            <span class="n">z_hi</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">rq</span> <span class="o">+</span> <span class="n">median</span>
            <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">z_lo</span><span class="p">,</span> <span class="n">z_hi</span><span class="p">,</span> <span class="n">factor</span>

        <span class="k">def</span> <span class="nf">_pv_based</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">12.0</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span> <span class="c1"># pylint: disable=keyword-arg-before-vararg, unused-argument</span>
            <span class="n">rq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="o">.</span><span class="n">rq</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="o">.</span><span class="n">rv</span>
            <span class="n">rp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="o">.</span><span class="n">rp</span>
            <span class="n">median</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="o">.</span><span class="n">median</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">rq</span><span class="o">/</span><span class="p">(</span><span class="n">rp</span><span class="o">-</span><span class="n">rv</span><span class="p">)</span>
            <span class="n">z_lo</span> <span class="o">=</span> <span class="o">-</span><span class="n">ratio</span> <span class="o">*</span> <span class="n">rq</span> <span class="o">+</span> <span class="n">median</span>
            <span class="n">z_hi</span> <span class="o">=</span> <span class="n">ratio</span> <span class="o">*</span> <span class="n">rq</span> <span class="o">+</span> <span class="n">median</span>
            <span class="k">return</span> <span class="n">rv</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">z_lo</span><span class="p">,</span> <span class="n">z_hi</span><span class="p">,</span> <span class="n">factor</span>

        <span class="k">def</span> <span class="nf">_fixed_based</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">params</span>
            <span class="n">zmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">negative</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="n">zmax</span> <span class="o">=</span> <span class="n">params</span>
            <span class="n">median</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="o">.</span><span class="n">median</span>
            <span class="n">z_lo</span> <span class="o">=</span> <span class="mf">0.40</span> <span class="o">*</span> <span class="n">zmin</span> <span class="o">+</span> <span class="n">median</span>
            <span class="n">z_hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">negative</span><span class="p">(</span><span class="n">z_lo</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">,</span> <span class="n">z_lo</span><span class="p">,</span> <span class="n">z_hi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span>

        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">_calc_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">,</span> <span class="n">z_lo</span><span class="p">,</span> <span class="n">z_hi</span><span class="p">,</span> <span class="n">zfac</span> <span class="o">=</span> <span class="n">params</span> <span class="c1"># pylint: disable=unused-variable</span>
            <span class="n">num</span> <span class="o">=</span> <span class="mi">240</span>
            <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">z_lo1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">z_lo</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">z_lo2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">z_lo</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">105</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">z_lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z_lo1</span><span class="p">,</span> <span class="n">z_lo2</span><span class="p">)</span>
            <span class="n">z_hi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">z_hi</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">85</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">z_hi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">z_hi</span><span class="p">,</span> <span class="n">zmax</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">z_hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z_hi1</span><span class="p">,</span> <span class="n">z_hi2</span><span class="p">)</span>
            <span class="n">new_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z_lo</span><span class="p">,</span> <span class="n">z_hi</span><span class="p">)</span>
            <span class="n">new_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">new_z</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">blue</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="n">num</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">green</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="n">num</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">red</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="n">num</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">new_cmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">new_z</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">blue</span><span class="p">),</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">new_z</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">green</span><span class="p">),</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">new_z</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">red</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;new colormap:&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="n">segments</span> <span class="o">=</span> <span class="n">Surface</span><span class="o">.</span><span class="n">ColorScale</span><span class="o">.</span><span class="n">RGBToPyCmap</span><span class="p">(</span><span class="n">new_cmap</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Surface</span><span class="o">.</span><span class="n">ColorScale</span><span class="o">.</span><span class="n">lsc</span><span class="p">(</span><span class="s1">&#39;veeco&#39;</span><span class="p">,</span> <span class="n">segments</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">num</span><span class="p">),</span> <span class="n">params</span></div>

<div class="viewcode-block" id="Surface.plot"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.Surface.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_colormap</span><span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
                <span class="n">vmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap_prms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap_prms</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span>
                <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div></div>


<span class="c1"># ------------generic data class------------</span>
<div class="viewcode-block" id="Header"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.Header">[docs]</a><span class="k">class</span> <span class="nc">Header</span><span class="p">():</span>
    <span class="c1"># def __repr__(self):</span>
    <span class="c1">#     return self</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Header block&#39;</span></div>

<span class="k">def</span> <span class="nf">_iter_header_dict</span><span class="p">(</span><span class="n">dico</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dico</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">Header</span><span class="p">()</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>
            <span class="n">_iter_header_dict</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="ESRFOpticsLabData"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ESRFOpticsLabData">[docs]</a><span class="k">class</span> <span class="nc">ESRFOpticsLabData</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Common data class.&#39;&#39;&#39;</span>
    <span class="n">organisation</span> <span class="o">=</span> <span class="s2">&quot;ESRF&quot;</span>
    <span class="n">division</span> <span class="o">=</span> <span class="s1">&#39;ISDD&#39;</span>
    <span class="n">group</span> <span class="o">=</span> <span class="s2">&quot;XOG&quot;</span>
    <span class="n">laboratory</span> <span class="o">=</span> <span class="s2">&quot;Mirror &amp; Metrology Lab&quot;</span>
    <span class="n">kind</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_steps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="p">{</span> <span class="c1"># as example</span>
                      <span class="s1">&#39;coords&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># must be present</span>
                      <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;angle&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="s1">&#39;pixel&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,}</span>

<div class="viewcode-block" id="ESRFOpticsLabData.read"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ESRFOpticsLabData.read">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span><span class="o">.</span><span class="n">readfile</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ESRFOpticsLabData</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span> <span class="c1"># pylint: disable=super-with-arguments</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  file </span><span class="se">\&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1"> opened.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="c1"># ----methods to be overrided----</span>
<div class="viewcode-block" id="ESRFOpticsLabData.readfile"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ESRFOpticsLabData.readfile">[docs]</a>    <span class="k">def</span> <span class="nf">readfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># pylint: disable=unused-argument</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1">: </span><span class="se">\&#39;</span><span class="s1">readfile</span><span class="se">\&#39;</span><span class="s1"> function must be overrided.&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="c1"># ----common methods----</span>
<div class="viewcode-block" id="ESRFOpticsLabData.header_dict_to_class"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ESRFOpticsLabData.header_dict_to_class">[docs]</a>    <span class="k">def</span> <span class="nf">header_dict_to_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_iter_header_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div>

    <span class="c1"># ----analysis----</span>
<div class="viewcode-block" id="ESRFOpticsLabData.add_analysis_step"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ESRFOpticsLabData.add_analysis_step">[docs]</a>    <span class="k">def</span> <span class="nf">add_analysis_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">funcname</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">):</span>
        <span class="n">step</span> <span class="o">=</span> <span class="p">(</span><span class="n">funcname</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step</span><span class="p">)</span></div>

<div class="viewcode-block" id="ESRFOpticsLabData.analyze"><a class="viewcode-back" href="../../../../PyLOSt.data_in.francois_esrf.html#PyLOSt.data_in.francois_esrf.generic.ESRFOpticsLabData.analyze">[docs]</a>    <span class="k">def</span> <span class="nf">analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">funcname</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_steps</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;      </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s1">: applying </span><span class="si">{</span><span class="n">funcname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">funcname</span><span class="p">)(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">PyLOSt</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../PyLOSt.html">PyLOSt package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quick_guide.html">Quick Guide</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>