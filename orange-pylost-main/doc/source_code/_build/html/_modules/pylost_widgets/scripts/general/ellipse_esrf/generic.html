
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pylost_widgets.scripts.general.ellipse_esrf.generic &#8212; pylost_widgets  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/alabaster.css" />
    <script data-url_root="../../../../../" id="documentation_options" src="../../../../../_static/documentation_options.js"></script>
    <script src="../../../../../_static/jquery.js"></script>
    <script src="../../../../../_static/underscore.js"></script>
    <script src="../../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pylost_widgets.scripts.general.ellipse_esrf.generic</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="sd">http://hplgit.github.io/primer.html/doc/pub/class/._class-solarized003.html</span>

<span class="sd">https://docs.python.org/3/glossary.html#term-bytecode</span>

<span class="sd">https://realpython.com/python-descriptors/</span>

<span class="sd">https://stackoverflow.com/questions/2278426/inner-classes-how-can-i-get-the-outer-class-object-at-construction-time</span>

<span class="sd">https://medium.com/@vadimpushtaev/decorator-inside-python-class-1e74d23107f6</span>

<span class="sd">https://docs.scipy.org/doc/scipy/reference/tutorial/interpolate.html#spline-interpolation</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># pylint: disable=C0103, C0115, C0116</span>
<span class="c1"># pylint: disable=C0415</span>
<span class="c1"># pylint: disable=R0902, R0903, R0904, R0913, R0914</span>

<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">perf_counter_ns</span>

<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">numpy.polynomial.polynomial</span> <span class="kn">import</span> <span class="n">polyfit</span><span class="p">,</span> <span class="n">polyval</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span><span class="p">,</span> <span class="n">BSpline</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">simps</span><span class="p">,</span> <span class="n">romb</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">rotate</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LinearSegmentedColormap</span> <span class="k">as</span> <span class="n">lsc</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>


<div class="viewcode-block" id="ProtoData"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ProtoData">[docs]</a><span class="k">class</span> <span class="nc">ProtoData</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coords</span><span class="p">):</span>
                <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># if isinstance(units, tuple):</span>
        <span class="c1">#     units = {&#39;coords&#39;: units[0], &#39;values&#39;: [1]}</span>
        <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">units</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;coords&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>

        <span class="n">initial</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;initial&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">initial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;initial&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">initial</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ellipse</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># ----properties----</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">kind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">unit_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values_unit</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;rad&#39;</span> <span class="ow">in</span> <span class="n">unit_str</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">return</span> <span class="s1">&#39;slopes&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;m-1&#39;</span> <span class="ow">in</span> <span class="n">unit_str</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">return</span> <span class="s1">&#39;curvature&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;heights&#39;</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_unit</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">z</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">z_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_unit</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_shape</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">u</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">coords_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_coords_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">values_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_values_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hasnan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>

    <span class="c1"># ----common functions----</span>
<div class="viewcode-block" id="ProtoData.apply"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ProtoData.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="ProtoData.duplicate"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ProtoData.duplicate">[docs]</a>    <span class="k">def</span> <span class="nf">duplicate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># # cls = type(self)</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">Profile</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">Surface</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProtoData.reload"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ProtoData.reload">[docs]</a>    <span class="k">def</span> <span class="nf">reload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">coords</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>

<div class="viewcode-block" id="ProtoData.automasking"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ProtoData.automasking">[docs]</a>    <span class="k">def</span> <span class="nf">automasking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">apply</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">median</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold</span> <span class="c1"># XXX: or mean_removal ?</span>
        <span class="k">if</span> <span class="n">apply</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span></div>

<div class="viewcode-block" id="ProtoData.level_data"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ProtoData.level_data">[docs]</a>    <span class="k">def</span> <span class="nf">level_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Level the central value (along the X-axis) to zero and return the new values.</span>
<span class="sd">        Perform a small interpolation if case of even number of points.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">center</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># size = size[0]</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">nb_points</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="o">*</span><span class="mf">0.01</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># odd --&gt; no problem</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="o">/</span><span class="mi">2</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># even --&gt; quadratic interpolation over the central nb_points</span>
            <span class="n">window</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nb_points</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">first</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">window</span>
            <span class="n">last</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">window</span>
            <span class="n">interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="p">],</span>
                              <span class="n">values</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="p">],</span>
                              <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;quadratic&#39;</span><span class="p">)</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">coords</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">-=</span> <span class="n">center</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span></div>

    <span class="c1"># ----units functions----</span>
<div class="viewcode-block" id="ProtoData.auto_units"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ProtoData.auto_units">[docs]</a>    <span class="k">def</span> <span class="nf">auto_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_coords_unit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_values_unit</span><span class="p">()</span></div>

<div class="viewcode-block" id="ProtoData.auto_coords_unit"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ProtoData.auto_coords_unit">[docs]</a>    <span class="k">def</span> <span class="nf">auto_coords_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">new_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_unit</span><span class="o">.</span><span class="n">auto</span><span class="p">(</span><span class="n">pv</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_coords_unit</span><span class="p">(</span><span class="n">new_unit</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProtoData.auto_values_unit"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ProtoData.auto_values_unit">[docs]</a>    <span class="k">def</span> <span class="nf">auto_values_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">new_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_unit</span><span class="o">.</span><span class="n">auto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pv</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_values_unit</span><span class="p">(</span><span class="n">new_unit</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProtoData.reset_units"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ProtoData.reset_units">[docs]</a>    <span class="k">def</span> <span class="nf">reset_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_coords_unit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_values_unit</span><span class="p">()</span></div>

<div class="viewcode-block" id="ProtoData.reset_coords_unit"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ProtoData.reset_coords_unit">[docs]</a>    <span class="k">def</span> <span class="nf">reset_coords_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_coords_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">coords_unit</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProtoData.reset_values_unit"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ProtoData.reset_values_unit">[docs]</a>    <span class="k">def</span> <span class="nf">reset_values_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_values_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">values_unit</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProtoData.change_defaults_units"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ProtoData.change_defaults_units">[docs]</a>    <span class="k">def</span> <span class="nf">change_defaults_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_units</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_units</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">new_units</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_units</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_units</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="ProtoData.change_units"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ProtoData.change_units">[docs]</a>    <span class="k">def</span> <span class="nf">change_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_units</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_units</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">change_coords_unit</span><span class="p">(</span><span class="n">new_units</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">change_values_unit</span><span class="p">(</span><span class="n">new_units</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">])</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_coords_unit</span><span class="p">(</span><span class="n">new_units</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_values_unit</span><span class="p">(</span><span class="n">new_units</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="ProtoData.change_coords_unit"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ProtoData.change_coords_unit">[docs]</a>    <span class="k">def</span> <span class="nf">change_coords_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_unit</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">new_unit</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_unit</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">new_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_unit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_unit</span></div>

<div class="viewcode-block" id="ProtoData.change_values_unit"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ProtoData.change_values_unit">[docs]</a>    <span class="k">def</span> <span class="nf">change_values_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_unit</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">new_unit</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_unit</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">new_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_unit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_unit</span></div>

<div class="viewcode-block" id="ProtoData.units_to_SI"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ProtoData.units_to_SI">[docs]</a>    <span class="k">def</span> <span class="nf">units_to_SI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords_unit_to_SI</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values_unit_to_SI</span><span class="p">()</span></div>

<div class="viewcode-block" id="ProtoData.coords_unit_to_SI"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ProtoData.coords_unit_to_SI">[docs]</a>    <span class="k">def</span> <span class="nf">coords_unit_to_SI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_coords_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords_unit</span><span class="o">.</span><span class="n">SI_unit</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProtoData.values_unit_to_SI"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ProtoData.values_unit_to_SI">[docs]</a>    <span class="k">def</span> <span class="nf">values_unit_to_SI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_values_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values_unit</span><span class="o">.</span><span class="n">SI_unit</span><span class="p">)</span></div>

    <span class="c1"># ----ellipse----</span>
<div class="viewcode-block" id="ProtoData.set_ellipse"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ProtoData.set_ellipse">[docs]</a>    <span class="k">def</span> <span class="nf">set_ellipse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;p and q in meter, theta in mrad&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.ellipse</span> <span class="kn">import</span> <span class="n">Ellipse</span>
        <span class="k">if</span> <span class="n">reload</span><span class="p">:</span>
            <span class="n">initial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial</span>
            <span class="k">if</span> <span class="n">initial</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">initial</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ellipse</span> <span class="o">=</span> <span class="n">Ellipse</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ellipse</span> <span class="o">=</span> <span class="n">Ellipse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ellipse</span></div>

<div class="viewcode-block" id="ProtoData.ellipse_removal"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ProtoData.ellipse_removal">[docs]</a>    <span class="k">def</span> <span class="nf">ellipse_removal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optimization</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;p and q in meter, theta in mrad&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ellipse</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_ellipse</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ellipse removal&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ellipse</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">values_unit</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ellipse</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">pv</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">optimize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ellipse</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">optimization</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_values_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ellipse</span><span class="o">.</span><span class="n">residues</span><span class="o">.</span><span class="n">values_unit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ellipse</span><span class="o">.</span><span class="n">residues</span><span class="o">.</span><span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ellipse</span><span class="o">.</span><span class="n">p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ellipse</span><span class="o">.</span><span class="n">q</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ellipse</span><span class="o">.</span><span class="n">theta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span> <span class="o">=</span> <span class="s1">&#39;ellipse&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terms</span> <span class="o">=</span> <span class="s1">&#39;Ellipse&#39;</span></div>

    <span class="c1"># ----analysis----</span>
    <span class="c1"># def gravity_correction(self, length, thickness, distance, material=&#39;Silicon&#39;, operation=&#39;subtract&#39;):</span>
    <span class="c1">#     &quot;&quot;&quot;Length, thickness, distance in mm.&quot;&quot;&quot;</span>
    <span class="c1">#     from . import gravity</span>
    <span class="c1">#     grav = gravity.model(self, length, thickness, distance, material)</span>
    <span class="c1">#     if &#39;add&#39; in operation:</span>
    <span class="c1">#         grav.values = -grav.values</span>
    <span class="c1">#     delta = grav.mean - self.mean</span>
    <span class="c1">#     self.values = self.values + grav.values - delta</span>
    <span class="c1">#     return grav</span>
<div class="viewcode-block" id="ProtoData.center_coordinates"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ProtoData.center_coordinates">[docs]</a>    <span class="k">def</span> <span class="nf">center_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">coords</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span></div>

<div class="viewcode-block" id="ProtoData.flip"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ProtoData.flip">[docs]</a>    <span class="k">def</span> <span class="nf">flip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">axis</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;slope&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">negative</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span></div>

<div class="viewcode-block" id="ProtoData.min_removal"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ProtoData.min_removal">[docs]</a>    <span class="k">def</span> <span class="nf">min_removal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Substract the minimum of the values.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span></div>

<div class="viewcode-block" id="ProtoData.mean_removal"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ProtoData.mean_removal">[docs]</a>    <span class="k">def</span> <span class="nf">mean_removal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Substract the average of the values.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">min</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">median</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span></div>


<div class="viewcode-block" id="Profile"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Profile">[docs]</a><span class="k">class</span> <span class="nc">Profile</span><span class="p">(</span><span class="n">ProtoData</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># ----maths----</span>
<div class="viewcode-block" id="Profile.derivative"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Profile.derivative">[docs]</a>    <span class="k">def</span> <span class="nf">derivative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;gradient&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;methods: gradient, cubicbspline, &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicate</span><span class="p">()</span>
        <span class="n">res</span><span class="o">.</span><span class="n">units_to_SI</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;gradient&#39;</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;cubicbspline&#39;</span><span class="p">:</span>
            <span class="n">spline</span> <span class="o">=</span> <span class="n">BSpline</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">(),</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="c1"># deriv = spline.derivative()</span>
            <span class="n">res</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">spline</span><span class="o">.</span><span class="n">derivative</span><span class="p">()(</span><span class="n">res</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
            <span class="c1"># res.coords = res.coords[:-1] + res.mean_step/2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;height&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">res</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">values_unit</span><span class="o">.</span><span class="n">angle</span>
        <span class="k">elif</span> <span class="s1">&#39;slope&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">res</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">values_unit</span><span class="o">.</span><span class="n">curvature</span>
        <span class="n">res</span><span class="o">.</span><span class="n">auto_units</span><span class="p">()</span>
        <span class="n">res</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">duplicate</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="Profile.integral"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Profile.integral">[docs]</a>    <span class="k">def</span> <span class="nf">integral</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;simpson&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;methods: trapezoidal, simpson, romb, cubicbspline, &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicate</span><span class="p">()</span>
        <span class="n">res</span><span class="o">.</span><span class="n">units_to_SI</span><span class="p">()</span>
        <span class="n">res</span><span class="o">.</span><span class="n">level_data</span><span class="p">()</span>
        <span class="n">step</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">mean_step</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">coords</span><span class="c1"># - step/2</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">step</span><span class="p">],</span> <span class="n">coords</span><span class="p">,</span> <span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">step</span><span class="p">]))</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;cubicbspline&#39;</span><span class="p">:</span>
            <span class="n">spline</span> <span class="o">=</span> <span class="n">BSpline</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">(),</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">integr</span> <span class="o">=</span> <span class="p">[</span><span class="n">spline</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spline</span> <span class="o">=</span> <span class="n">BSpline</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">(),</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">interpolate</span> <span class="o">=</span> <span class="n">spline</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;trapezoidal&#39;</span><span class="p">:</span>
                <span class="n">integr</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">interpolate</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;romberg&#39;</span><span class="p">:</span>
                <span class="n">integr</span> <span class="o">=</span> <span class="p">[</span><span class="n">romb</span><span class="p">(</span><span class="n">interpolate</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">integr</span> <span class="o">=</span> <span class="p">[</span><span class="n">simps</span><span class="p">(</span><span class="n">interpolate</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span>
        <span class="n">res</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">integr</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;slope&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">res</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">values_unit</span><span class="o">.</span><span class="n">length</span>
        <span class="n">res</span><span class="o">.</span><span class="n">auto_units</span><span class="p">()</span>
        <span class="n">res</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">duplicate</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="Profile.interpolation"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Profile.interpolation">[docs]</a>    <span class="k">def</span> <span class="nf">interpolation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_coords</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;cubicbspline&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;method: cubicbspline&quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">Profile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;cubicbspline&#39;</span><span class="p">:</span>
            <span class="n">spline</span> <span class="o">=</span> <span class="n">BSpline</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">(),</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">spline</span><span class="p">(</span><span class="n">new_coords</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">new_coords</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="Profile.theoretical"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Profile.theoretical">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">theoretical</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">roc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;kind: &#39;elliptical&#39;, &#39;parabolic&#39;, &#39;spherical&#39;    (SI units)&#39;&#39;&#39;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;spherical&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="kn">from</span> <span class="nn">.ellipse</span> <span class="kn">import</span> <span class="n">Ellipse</span>
            <span class="k">if</span> <span class="s1">&#39;parabolic&#39;</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mf">1e5</span>
            <span class="n">slp</span> <span class="o">=</span> <span class="n">Ellipse</span><span class="o">.</span><span class="n">from_parameters</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;slope&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
            <span class="n">hgt</span> <span class="o">=</span> <span class="n">Ellipse</span><span class="o">.</span><span class="n">from_parameters</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;spherical&#39;</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">slp</span> <span class="o">=</span> <span class="n">x</span><span class="o">/</span><span class="n">roc</span>
            <span class="n">slp</span> <span class="o">=</span> <span class="n">slp</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">slp</span><span class="p">)</span>
            <span class="n">hgt</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">roc</span>
            <span class="n">hgt</span> <span class="o">=</span> <span class="n">hgt</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">hgt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">slp</span><span class="p">,</span> <span class="n">hgt</span></div>

    <span class="c1"># ----analysis----</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mean_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<div class="viewcode-block" id="Profile.reverse"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Profile.reverse">[docs]</a>    <span class="k">def</span> <span class="nf">reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;slopes: Flip the X coordinates and negate the values.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;slope&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">negative</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span></div>

<div class="viewcode-block" id="Profile.offsetting"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Profile.offsetting">[docs]</a>    <span class="k">def</span> <span class="nf">offsetting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="c1"># left = self.values[0] + np.diff(self.values[:3]).mean() * np.sign(self.coords[0])</span>
        <span class="c1"># right = self.values[-1] + np.diff(self.values[-3:]).mean() * np.sign(self.coords[-1])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">+</span><span class="n">offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                <span class="c1"># left=left, right=right,</span>
                                <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span></div>

<div class="viewcode-block" id="Profile.subarray"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Profile.subarray">[docs]</a>    <span class="k">def</span> <span class="nf">subarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xrangearray</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;profile: Cut the data to the x coordinates given by [Xmin, Xmax].&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">xrangearray</span><span class="p">:</span>
            <span class="n">xrangearray</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_step</span><span class="o">/</span><span class="mf">4.0</span>
            <span class="n">split_at</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">xrangearray</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">split_at</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">split_at</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">split_at</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">split_at</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span></div>

<div class="viewcode-block" id="Profile.polynomial_removal"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Profile.polynomial_removal">[docs]</a>    <span class="k">def</span> <span class="nf">polynomial_removal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove a polynomial fit to the values.</span>
<span class="sd">        Return the polynomial fit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="n">poly</span> <span class="o">=</span> <span class="n">polyfit</span><span class="p">(</span><span class="n">domain</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">order</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">-=</span> <span class="n">polyval</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">poly</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">polyval</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">poly</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">radius</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># domain = np.linspace(0, 1, num=len(self.values))</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span>
        <span class="k">if</span> <span class="s1">&#39;height&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span>
        <span class="n">pol</span> <span class="o">=</span> <span class="n">polyfit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_unit</span><span class="p">),</span>
                      <span class="n">unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_unit</span><span class="p">),</span>
                      <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pol</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

<div class="viewcode-block" id="Profile.plot"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Profile.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Matplotlib 1D plot with some additional functions.</span>

<span class="sd">            Parameters :</span>
<span class="sd">                matplotlib.pyplot.plot arguments</span>
<span class="sd">                https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.plot.html</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="c1">#, figsize=(10,5))</span>
        <span class="c1"># fig.set_tight_layout(True)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="p">(),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="Surface"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Surface">[docs]</a><span class="k">class</span> <span class="nc">Surface</span><span class="p">(</span><span class="n">ProtoData</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pixel_res</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asfarray</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
                                           <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]))]),</span>
                              <span class="n">units</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">piston</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tilt_x</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tilt_y</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rot_xy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">majcyl</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mincyl</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terms</span> <span class="o">=</span> <span class="s1">&#39;No terms&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap_prms</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># ----overriding units functions----</span>
<div class="viewcode-block" id="Surface.auto_coords_unit"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Surface.auto_coords_unit">[docs]</a>    <span class="k">def</span> <span class="nf">auto_coords_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pv</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">),</span>
              <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">new_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_unit</span><span class="o">.</span><span class="n">auto</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">pv</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_coords_unit</span><span class="p">(</span><span class="n">new_unit</span><span class="p">)</span></div>

<div class="viewcode-block" id="Surface.change_coords_unit"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Surface.change_coords_unit">[docs]</a>    <span class="k">def</span> <span class="nf">change_coords_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_unit</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">new_unit</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_unit</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_unit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_unit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_unit</span></div>

    <span class="c1"># ----properties----</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pixel_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">_pixel_res</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">valid_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">valid_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_mask</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">invalid_pts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_mask</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">invalid_pct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">100</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">invalid_pts</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">size</span>

    <span class="c1"># ----manipulation----</span>
<div class="viewcode-block" id="Surface.change_resolution"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Surface.change_resolution">[docs]</a>    <span class="k">def</span> <span class="nf">change_resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">new_pixel_size</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;size in meter&#39;&#39;&#39;</span>
        <span class="n">size_x</span><span class="p">,</span> <span class="n">size_y</span> <span class="o">=</span> <span class="n">new_pixel_size</span>
        <span class="n">shape_x</span><span class="p">,</span> <span class="n">shape_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shape_x</span><span class="o">*</span><span class="n">size_x</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">shape_x</span><span class="p">,</span>
                        <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shape_y</span><span class="o">*</span><span class="n">size_y</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">shape_y</span><span class="p">,</span>
                        <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pixel_res</span> <span class="o">=</span> <span class="n">new_pixel_size</span></div>

<div class="viewcode-block" id="Surface.rotate"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Surface.rotate">[docs]</a>    <span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Rotation angle in degrees.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">angle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span>
                             <span class="n">reshape</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cval</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                             <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">prefilter</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                     <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                     <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">center</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">center_coordinates</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropnan</span><span class="p">()</span></div>

<div class="viewcode-block" id="Surface.dropnan"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Surface.dropnan">[docs]</a>    <span class="k">def</span> <span class="nf">dropnan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mask</span>  <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
        <span class="n">mask</span>  <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span></div>

<div class="viewcode-block" id="Surface.coords2pix"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Surface.coords2pix">[docs]</a>    <span class="k">def</span> <span class="nf">coords2pix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">edge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">edge</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">center</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">asfarray</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">split_at</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asfarray</span><span class="p">((</span><span class="n">position</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">split_at</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_unit</span><span class="p">(</span><span class="n">split_at</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">split_at</span><span class="p">):</span>
            <span class="n">p</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mf">4.0</span>
            <span class="k">if</span> <span class="n">from_center</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">s</span>
            <span class="n">split_at</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">short</span><span class="p">:</span>
            <span class="n">split_at</span> <span class="o">=</span> <span class="n">split_at</span> <span class="o">-</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">split_at</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span></div>

    <span class="c1"># ----analysis----</span>
<div class="viewcode-block" id="Surface.subarray_pixel"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Surface.subarray_pixel">[docs]</a>    <span class="k">def</span> <span class="nf">subarray_pixel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xrangearray</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yrangearray</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">apply</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">xrangearray</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xrangearray</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">yrangearray</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">yrangearray</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">coords_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">xrangearray</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">xrangearray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">coords_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">yrangearray</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">yrangearray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">xrangearray</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">xrangearray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">yrangearray</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">yrangearray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">apply</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords_x</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords_y</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">values</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">coords_x</span><span class="p">,</span> <span class="n">coords_y</span><span class="p">),</span> <span class="n">values</span></div>

<div class="viewcode-block" id="Surface.subarray"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Surface.subarray">[docs]</a>    <span class="k">def</span> <span class="nf">subarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">edge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">apply</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mask the data according to the position and the size.</span>
<span class="sd">        if center is not None, use lower-left egde.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">split_at</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords2pix</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">edge</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">from_center</span><span class="p">,</span> <span class="n">short</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
        <span class="n">coords</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subarray_pixel</span><span class="p">(</span><span class="o">*</span><span class="n">split_at</span><span class="p">,</span> <span class="n">apply</span><span class="o">=</span><span class="n">apply</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">coords</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">split_at</span></div>

<div class="viewcode-block" id="Surface.extract_profile"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Surface.extract_profile">[docs]</a>    <span class="k">def</span> <span class="nf">extract_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">mm</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">axis</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">ax</span><span class="p">])</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">ax</span><span class="p">])</span>
        <span class="n">center</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">position</span><span class="p">]</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="n">length</span><span class="p">,</span> <span class="n">width</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">center</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">from_center</span><span class="p">:</span>
            <span class="n">center</span><span class="p">[</span><span class="o">~</span><span class="n">ax</span><span class="p">]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="o">~</span><span class="n">ax</span><span class="p">])</span>
        <span class="n">coords</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subarray</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span> <span class="p">,</span><span class="n">from_center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span> <span class="n">apply</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Profile</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">ax</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=~</span><span class="n">ax</span><span class="p">),</span> <span class="n">unit</span><span class="p">)</span></div>

    <span class="c1"># ----maths----</span>
<div class="viewcode-block" id="Surface.derivative"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Surface.derivative">[docs]</a>    <span class="k">def</span> <span class="nf">derivative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower-left&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;methods: gradient</span>
<span class="sd">        origin: combination of &#39;lower&#39; &#39;upper&#39; &#39;right&#39; &#39;left&#39;  (default: &#39;lower-left&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicate</span><span class="p">()</span>
        <span class="n">res_x</span><span class="o">.</span><span class="n">units_to_SI</span><span class="p">()</span>
        <span class="n">res_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicate</span><span class="p">()</span>
        <span class="n">res_y</span><span class="o">.</span><span class="n">units_to_SI</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res_x</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">res_x</span><span class="o">.</span><span class="n">x</span>
            <span class="k">if</span> <span class="s1">&#39;right&#39;</span> <span class="ow">in</span> <span class="n">origin</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">res_x</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">res_y</span><span class="o">.</span><span class="n">y</span>
            <span class="k">if</span> <span class="s1">&#39;upper&#39;</span> <span class="ow">in</span> <span class="n">origin</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res_y</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="n">res_y</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;height&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">res_x</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_x</span><span class="o">.</span><span class="n">values_unit</span><span class="o">.</span><span class="n">angle</span>
            <span class="n">res_y</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_y</span><span class="o">.</span><span class="n">values_unit</span><span class="o">.</span><span class="n">angle</span>
        <span class="k">elif</span> <span class="s1">&#39;slope&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">res_x</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_x</span><span class="o">.</span><span class="n">values_unit</span><span class="o">.</span><span class="n">curvature</span>
            <span class="n">res_y</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_y</span><span class="o">.</span><span class="n">values_unit</span><span class="o">.</span><span class="n">curvature</span>
        <span class="n">res_x</span><span class="o">.</span><span class="n">auto_units</span><span class="p">()</span>
        <span class="n">res_x</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">res_x</span><span class="o">.</span><span class="n">duplicate</span><span class="p">()</span>
        <span class="n">res_y</span><span class="o">.</span><span class="n">auto_units</span><span class="p">()</span>
        <span class="n">res_y</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">res_y</span><span class="o">.</span><span class="n">duplicate</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res_x</span><span class="p">,</span> <span class="n">res_y</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_plane2D</span><span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="n">coef</span>
        <span class="k">return</span> <span class="n">z</span> <span class="o">-</span> <span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">B</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="n">C</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_conic2D</span><span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">xy</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">F</span> <span class="o">=</span> <span class="n">coef</span>
        <span class="k">return</span> <span class="n">z</span> <span class="o">-</span> <span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">xx</span> <span class="o">+</span> <span class="n">B</span><span class="o">*</span><span class="n">xy</span> <span class="o">+</span> <span class="n">C</span><span class="o">*</span><span class="n">yy</span> <span class="o">+</span> <span class="n">D</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">E</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="n">F</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_sphere2D</span><span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">coef</span>
        <span class="k">return</span> <span class="n">z</span> <span class="o">-</span> <span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="p">(</span><span class="n">xx</span> <span class="o">+</span> <span class="n">yy</span><span class="p">)</span> <span class="o">+</span> <span class="n">B</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">C</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="n">D</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_fit2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="s1">&#39;plane&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">):</span> <span class="c1"># pylint: disable=W1113</span>
        <span class="n">tic</span> <span class="o">=</span> <span class="n">perf_counter_ns</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">one</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">one</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">fit</span> <span class="o">==</span> <span class="s1">&#39;conic&#39;</span><span class="p">:</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="n">M</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">fit</span> <span class="o">==</span> <span class="s1">&#39;sphere&#39;</span><span class="p">:</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="p">),</span> <span class="n">M</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">M</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># return np.linalg.lstsq(M[~mask], z[~mask], rcond=None)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">toc</span> <span class="o">=</span> <span class="n">perf_counter_ns</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;applying </span><span class="si">{</span><span class="n">fit</span><span class="si">}</span><span class="s1"> least square fit to data (</span><span class="si">{</span><span class="p">(</span><span class="n">toc</span><span class="o">-</span><span class="n">tic</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-6</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">ms)&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="Surface.plane_removal"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Surface.plane_removal">[docs]</a>    <span class="k">def</span> <span class="nf">plane_removal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auto_units</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">reload</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units_to_SI</span><span class="p">()</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meshgrid</span>
        <span class="n">pla</span> <span class="o">=</span> <span class="n">Surface</span><span class="o">.</span><span class="n">_fit2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="s1">&#39;plane&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">Surface</span><span class="o">.</span><span class="n">_plane2D</span><span class="p">(</span><span class="n">pla</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tilt_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilt_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">piston</span> <span class="o">=</span> <span class="n">pla</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">piston</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">piston</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tilt_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">tilt_x</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tilt_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">tilt_y</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rot_xy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">majcyl</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mincyl</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span> <span class="o">=</span> <span class="s1">&#39;plane&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terms</span> <span class="o">=</span> <span class="s1">&#39;Tilt&#39;</span>
        <span class="k">if</span> <span class="n">auto_units</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auto_units</span><span class="p">()</span></div>
        <span class="c1"># return piston, tilt_x, tilt_y</span>

<div class="viewcode-block" id="Surface.cylinder_removal"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Surface.cylinder_removal">[docs]</a>    <span class="k">def</span> <span class="nf">cylinder_removal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auto_units</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">reload</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units_to_SI</span><span class="p">()</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meshgrid</span>
        <span class="n">cyl</span> <span class="o">=</span> <span class="n">Surface</span><span class="o">.</span><span class="n">_fit2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="s1">&#39;conic&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">Surface</span><span class="o">.</span><span class="n">_conic2D</span><span class="p">(</span><span class="n">cyl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">F</span> <span class="o">=</span> <span class="n">cyl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">B</span><span class="o">/</span><span class="p">(</span><span class="n">A</span><span class="o">-</span><span class="n">C</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">C</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">theta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">theta</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
            <span class="k">elif</span> <span class="n">theta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">theta</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rot_xy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">](</span><span class="n">theta</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">mrad</span><span class="p">)</span>
        <span class="n">Arot</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
              <span class="o">+</span> <span class="n">B</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
              <span class="o">+</span> <span class="n">C</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">majcyl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">](</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Arot</span><span class="p">),</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">Arot</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
              <span class="o">+</span> <span class="n">B</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
              <span class="o">+</span> <span class="n">C</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mincyl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">](</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Arot</span><span class="p">),</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tilt_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">](</span><span class="n">D</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tilt_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">](</span><span class="n">E</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">piston</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">](</span><span class="n">F</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span> <span class="o">=</span> <span class="s1">&#39;conic&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terms</span> <span class="o">=</span> <span class="s1">&#39;Cylinder &amp; Tilt&#39;</span>
        <span class="k">if</span> <span class="n">auto_units</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auto_units</span><span class="p">()</span></div>
        <span class="c1"># return piston, tilt_x, tilt_y, rot_xy, majcyl, mincyl</span>

<div class="viewcode-block" id="Surface.sphere_removal"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Surface.sphere_removal">[docs]</a>    <span class="k">def</span> <span class="nf">sphere_removal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auto_units</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">reload</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units_to_SI</span><span class="p">()</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meshgrid</span>
        <span class="n">sph</span> <span class="o">=</span> <span class="n">Surface</span><span class="o">.</span><span class="n">_fit2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="s1">&#39;sphere&#39;</span><span class="p">)</span>
        <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">sph</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">](</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">A</span><span class="p">),</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tilt_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">](</span><span class="n">B</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tilt_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;angle&#39;</span><span class="p">](</span><span class="n">C</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">piston</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">](</span><span class="n">D</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">Surface</span><span class="o">.</span><span class="n">_sphere2D</span><span class="p">(</span><span class="n">sph</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rot_xy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">majcyl</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mincyl</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span> <span class="o">=</span> <span class="s1">&#39;sphere&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terms</span> <span class="o">=</span> <span class="s1">&#39;Sphere &amp; Tilt&#39;</span>
        <span class="k">if</span> <span class="n">auto_units</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auto_units</span><span class="p">()</span></div>
        <span class="c1"># return piston, tilt_x, tilt_y, curv</span>

    <span class="c1"># ----export----</span>
<div class="viewcode-block" id="Surface.writeMetroprofile"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Surface.writeMetroprofile">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">writeMetroprofile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">frame_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phase_res</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        data heights array and pixel_size in meters,</span>
<span class="sd">        frame_size as tuple (width, height), data.shape by default</span>
<span class="sd">        phase_res: present in the Metropro file format v3, default 1 -&gt; 32768</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>
        <span class="kn">from</span> <span class="nn">PyLOSt.data_in.francois_esrf.zygo</span> <span class="kn">import</span> <span class="n">MetroProData</span>
        <span class="n">new_data</span> <span class="o">=</span> <span class="n">MetroProData</span><span class="p">()</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;header_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4096</span>
        <span class="c1"># new_data.header[&#39;swinfo.date&#39;] = dt.datetime.now().strftime(&#39;%a %b %d %H:%M:%S %Y&#39;)</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;time_stamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;file created from imported data&#39;</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;lateral_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixel_size</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">_raw_shape</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">new_data</span><span class="o">.</span><span class="n">_raw_shape</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;cn_width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">width</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;cn_height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">height</span>
        <span class="k">if</span> <span class="n">frame_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="n">frame_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="n">frame_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Frame size not consistent with the data size, input ignored!&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">frame_size</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ac_width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">width</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ac_height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">height</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;cn_n_bytes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">width</span><span class="o">*</span><span class="n">height</span><span class="o">*</span><span class="mi">4</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;camera_width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">width</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;camera_height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">height</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header_dict_to_class</span><span class="p">()</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">Surface</span><span class="p">((</span><span class="n">new_data</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">new_data</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">new_data</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="mf">6.327999813038332e-07</span><span class="p">)</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;wavelength_in&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">W</span>
        <span class="n">S</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;intf_scale_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span>
        <span class="n">O</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;obliquity_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">O</span>
        <span class="n">R</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4096</span><span class="p">,</span> <span class="mi">32768</span><span class="p">,</span> <span class="mi">131072</span><span class="p">]</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;phase_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_res</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="n">R</span><span class="p">[</span><span class="n">phase_res</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">W</span> <span class="o">*</span> <span class="n">S</span> <span class="o">*</span> <span class="n">O</span><span class="p">)</span>
        <span class="n">new_data</span><span class="o">.</span><span class="n">writefile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  data saved in MetroPro format (</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">).&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_data</span></div>

    <span class="c1"># ----roughness----</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ra</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">))</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_size</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rms</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pv</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rsk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_size</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rq</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rku</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_size</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rq</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filt_rz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>

<div class="viewcode-block" id="Surface.filt_rz"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Surface.filt_rz">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">filt_rz</span><span class="p">(</span><span class="n">surfacedata</span><span class="p">,</span> <span class="n">num_pts</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">surfacedata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">window</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">window</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;rz calc: invalid data&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">window</span> <span class="o">=</span> <span class="n">window</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">*</span><span class="n">window</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">*</span><span class="n">window</span><span class="p">),</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
        <span class="n">hi</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lo</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_pts</span><span class="p">):</span> <span class="c1"># pylint: disable=unused-variable</span>
            <span class="n">iloc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">hi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">iloc</span><span class="p">])</span>
            <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">iloc</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span> <span class="c1"># pylint: disable=unbalanced-tuple-unpacking</span>
            <span class="n">locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">(</span>
                <span class="p">((</span><span class="n">row</span> <span class="o">+</span> <span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="p">(</span><span class="n">col</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()),</span>
                <span class="n">shape</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;clip&#39;</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">locs</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">iloc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmin</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">lo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">iloc</span><span class="p">])</span>
            <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">iloc</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span> <span class="c1"># pylint: disable=unbalanced-tuple-unpacking</span>
            <span class="n">locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">(</span>
                <span class="p">((</span><span class="n">row</span> <span class="o">+</span> <span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="p">(</span><span class="n">col</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()),</span>
                <span class="n">shape</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;clip&#39;</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">locs</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">rz</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">hi</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">lo</span><span class="p">))</span><span class="o">/</span><span class="n">num_pts</span>
        <span class="c1"># del data</span>
        <span class="k">return</span> <span class="n">rz</span></div>

    <span class="c1"># ----z scale----</span>
<div class="viewcode-block" id="Surface.calc_colormap"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Surface.calc_colormap">[docs]</a>    <span class="k">def</span> <span class="nf">calc_colormap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        <span class="n">colorscale</span> <span class="o">=</span> <span class="n">Surface</span><span class="o">.</span><span class="n">ColorScale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">colorscale</span><span class="o">.</span><span class="n">cmap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap_prms</span> <span class="o">=</span> <span class="n">colorscale</span><span class="o">.</span><span class="n">cmap_prms</span>
        <span class="c1"># print(colorscale)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap_prms</span></div>

<div class="viewcode-block" id="Surface.ColorScale"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Surface.ColorScale">[docs]</a>    <span class="k">class</span> <span class="nc">ColorScale</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        base: &#39;ra&#39;, &#39;rq&#39;, &#39;pv&#39;, &#39;fixed&#39;</span>
<span class="sd">        params: list</span>
<span class="sd">            if stats based:  &#39;zfac&#39; as stretching factor (&lt;0 to force default)</span>
<span class="sd">            if manual scale: &#39;zmin, zmax, z_lo, z_hi&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">surface</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;turbo&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lut</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">=</span> <span class="n">surface</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmap_prms</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cmap&#39;</span><span class="p">:</span> <span class="n">cmap</span><span class="p">,</span> <span class="s1">&#39;base&#39;</span><span class="p">:</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="s1">&#39;ra&#39;</span><span class="p">)}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span> <span class="n">new_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmap_prms</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_params</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># return str(self.cmap_prms)</span>
            <span class="n">string</span> <span class="o">=</span> <span class="s1">&#39;ColorScale:&#39;</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap_prms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;0.3f&#39;</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;s&#39;</span>
                <span class="n">string</span>  <span class="o">=</span> <span class="n">string</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">value</span><span class="si">:{</span><span class="n">fmt</span><span class="si">}}</span><span class="s1">&#39;</span>
            <span class="k">return</span> <span class="n">string</span>

        <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;zfac&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span> <span class="c1"># force default</span>
                <span class="n">params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;zfac&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
            <span class="n">new_params</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s1">_based&#39;</span><span class="p">)(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
            <span class="n">new_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;zfac&#39;</span><span class="p">,</span> <span class="s1">&#39;zmin&#39;</span><span class="p">,</span> <span class="s1">&#39;zmax&#39;</span><span class="p">,</span> <span class="s1">&#39;z_lo&#39;</span><span class="p">,</span> <span class="s1">&#39;z_hi&#39;</span><span class="p">],</span> <span class="n">new_params</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_cmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lut</span><span class="p">,</span> <span class="o">**</span><span class="n">new_params</span><span class="p">),</span> <span class="n">new_params</span>

        <span class="k">def</span> <span class="nf">_ra_based</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zfac</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
            <span class="n">ra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="o">.</span><span class="n">ra</span>
            <span class="n">rq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="o">.</span><span class="n">rq</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="o">.</span><span class="n">automasking</span><span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">rq</span><span class="p">)</span>
            <span class="n">median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">z_lo</span> <span class="o">=</span> <span class="o">-</span><span class="n">zfac</span> <span class="o">*</span> <span class="n">ra</span> <span class="o">+</span> <span class="n">median</span>
            <span class="n">z_hi</span> <span class="o">=</span> <span class="n">zfac</span> <span class="o">*</span> <span class="n">ra</span> <span class="o">+</span> <span class="n">median</span>
            <span class="k">return</span> <span class="n">zfac</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">z_lo</span><span class="p">,</span> <span class="n">z_hi</span>

        <span class="k">def</span> <span class="nf">_rq_based</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zfac</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
            <span class="n">rq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="o">.</span><span class="n">rq</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="o">.</span><span class="n">automasking</span><span class="p">(</span><span class="mf">6.0</span><span class="o">*</span><span class="n">rq</span><span class="p">)</span>
            <span class="n">median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">z_lo</span> <span class="o">=</span> <span class="o">-</span><span class="n">zfac</span> <span class="o">*</span> <span class="n">rq</span> <span class="o">+</span> <span class="n">median</span>
            <span class="n">z_hi</span> <span class="o">=</span> <span class="n">zfac</span> <span class="o">*</span> <span class="n">rq</span> <span class="o">+</span> <span class="n">median</span>
            <span class="k">return</span> <span class="n">zfac</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">z_lo</span><span class="p">,</span> <span class="n">z_hi</span>

        <span class="k">def</span> <span class="nf">_pv_based</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zfac</span><span class="o">=</span><span class="mf">12.0</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
            <span class="n">rq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="o">.</span><span class="n">rq</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="o">.</span><span class="n">rv</span>
            <span class="n">rp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="o">.</span><span class="n">rp</span>
            <span class="n">median</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="o">.</span><span class="n">median</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">zfac</span> <span class="o">*</span> <span class="n">rq</span><span class="o">/</span><span class="p">(</span><span class="n">rp</span><span class="o">-</span><span class="n">rv</span><span class="p">)</span>
            <span class="n">z_lo</span> <span class="o">=</span> <span class="o">-</span><span class="n">ratio</span> <span class="o">*</span> <span class="n">rq</span> <span class="o">+</span> <span class="n">median</span>
            <span class="n">z_hi</span> <span class="o">=</span> <span class="n">ratio</span> <span class="o">*</span> <span class="n">rq</span> <span class="o">+</span> <span class="n">median</span>
            <span class="k">return</span> <span class="n">zfac</span><span class="p">,</span> <span class="n">rv</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">z_lo</span><span class="p">,</span> <span class="n">z_hi</span>

        <span class="k">def</span> <span class="nf">_fixed_based</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zfac</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">zfac</span><span class="p">,]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">zmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">negative</span><span class="p">(</span><span class="n">zfac</span><span class="p">)</span>
            <span class="n">zmax</span> <span class="o">=</span> <span class="n">zfac</span>
            <span class="n">median</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="o">.</span><span class="n">median</span>
            <span class="n">z_lo</span> <span class="o">=</span> <span class="mf">0.40</span> <span class="o">*</span> <span class="n">zmin</span> <span class="o">+</span> <span class="n">median</span>
            <span class="n">z_hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">negative</span><span class="p">(</span><span class="n">z_lo</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">zfac</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">,</span> <span class="n">z_lo</span><span class="p">,</span> <span class="n">z_hi</span>

        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">_calc_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">,</span> <span class="n">z_lo</span><span class="p">,</span> <span class="n">z_hi</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
            <span class="n">num</span> <span class="o">=</span> <span class="mi">240</span>
            <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">z_lo1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">z_lo</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">z_lo2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">z_lo</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">105</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">z_lo0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z_lo1</span><span class="p">,</span> <span class="n">z_lo2</span><span class="p">)</span>
            <span class="n">z_hi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">z_hi</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">85</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">z_hi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">z_hi</span><span class="p">,</span> <span class="n">zmax</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">z_hi0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z_hi1</span><span class="p">,</span> <span class="n">z_hi2</span><span class="p">)</span>
            <span class="n">new_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z_lo0</span><span class="p">,</span> <span class="n">z_hi0</span><span class="p">)</span>
            <span class="n">new_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">new_z</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">blue</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="n">num</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">green</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="n">num</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">red</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="n">num</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">new_cmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">new_z</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">blue</span><span class="p">),</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">new_z</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">green</span><span class="p">),</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">new_z</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">red</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
            <span class="k">return</span> <span class="n">lsc</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;veeco&#39;</span><span class="p">,</span> <span class="n">new_cmap</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span></div>


<div class="viewcode-block" id="Surface.plot"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Surface.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Matplotlib 2D plot with some additional functions.</span>

<span class="sd">            Parameters :</span>
<span class="sd">                &#39;title&#39; : string</span>

<span class="sd">                &#39;reverse&#39; : None,&#39;x&#39;, &#39;y&#39; or &#39;xy&#39;  (default None).</span>

<span class="sd">                colormap parameters to set the colormap (see ColorScale class):</span>
<span class="sd">                    &#39;base&#39;: &#39;ra&#39;, &#39;rq&#39;, &#39;pv&#39;, &#39;fixed&#39;</span>
<span class="sd">                    &#39;params&#39;: list</span>
<span class="sd">                        if stats based:  &#39;zfac&#39; as stretching factor</span>
<span class="sd">                        if manual scale: &#39;zmin, zmax, z_lo, z_hi&#39;</span>

<span class="sd">                matplotlib.axes.Axes.imshow arguments</span>
<span class="sd">                https://matplotlib.org/stable/api/_as_gen/matplotlib.axes.Axes.imshow.html</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">colorprms</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="s1">&#39;cmap&#39;</span><span class="p">,</span> <span class="s1">&#39;zfac&#39;</span><span class="p">,</span> <span class="s1">&#39;zmin&#39;</span><span class="p">,</span> <span class="s1">&#39;zmax&#39;</span><span class="p">,</span> <span class="s1">&#39;z_lo&#39;</span><span class="p">,</span> <span class="s1">&#39;z_hi&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">colorprms</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_colormap</span><span class="p">(</span><span class="o">**</span><span class="n">colorprms</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                <span class="n">origin</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;origin&#39;</span><span class="p">,</span> <span class="s1">&#39;lower&#39;</span><span class="p">),</span>
                <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
                <span class="n">vmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap_prms</span><span class="p">[</span><span class="s1">&#39;zmin&#39;</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap_prms</span><span class="p">[</span><span class="s1">&#39;zmax&#39;</span><span class="p">],</span>
                <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">reverse</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">reverse</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div></div>


<span class="c1"># ------------generic data class------------</span>
<div class="viewcode-block" id="Header"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.Header">[docs]</a><span class="k">class</span> <span class="nc">Header</span><span class="p">():</span>
    <span class="c1"># def __repr__(self):</span>
    <span class="c1">#     return self</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Header block&#39;</span></div>

<span class="k">def</span> <span class="nf">_iter_header_dict</span><span class="p">(</span><span class="n">dico</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dico</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">Header</span><span class="p">()</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>
            <span class="n">_iter_header_dict</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="ESRFOpticsLabData"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ESRFOpticsLabData">[docs]</a><span class="k">class</span> <span class="nc">ESRFOpticsLabData</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Common data class.&#39;&#39;&#39;</span>
    <span class="n">organisation</span> <span class="o">=</span> <span class="s2">&quot;ESRF&quot;</span>
    <span class="n">division</span> <span class="o">=</span> <span class="s1">&#39;ISDD&#39;</span>
    <span class="n">group</span> <span class="o">=</span> <span class="s2">&quot;XOG&quot;</span>
    <span class="n">laboratory</span> <span class="o">=</span> <span class="s2">&quot;Mirror &amp; Metrology Lab&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_steps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="p">{</span> <span class="c1"># as example</span>
                      <span class="s1">&#39;coords&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># must be present</span>
                      <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;angle&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="s1">&#39;pixel&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,}</span>

<div class="viewcode-block" id="ESRFOpticsLabData.read"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ESRFOpticsLabData.read">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span><span class="o">.</span><span class="n">readfile</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Error reading data (No such file).&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ESRFOpticsLabData</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span> <span class="c1"># pylint: disable=super-with-arguments</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initial</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  file </span><span class="se">\&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1"> opened.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="c1"># ----methods to be overrided----</span>
<div class="viewcode-block" id="ESRFOpticsLabData.readfile"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ESRFOpticsLabData.readfile">[docs]</a>    <span class="k">def</span> <span class="nf">readfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># pylint: disable=unused-argument</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s1">: </span><span class="se">\&#39;</span><span class="s1">readfile</span><span class="se">\&#39;</span><span class="s1"> function must be overrided.&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="c1"># ----common methods----</span>
<div class="viewcode-block" id="ESRFOpticsLabData.header_dict_to_class"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ESRFOpticsLabData.header_dict_to_class">[docs]</a>    <span class="k">def</span> <span class="nf">header_dict_to_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_iter_header_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div>

    <span class="c1"># ----analysis----</span>
<div class="viewcode-block" id="ESRFOpticsLabData.add_analysis_step"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ESRFOpticsLabData.add_analysis_step">[docs]</a>    <span class="k">def</span> <span class="nf">add_analysis_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">funcname</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">):</span>
        <span class="n">step</span> <span class="o">=</span> <span class="p">(</span><span class="n">funcname</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step</span><span class="p">)</span></div>

<div class="viewcode-block" id="ESRFOpticsLabData.analyze"><a class="viewcode-back" href="../../../../../pylost_widgets.scripts.general.ellipse_esrf.html#pylost_widgets.scripts.general.ellipse_esrf.generic.ESRFOpticsLabData.analyze">[docs]</a>    <span class="k">def</span> <span class="nf">analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">funcname</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_steps</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;      </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s1">: applying </span><span class="si">{</span><span class="n">funcname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">funcname</span><span class="p">)(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../index.html">pylost_widgets</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pylost_widgets.html">pylost_widgets package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>