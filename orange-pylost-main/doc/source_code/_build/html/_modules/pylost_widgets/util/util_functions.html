
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pylost_widgets.util.util_functions &#8212; pylost_widgets  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pylost_widgets.util.util_functions</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">cProfile</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pkgutil</span>
<span class="kn">import</span> <span class="nn">pstats</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">PyQt5</span> <span class="kn">import</span> <span class="n">uic</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtWidgets</span> <span class="kn">import</span> <span class="n">QFileDialog</span><span class="p">,</span> <span class="n">QDialog</span><span class="p">,</span> <span class="n">QAbstractItemView</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtWidgets</span> <span class="kn">import</span> <span class="n">QMessageBox</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.units</span> <span class="kn">import</span> <span class="n">Quantity</span>
<span class="kn">from</span> <span class="nn">line_profiler</span> <span class="kn">import</span> <span class="n">LineProfiler</span>
<span class="kn">from</span> <span class="nn">orangewidget.utils.filedialogs</span> <span class="kn">import</span> <span class="n">format_filter</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">cumtrapz</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp2d</span>
<span class="kn">from</span> <span class="nn">silx.gui.colors</span> <span class="kn">import</span> <span class="n">registerLUT</span><span class="p">,</span> <span class="n">Colormap</span>
<span class="kn">from</span> <span class="nn">silx.io.dictdump</span> <span class="kn">import</span> <span class="n">h5todict</span>

<span class="kn">from</span> <span class="nn">PyLOSt.algorithms.util.util_fit</span> <span class="kn">import</span> <span class="n">fit_nD</span><span class="p">,</span> <span class="n">getPixSz2D</span><span class="p">,</span> <span class="n">getXYGrid</span><span class="p">,</span> <span class="n">evalPoly</span>
<span class="kn">from</span> <span class="nn">PyLOSt.algorithms.util.util_integration_frankot_chellappa</span> <span class="kn">import</span> <span class="n">frankot_chellappa</span>
<span class="kn">from</span> <span class="nn">PyLOSt.algorithms.util.util_integration_sylvester</span> <span class="kn">import</span> <span class="n">g2s</span>
<span class="kn">from</span> <span class="nn">PyLOSt.databases.gs_table_classes</span> <span class="kn">import</span> <span class="n">Instruments</span><span class="p">,</span> <span class="n">connectDB</span><span class="p">,</span> <span class="n">ConfigParams</span>
<span class="kn">from</span> <span class="nn">pylost_widgets.util.DictionaryTree</span> <span class="kn">import</span> <span class="n">DictionaryTreeWidget</span>
<span class="kn">from</span> <span class="nn">pylost_widgets.util.MetrologyData</span> <span class="kn">import</span> <span class="n">MetrologyData</span>
<span class="kn">from</span> <span class="nn">pylost_widgets.util.cm_scaling</span> <span class="kn">import</span> <span class="n">ColorScale</span>
<span class="kn">from</span> <span class="nn">pylost_widgets.util.resource_path</span> <span class="kn">import</span> <span class="n">resource_path</span>
<span class="kn">from</span> <span class="nn">pylost_widgets.util.turbo_colormap_mpl</span> <span class="kn">import</span> <span class="n">turbo_colormap_data</span>

<span class="n">connectDB</span><span class="p">()</span>

<span class="c1">######################################################################################</span>
<span class="c1">## Common functions for all orange pylost widgets</span>
<span class="n">MODULE_MULTI</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;scan_data&#39;</span><span class="p">]</span> <span class="c1">#[&#39;stitch_data&#39;, &#39;scan_data&#39;]</span>
<span class="n">MODULE_SINGLE</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;custom&#39;</span><span class="p">]</span> <span class="c1">#[&#39;stitch_avg&#39;, &#39;scan_avg&#39;, &#39;custom&#39;]</span>

<div class="viewcode-block" id="run_line_profiler"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.run_line_profiler">[docs]</a><span class="k">def</span> <span class="nf">run_line_profiler</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run line_profiler on given function and print statistics.</span>

<span class="sd">    :param func: Function to run</span>
<span class="sd">    :type func: Callable</span>
<span class="sd">    :param params: Parameters to function</span>
<span class="sd">    :type params: dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lp</span> <span class="o">=</span> <span class="n">LineProfiler</span><span class="p">()</span>
    <span class="n">lp_wrapper</span> <span class="o">=</span> <span class="n">lp</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lp_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>
    <span class="n">lp</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span></div>

<div class="viewcode-block" id="start_profiler"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.start_profiler">[docs]</a><span class="k">def</span> <span class="nf">start_profiler</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start profiler for execution time analysis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">profiler</span> <span class="o">=</span> <span class="n">cProfile</span><span class="o">.</span><span class="n">Profile</span><span class="p">()</span>
    <span class="n">profiler</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">profiler</span></div>

<div class="viewcode-block" id="print_profiler"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.print_profiler">[docs]</a><span class="k">def</span> <span class="nf">print_profiler</span><span class="p">(</span><span class="n">profiler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print captured profier statistics.</span>

<span class="sd">    :param profiler: Python profiler</span>
<span class="sd">    :type profiler: cProfile.Profile</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">profiler</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">pstats</span><span class="o">.</span><span class="n">Stats</span><span class="p">(</span><span class="n">profiler</span><span class="p">)</span><span class="o">.</span><span class="n">sort_stats</span><span class="p">(</span><span class="s1">&#39;cumtime&#39;</span><span class="p">)</span>
    <span class="n">stats</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span></div>

<div class="viewcode-block" id="heights_to_metrologydata"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.heights_to_metrologydata">[docs]</a><span class="k">def</span> <span class="nf">heights_to_metrologydata</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="n">scan_vis</span><span class="p">,</span> <span class="n">pix_size</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If slopes are in MetrologyData format, apply its attributes to integrated heights numpy array and convert to MetrologyData format.</span>

<span class="sd">    :param scan: Input scan datasets</span>
<span class="sd">    :type scan: dict</span>
<span class="sd">    :param scan_vis: Output scan datasets with heights data</span>
<span class="sd">    :type scan_vis: dict</span>
<span class="sd">    :param pix_size: Pixel size</span>
<span class="sd">    :type pix_size: list[Quantity]</span>
<span class="sd">    :param x: Axis x positions</span>
<span class="sd">    :type x: Quantity/np.ndarray</span>
<span class="sd">    :param y: Axis y positions</span>
<span class="sd">    :type y: Quantity/np.ndarray</span>
<span class="sd">    :return: height array</span>
<span class="sd">    :rtype: MetrologyData</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scan</span><span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">],</span> <span class="n">MetrologyData</span><span class="p">)</span> <span class="ow">and</span> <span class="n">scan_vis</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scan_vis</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scan</span><span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy_to</span><span class="p">(</span><span class="n">scan_vis</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">])</span>
        <span class="n">unit_x</span> <span class="o">=</span> <span class="n">pix_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="k">if</span> <span class="n">pix_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pix_size</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pix_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">Quantity</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span><span class="p">)</span><span class="o">.</span><span class="n">unit</span>
        <span class="n">unit_x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">unit</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Quantity</span><span class="p">)</span> <span class="k">else</span> <span class="n">unit_x</span>
        <span class="n">scan_vis</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_set_unit</span><span class="p">(</span>
            <span class="n">scan</span><span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">dimensionless_angles</span><span class="p">())</span> <span class="o">*</span> <span class="n">unit_x</span><span class="p">)</span>
        <span class="n">scan_vis</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scan_vis</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;nm&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scan_vis</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="slopes_to_metrologydata"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.slopes_to_metrologydata">[docs]</a><span class="k">def</span> <span class="nf">slopes_to_metrologydata</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="n">scan_vis</span><span class="p">,</span> <span class="n">pix_size</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If heights are in MetrologyData format, apply its attributes to differentiated slopes numpy arrays and convert to MetrologyData format.</span>

<span class="sd">    :param scan: Input scan datasets</span>
<span class="sd">    :type scan: dict</span>
<span class="sd">    :param scan_vis: Output scan datasets with slopes data</span>
<span class="sd">    :type scan_vis: dict</span>
<span class="sd">    :param pix_size: Pixel size</span>
<span class="sd">    :type pix_size: list[Quantity]</span>
<span class="sd">    :param x: Axis x positions</span>
<span class="sd">    :type x: Quantity/np.ndarray</span>
<span class="sd">    :param y: Axis y positions</span>
<span class="sd">    :type y: Quantity/np.ndarray</span>
<span class="sd">    :return: slopes x array, slopes y array</span>
<span class="sd">    :rtype: MetrologyData, MetrologyData</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">unit_x</span> <span class="o">=</span> <span class="n">pix_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="k">if</span> <span class="n">pix_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pix_size</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pix_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">Quantity</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span><span class="p">)</span><span class="o">.</span><span class="n">unit</span>
    <span class="n">unit_x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">unit</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Quantity</span><span class="p">)</span> <span class="k">else</span> <span class="n">unit_x</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scan</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span> <span class="n">MetrologyData</span><span class="p">)</span> <span class="ow">and</span> <span class="n">scan_vis</span><span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scan_vis</span><span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scan</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy_to</span><span class="p">(</span><span class="n">scan_vis</span><span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">])</span>
        <span class="n">scan_vis</span><span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_set_unit</span><span class="p">(</span><span class="n">scan</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">/</span> <span class="n">unit_x</span><span class="p">)</span>
        <span class="n">scan_vis</span><span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scan_vis</span><span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;urad&#39;</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">dimensionless_angles</span><span class="p">())</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scan</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span> <span class="n">MetrologyData</span><span class="p">)</span> <span class="ow">and</span> <span class="n">scan_vis</span><span class="p">[</span><span class="s1">&#39;slopes_y&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scan_vis</span><span class="p">[</span><span class="s1">&#39;slopes_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scan</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy_to</span><span class="p">(</span><span class="n">scan_vis</span><span class="p">[</span><span class="s1">&#39;slopes_y&#39;</span><span class="p">])</span>
        <span class="n">scan_vis</span><span class="p">[</span><span class="s1">&#39;slopes_y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_set_unit</span><span class="p">(</span><span class="n">scan</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span> <span class="o">/</span> <span class="n">unit_x</span><span class="p">)</span>
        <span class="n">scan_vis</span><span class="p">[</span><span class="s1">&#39;slopes_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scan_vis</span><span class="p">[</span><span class="s1">&#39;slopes_y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;urad&#39;</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">dimensionless_angles</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">scan_vis</span><span class="p">[</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">],</span> <span class="n">scan_vis</span><span class="p">[</span><span class="s1">&#39;slopes_y&#39;</span><span class="p">]</span></div>
<span class="c1">########################################################################################</span>

<div class="viewcode-block" id="format_nanarr"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.format_nanarr">[docs]</a><span class="k">def</span> <span class="nf">format_nanarr</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If all elements of an array are nan&#39;s replace them with zeros.</span>

<span class="sd">    :param arr: Input array</span>
<span class="sd">    :type arr: np.ndarray</span>
<span class="sd">    :return: Formatted array</span>
<span class="sd">    :rtype: np.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">arr</span><span class="p">)):</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">arr</span></div>

<div class="viewcode-block" id="plot_win_colormap"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.plot_win_colormap">[docs]</a><span class="k">def</span> <span class="nf">plot_win_colormap</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="s1">&#39;ra&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate colormap based on &#39;turbo&#39; colormap. The new map is rescaled based on image data rms or mad given by base.</span>

<span class="sd">    :param image_data: Image data</span>
<span class="sd">    :type image_data: MetrologyData/np.ndarray</span>
<span class="sd">    :param factor: Factor used in rescaling colormap data</span>
<span class="sd">    :type factor: float</span>
<span class="sd">    :param base: Base option in [&#39;ra&#39;, &#39;rq&#39;, &#39;pv&#39;]. For &#39;ra&#39;, rescaled within mean absolute deviation value from median, whereas for &#39;rq&#39; rms limits are used</span>
<span class="sd">    :type base: str</span>
<span class="sd">    :return: Colormap of type turbo_{base}</span>
<span class="sd">    :rtype: Colormap</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">registerLUT</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;turbo&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">turbo_colormap_data</span><span class="p">)</span>
        <span class="n">colormap</span> <span class="o">=</span> <span class="n">Colormap</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;turbo&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">MetrologyData</span><span class="p">):</span>
            <span class="n">image_data</span> <span class="o">=</span> <span class="n">image_data</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">return</span> <span class="s1">&#39;turbo&#39;</span>
        <span class="n">image_data</span> <span class="o">=</span> <span class="n">image_data</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">image_data</span><span class="p">)]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({})</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">factor</span> <span class="k">if</span> <span class="n">factor</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">2.0</span>
        <span class="n">c</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ColorScale</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="n">factor</span><span class="p">)</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">factor</span> <span class="k">if</span> <span class="n">factor</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">3.0</span>
        <span class="n">c</span><span class="p">[</span><span class="s1">&#39;rq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ColorScale</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="s1">&#39;rq&#39;</span><span class="p">,</span> <span class="n">factor</span><span class="p">)</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">factor</span> <span class="k">if</span> <span class="n">factor</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">12.0</span>
        <span class="n">c</span><span class="p">[</span><span class="s1">&#39;pv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ColorScale</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="s1">&#39;pv&#39;</span><span class="p">,</span> <span class="n">factor</span><span class="p">)</span>
        <span class="n">registerLUT</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;turbo_ra&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
        <span class="n">registerLUT</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;turbo_rq&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;rq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
        <span class="n">registerLUT</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;turbo_pv&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;pv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cmap</span><span class="p">)</span>
        <span class="n">colormap</span> <span class="o">=</span> <span class="n">Colormap</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;turbo_&#39;</span><span class="o">+</span><span class="n">base</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="n">base</span><span class="p">]</span><span class="o">.</span><span class="n">cmap_prms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="n">base</span><span class="p">]</span><span class="o">.</span><span class="n">cmap_prms</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">colormap</span>
    <span class="k">return</span> <span class="n">colormap</span></div>

<div class="viewcode-block" id="copy_items"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.copy_items">[docs]</a><span class="k">def</span> <span class="nf">copy_items</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">deepcopy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">copydata</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Copy items from dictionary a to b. This does not create copy of arrays by default, lists or other python data. It only creates new references where possible.</span>

<span class="sd">    :param a: Source dictionary</span>
<span class="sd">    :type a: dict</span>
<span class="sd">    :param b: Destination dictionary</span>
<span class="sd">    :type b: dict</span>
<span class="sd">    :param deepcopy: Deepcopy recursively</span>
<span class="sd">    :type deepcopy: bool</span>
<span class="sd">    :param copydata: Create duplicate copies of numpy arrays with default data names (e.g slopes_x)</span>
<span class="sd">    :type copydata: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">deepcopy</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>
                    <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">elif</span> <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
                    <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">copy_items</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="n">deepcopy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">copydata</span> <span class="ow">and</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">DEFAULT_DATA_NAMES</span><span class="p">)</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]:</span>
                    <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">copydata</span> <span class="ow">and</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">DEFAULT_DATA_NAMES</span><span class="p">)</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]:</span>
                <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
                <span class="n">np</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">]</span></div>

<div class="viewcode-block" id="stack_dict"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.stack_dict">[docs]</a><span class="k">def</span> <span class="nf">stack_dict</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a_f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b_f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_pos_keys</span><span class="o">=</span><span class="p">[],</span> <span class="n">stack_selected_keys</span><span class="o">=</span><span class="p">[],</span> <span class="n">cam_size_keys</span><span class="o">=</span><span class="p">[],</span> <span class="n">merge_selected_keys</span><span class="o">=</span><span class="p">[],</span> <span class="n">start_pos</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stack dictionary objects (e.g. while loading sequence of files). Only numpy arrays, lists or tuples are stacked.</span>

<span class="sd">    :param a: Input dictionary</span>
<span class="sd">    :type a: dict</span>
<span class="sd">    :param b: Output stacked dictionary</span>
<span class="sd">    :type b: dict</span>
<span class="sd">    :param a_f: Parent input dictionary. By default parent is the same as input dictionary. If dict elements are sub directories, stack_dict is called iteratively, and a_f transfers link to parent dictionary</span>
<span class="sd">    :type a_f: dict</span>
<span class="sd">    :param b_f: Parent output stacked dictionary</span>
<span class="sd">    :type b_f: dict</span>
<span class="sd">    :param start_pos_keys: Start position keys in the dictionary. When stacking two images of different sizes from same instrument, start position of the image relative to detector is used for the merger.</span>
<span class="sd">    :type start_pos_keys: list[str]</span>
<span class="sd">    :param stack_selected_keys: Stack selected keys in the dictionary, even if the values are not numpy arrays or lists. E.g. stack motor position, even though it may be a float for a single image</span>
<span class="sd">    :type stack_selected_keys: list[str]</span>
<span class="sd">    :param cam_size_keys: Camera size keys in the dictionary. If provided and the images match the camera size, start_pos_keys are ignored.</span>
<span class="sd">    :type cam_size_keys: list[str]</span>
<span class="sd">    :param merge_selected_keys: Merge selected keys instead of stack into list, e.g. stitching LTP where a scan is a sequence of subscans with overlaps and the final list of positions is merger of subscan positions</span>
<span class="sd">    :type merge_selected_keys: list[str]</span>
<span class="sd">    :param start_pos: Updated start position of Output stacked arrays</span>
<span class="sd">    :type start_pos: list[float]</span>
<span class="sd">    :return: start positions keys, current start position</span>
<span class="sd">    :rtype: list[str], list[float]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">a_f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">a_f</span> <span class="o">=</span> <span class="n">a</span>
    <span class="k">if</span> <span class="n">b_f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">b_f</span> <span class="o">=</span> <span class="n">b</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>
                <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">start_pos_keys</span><span class="p">,</span> <span class="n">start_pos</span> <span class="o">=</span> <span class="n">stack_dict</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">start_pos_keys</span><span class="p">,</span> <span class="n">stack_selected_keys</span><span class="p">,</span> <span class="n">cam_size_keys</span><span class="p">,</span> <span class="n">merge_selected_keys</span><span class="p">,</span> <span class="n">start_pos</span><span class="o">=</span><span class="n">start_pos</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">merge_selected_keys</span><span class="p">):</span>
                <span class="n">start_pos_keys</span><span class="p">,</span> <span class="n">start_pos</span> <span class="o">=</span> <span class="n">stack_nparrays</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a_f</span><span class="p">,</span> <span class="n">b_f</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">start_pos_keys</span><span class="p">,</span> <span class="n">cam_size_keys</span><span class="o">=</span><span class="n">cam_size_keys</span><span class="p">,</span> <span class="n">start_pos</span><span class="o">=</span><span class="n">start_pos</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">stack_selected_keys</span><span class="p">:</span>
                <span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">b</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
                    <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
                <span class="n">start_pos_keys</span><span class="p">,</span> <span class="n">start_pos</span> <span class="o">=</span> <span class="n">stack_nparrays</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a_f</span><span class="p">,</span> <span class="n">b_f</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">start_pos_keys</span><span class="p">,</span> <span class="n">cam_size_keys</span><span class="o">=</span><span class="n">cam_size_keys</span><span class="p">,</span> <span class="n">start_pos</span><span class="o">=</span><span class="n">start_pos</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">merge_selected_keys</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>
                    <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">])</span><span class="o">&gt;</span><span class="mf">0.01</span><span class="p">)]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>
                        <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">+=</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>
                        <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
                        <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>
                    <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">start_pos_keys</span><span class="p">,</span> <span class="n">start_pos</span></div>

<div class="viewcode-block" id="stack_nparrays"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.stack_nparrays">[docs]</a><span class="k">def</span> <span class="nf">stack_nparrays</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a_f</span><span class="p">,</span> <span class="n">b_f</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">start_pos_keys</span><span class="p">,</span> <span class="n">cam_size_keys</span><span class="o">=</span><span class="p">[],</span> <span class="n">start_pos</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stack numpy ndarrays. Output array b has shape (x,)+a.shape, where the new input a is attached at axis=0, to create final shape of (x+1,)+a.shape.</span>

<span class="sd">    :param a: Input dict</span>
<span class="sd">    :type a: dict</span>
<span class="sd">    :param b: Output stacked dict</span>
<span class="sd">    :type b: dict</span>
<span class="sd">    :param a_f: Parent input dictionary.</span>
<span class="sd">    :type a_f: dict</span>
<span class="sd">    :param b_f: Parent output stacked dictionary</span>
<span class="sd">    :type b_f: dict</span>
<span class="sd">    :param item: Selected key in the dictionary</span>
<span class="sd">    :type item: str</span>
<span class="sd">    :param start_pos_keys: Start position keys in the dictionary</span>
<span class="sd">    :type start_pos_keys: list[str]</span>
<span class="sd">    :param cam_size_keys: Camera size keys in the dictionary</span>
<span class="sd">    :type cam_size_keys: list[str]</span>
<span class="sd">    :param start_pos: Current start position of stacked output array</span>
<span class="sd">    :type start_pos: list[float]</span>
<span class="sd">    :return: start positions keys, current start position</span>
<span class="sd">    :rtype: list[str], list[float]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>
        <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">])):</span>
                <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span><span class="o">+</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">])):</span>
                <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">!=</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">start_pos_keys</span><span class="p">):</span>
                        <span class="n">start_pos_keys</span> <span class="o">=</span> <span class="s1">&#39;zeros&#39;</span>
                        <span class="c1">#####################</span>
                        <span class="c1">## Not working on another thread. Qt runs on main thread only</span>
                        <span class="c1">## Need to either talk to main thread with signal/slots, or imlement start position after loading</span>
                        <span class="c1"># val = questionMsgAdv(title=&#39;Shape mismatch&#39;, msg=&#39;Shapes of &quot;{}&quot; do not match in file sequence. &#39;</span>
                        <span class="c1">#                &#39;Press &quot;Yes&quot; to select start position, &quot;No&quot; to pad NaNs at end.&#39;.format(item))</span>
                        <span class="c1"># if val==2:</span>
                        <span class="c1">#     dialog = StartPosDialog(None, a_f, dim_pos=a[item].ndim)</span>
                        <span class="c1">#     if dialog.exec_():</span>
                        <span class="c1">#         if any(dialog.start_pos[&#39;pos&#39;]):</span>
                        <span class="c1">#             start_pos_keys = dialog.start_pos[&#39;pos&#39;]</span>
                        <span class="c1"># elif val==1:</span>
                        <span class="c1">#     start_pos_keys = &#39;zeros&#39;</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">cam_size_keys</span><span class="p">)</span> <span class="ow">and</span> <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">get_dict_item</span><span class="p">(</span><span class="n">a_f</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cam_size_keys</span><span class="p">]):</span>
                    <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">start_pos_keys</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">start_pos_keys</span> <span class="o">==</span> <span class="s1">&#39;zeros&#39;</span><span class="p">:</span>
                            <span class="n">pos_a</span> <span class="o">=</span> <span class="n">pos_b</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span>
                        <span class="k">elif</span> <span class="n">start_pos_keys</span> <span class="o">==</span> <span class="s1">&#39;met_start&#39;</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">pos_a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">start_position_pix</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="n">MetrologyData</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span>
                                <span class="n">pos_b</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">start_position_pix</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="n">MetrologyData</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                                <span class="n">pos_a</span> <span class="o">=</span> <span class="n">pos_b</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">pos_a</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_dict_item</span><span class="p">(</span><span class="n">a_f</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">start_pos_keys</span><span class="p">]</span>
                            <span class="n">pos_b</span> <span class="o">=</span> <span class="n">b_f</span><span class="p">[</span><span class="s1">&#39;start_pos&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;start_pos&#39;</span> <span class="ow">in</span> <span class="n">b_f</span> <span class="k">else</span> <span class="p">[</span><span class="n">get_dict_item</span><span class="p">(</span><span class="n">b_f</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">start_pos_keys</span><span class="p">]</span>
                        <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="n">start_pos</span> <span class="o">=</span> <span class="n">merge_arrays_at</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="n">pos_a</span><span class="p">,</span> <span class="n">pos_b</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">==</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">item</span><span class="p">])</span><span class="o">+</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">item</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">start_pos_keys</span><span class="p">,</span> <span class="n">start_pos</span></div>


<div class="viewcode-block" id="merge_arrays_at"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.merge_arrays_at">[docs]</a><span class="k">def</span> <span class="nf">merge_arrays_at</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">st_a</span><span class="p">,</span> <span class="n">st_b</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge two arrays at given start positions.</span>

<span class="sd">    :param a: Numpy array 1</span>
<span class="sd">    :type a: np.ndarray</span>
<span class="sd">    :param b: Numpy array 2</span>
<span class="sd">    :type b: np.ndarray</span>
<span class="sd">    :param st_a: Start position of array 1</span>
<span class="sd">    :type st_a: tuple</span>
<span class="sd">    :param st_b: Start position of array 2</span>
<span class="sd">    :type st_b: tuple</span>
<span class="sd">    :return: Merged array, start position of merged array</span>
<span class="sd">    :rtype: np.ndarray, tuple</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">st_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">st_a</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">st_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">st_b</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">en_a</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">st_a</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span>
        <span class="n">en_b</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">st_b</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span>
        <span class="n">pos_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">st_a</span><span class="p">,</span> <span class="n">st_b</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">la</span> <span class="o">=</span> <span class="n">st_a</span> <span class="o">-</span> <span class="n">pos_min</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="n">st_b</span> <span class="o">-</span> <span class="n">pos_min</span>
        <span class="n">pos_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">en_a</span><span class="p">,</span> <span class="n">en_b</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="n">pos_max</span> <span class="o">-</span> <span class="n">en_a</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="n">pos_max</span> <span class="o">-</span> <span class="n">en_b</span>
        <span class="n">ac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),)</span><span class="o">+</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">la</span><span class="p">,</span><span class="n">ra</span><span class="p">)),</span> <span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),)</span><span class="o">+</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span><span class="n">rb</span><span class="p">)),</span> <span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">bc</span><span class="p">,</span><span class="n">ac</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">pos_min</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">b</span><span class="p">,</span> <span class="kc">None</span></div>

<span class="n">qtCreatorFile</span> <span class="o">=</span> <span class="n">resource_path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;gui&quot;</span><span class="p">,</span> <span class="s2">&quot;dialog_data_tree.ui&quot;</span><span class="p">))</span> <span class="c1"># Enter file here.</span>
<span class="n">Ui_tree</span><span class="p">,</span> <span class="n">QtBaseClass</span> <span class="o">=</span> <span class="n">uic</span><span class="o">.</span><span class="n">loadUiType</span><span class="p">(</span><span class="n">qtCreatorFile</span><span class="p">)</span>
<div class="viewcode-block" id="StartPosDialog"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.StartPosDialog">[docs]</a><span class="k">class</span> <span class="nc">StartPosDialog</span><span class="p">(</span><span class="n">QDialog</span><span class="p">,</span> <span class="n">Ui_tree</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dim_pos</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start position key selection dialog, if no keys are provided by default,</span>
<span class="sd">        e.g. data = {</span>
<span class="sd">                        height = Array(m,n),</span>
<span class="sd">                        cn_org_x = 10,  &lt;-- start position key along X</span>
<span class="sd">                        cn_org_y = 50,   &lt;-- start position key along Y</span>
<span class="sd">                        intensity = Array(m,n),</span>
<span class="sd">                        ...</span>
<span class="sd">                    }</span>

<span class="sd">        :param parent: Parent objecy</span>
<span class="sd">        :type parent: QWidget</span>
<span class="sd">        :param data: Input dictionary data</span>
<span class="sd">        :type data: dict</span>
<span class="sd">        :param dim_pos: Number of keys or dimensions, default 2 for 2D images</span>
<span class="sd">        :type dim_pos: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">QDialog</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setupUi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_pos</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:[]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim_pos</span> <span class="o">=</span> <span class="n">dim_pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">setWordWrap</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s1">&#39;Data : start_pos e.g.(Y,X)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s1">&#39;Load start position&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__treeViewer</span> <span class="o">=</span> <span class="n">DictionaryTreeWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__treeViewer</span><span class="o">.</span><span class="n">itemClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">itemClick</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__treeViewer</span><span class="o">.</span><span class="n">updateDictionary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__treeViewer</span><span class="o">.</span><span class="n">setSelectionMode</span><span class="p">(</span><span class="n">QAbstractItemView</span><span class="o">.</span><span class="n">MultiSelection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__treeViewer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buttonBox</span><span class="o">.</span><span class="n">accepted</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accept</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buttonBox</span><span class="o">.</span><span class="n">rejected</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">)</span>

<div class="viewcode-block" id="StartPosDialog.itemClick"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.StartPosDialog.itemClick">[docs]</a>    <span class="k">def</span> <span class="nf">itemClick</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback from any click of the dictionary tree item. This method will update the start position keys.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">select</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__treeViewer</span><span class="o">.</span><span class="n">selectedItems</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">select</span><span class="p">)</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">dim_pos</span><span class="p">:</span>
            <span class="n">alertMsg</span><span class="p">(</span><span class="s1">&#39;Selection&#39;</span><span class="p">,</span> <span class="s1">&#39;Please select only </span><span class="si">{}</span><span class="s1"> item(s)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim_pos</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_pos</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pos&#39;</span><span class="p">:[]}</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">select</span><span class="p">:</span>
            <span class="n">seldata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__treeViewer</span><span class="o">.</span><span class="n">get_selected_data</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_pos</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">seldata</span>
            <span class="n">pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_pos</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_pos</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s1">&#39;Data : start pos = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_pos</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s1">&#39;Data : start_pos e.g.(Y,X)&#39;</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="has_key_in_dict"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.has_key_in_dict">[docs]</a><span class="k">def</span> <span class="nf">has_key_in_dict</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the given key is present in the dictionary or its sub dictionaries.</span>

<span class="sd">    :param key: Key to search</span>
<span class="sd">    :type key: str</span>
<span class="sd">    :param data: Input dictionary data</span>
<span class="sd">    :type data: dict</span>
<span class="sd">    :return: True if the key is present else False</span>
<span class="sd">    :rtype: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">item</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">has_key_in_dict</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">item</span><span class="p">]):</span>
                <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="walk_dict_by_type"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.walk_dict_by_type">[docs]</a><span class="k">def</span> <span class="nf">walk_dict_by_type</span><span class="p">(</span><span class="n">dataset_type</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Walk through dictionary and its subdictionaries, and return all the item paths of given datatype.</span>

<span class="sd">    :param dataset_type: Type of dataset to search</span>
<span class="sd">    :type dataset_type: class types</span>
<span class="sd">    :param data: Input dictionary data</span>
<span class="sd">    :type data: dict</span>
<span class="sd">    :param path: Path in the dictionary. It is passed in function parameters to use while iteration of subdictionaries</span>
<span class="sd">    :type path: list[str]</span>
<span class="sd">    :return: List of paths to items of given type</span>
<span class="sd">    :rtype: list[str]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">retArr</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">item</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">walk_dict</span><span class="p">(</span><span class="n">dataset_type</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">out</span><span class="p">):</span>
                <span class="n">retArr</span> <span class="o">+=</span> <span class="n">out</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">item</span><span class="p">])</span> <span class="ow">is</span> <span class="n">dataset_type</span><span class="p">:</span>
            <span class="n">retArr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">retArr</span></div>

<div class="viewcode-block" id="walk_dict"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.walk_dict">[docs]</a><span class="k">def</span> <span class="nf">walk_dict</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Walk through dictionary and its subdictionaries, and return all items with given key.</span>

<span class="sd">    :param key: Key to search</span>
<span class="sd">    :type key: str</span>
<span class="sd">    :param data: Input dictionary data</span>
<span class="sd">    :type data: dict</span>
<span class="sd">    :param path: Path in the dictionary. It is passed in function parameters to use while iteration of subdictionaries</span>
<span class="sd">    :type path: list[str]</span>
<span class="sd">    :return: List of paths to items of given key name</span>
<span class="sd">    :rtype: list[str]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">retArr</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">def_path</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">retArr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">item</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">walk_dict</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">out</span><span class="p">):</span>
                <span class="n">retArr</span> <span class="o">+=</span> <span class="n">out</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">def_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">retArr</span></div>

<div class="viewcode-block" id="fill_dict"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.fill_dict">[docs]</a><span class="k">def</span> <span class="nf">fill_dict</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fill dictionary by given value at given path. Path is a list with first item linked to dictionray, second item linked to subdictionary and so on.</span>

<span class="sd">    Last item in the path is the actual key name</span>
<span class="sd">    :param data: Input dictionary data</span>
<span class="sd">    :type data: dict</span>
<span class="sd">    :param path: Path in list format</span>
<span class="sd">    :type path: list[str]</span>
<span class="sd">    :param value: Value to insert/replace</span>
<span class="sd">    :type value:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;data[&quot;</span><span class="si">{}</span><span class="s1">&quot;]=value&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;&quot;][&quot;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span></div>

<div class="viewcode-block" id="get_dict_item"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.get_dict_item">[docs]</a><span class="k">def</span> <span class="nf">get_dict_item</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get dictionary item at given path. Path is a list with first item linked to dictionray, second item linked to subdictionary and so on</span>
<span class="sd">    Last item in the path is the actual key name.</span>

<span class="sd">    :param data: Input dictionary data</span>
<span class="sd">    :type data: dict</span>
<span class="sd">    :param path: Path in list format</span>
<span class="sd">    :type path: list[str]</span>
<span class="sd">    :return: Selected data</span>
<span class="sd">    :rtype:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">walk_dict</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="p">[])</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">out</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">data_sel</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">data_sel</span> <span class="o">=</span> <span class="n">data_sel</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">data_sel</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="get_import_data_names"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.get_import_data_names">[docs]</a><span class="k">def</span> <span class="nf">get_import_data_names</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get IMPORT_DATA_NAMES from the ConfigParams sql table. Import names are used in File loader widget, for a standard naming convention.</span>
<span class="sd">    e.g. slopes --&gt; slopes_x, px --&gt; pix_size.</span>

<span class="sd">    :return: List of import data names</span>
<span class="sd">    :rtype: list[str]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">qnames</span> <span class="o">=</span> <span class="n">ConfigParams</span><span class="o">.</span><span class="n">selectBy</span><span class="p">(</span><span class="n">paramName</span><span class="o">=</span><span class="s1">&#39;IMPORT_DATA_NAMES&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">qnames</span><span class="o">.</span><span class="n">paramValue</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="get_default_data_names"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.get_default_data_names">[docs]</a><span class="k">def</span> <span class="nf">get_default_data_names</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get DEFAULT_DATA_NAMES from the ConfigParams sql table. e.g. slopes_x, slopes_y, height.</span>
<span class="sd">    Default data names are processed or displayed in orange pylost widgets.</span>

<span class="sd">    :return: List of default data names</span>
<span class="sd">    :rtype: list[str]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">qdef_names</span> <span class="o">=</span> <span class="n">ConfigParams</span><span class="o">.</span><span class="n">selectBy</span><span class="p">(</span><span class="n">paramName</span><span class="o">=</span><span class="s1">&#39;DEFAULT_DATA_NAMES&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">qdef_names</span><span class="o">.</span><span class="n">paramValue</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<span class="n">DEFAULT_DATA_NAMES</span> <span class="o">=</span> <span class="n">get_default_data_names</span><span class="p">()</span>

<div class="viewcode-block" id="get_setup_from_h5"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.get_setup_from_h5">[docs]</a><span class="k">def</span> <span class="nf">get_setup_from_h5</span><span class="p">(</span><span class="n">h5Obj</span><span class="p">,</span> <span class="n">setup</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load stitching setup data from h5 object.</span>

<span class="sd">    :param h5Obj: H5 object</span>
<span class="sd">    :type h5Obj: H5Group</span>
<span class="sd">    :param setup: Stitching setup to load</span>
<span class="sd">    :type setup: str</span>
<span class="sd">    :return: dictionary of setup data</span>
<span class="sd">    :rtype: dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">h5Obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">setup</span> <span class="ow">in</span> <span class="n">h5Obj</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">h5todict</span><span class="p">(</span><span class="n">h5Obj</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">setup</span><span class="p">)</span></div>

<div class="viewcode-block" id="differentiate_heights"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.differentiate_heights">[docs]</a><span class="k">def</span> <span class="nf">differentiate_heights</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pix_sz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;grad&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Differentiate heights to get slopes, along last one (if curves) or two dimensions (if images).</span>

<span class="sd">    :param z: Height array (numpy ndarray or MetrologyData)</span>
<span class="sd">    :type z: np.ndarray / MetrologyData</span>
<span class="sd">    :param x: X positions</span>
<span class="sd">    :type x: np.ndarray</span>
<span class="sd">    :param y: Y positions</span>
<span class="sd">    :type y: np.ndarray</span>
<span class="sd">    :param pix_sz: Pixel size</span>
<span class="sd">    :type pix_sz: list[Quantity]</span>
<span class="sd">    :param method: Derivation method, default &#39;grad&#39;, options [&#39;grad&#39;, &#39;diff&#39;]</span>
<span class="sd">    :type method: str</span>
<span class="sd">    :return: slopes_x (numpy ndarray or MetrologyData), slopes_y (numpy ndarray or MetrologyData)</span>
<span class="sd">    :rtype: MetrologyData, MetrologyData</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pix_sz</span> <span class="o">=</span> <span class="n">getPixSz2D</span><span class="p">(</span><span class="n">pix_sz</span><span class="p">)</span>
    <span class="n">sx</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sy</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;grad&#39;</span><span class="p">:</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">pix_sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">pix_sz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">y</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">Quantity</span><span class="p">):</span>
            <span class="n">sx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">dx</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span><span class="o">.</span><span class="n">unit</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dy</span><span class="p">,</span> <span class="n">Quantity</span><span class="p">):</span>
            <span class="n">sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">dy</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">dy</span><span class="o">.</span><span class="n">unit</span> <span class="k">if</span> <span class="n">z</span><span class="o">.</span><span class="n">ndim</span><span class="o">&gt;=</span><span class="mi">2</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">z</span><span class="o">.</span><span class="n">ndim</span><span class="o">&gt;=</span><span class="mi">2</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;diff&#39;</span><span class="p">:</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">pix_sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">pix_sz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">sx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">dx</span><span class="p">)</span>
        <span class="n">sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">),</span> <span class="n">dy</span><span class="p">)</span> <span class="k">if</span> <span class="n">z</span><span class="o">.</span><span class="n">ndim</span><span class="o">&gt;=</span><span class="mi">2</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">MetrologyData</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">sx</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span> <span class="k">if</span> <span class="n">sx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span> <span class="k">if</span> <span class="n">sy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">sy</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span></div>

<div class="viewcode-block" id="fit_nD_metrology"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.fit_nD_metrology">[docs]</a><span class="k">def</span> <span class="nf">fit_nD_metrology</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">pix_size</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtyp</span><span class="o">=</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit numpy ndarray with polynomial, ellipse, etc, and remove the fit.</span>

<span class="sd">    :param Z: nD Data to fit</span>
<span class="sd">    :type Z: np.ndarray / MetrologyData</span>
<span class="sd">    :param pix_size: Pixel size</span>
<span class="sd">    :type pix_sz: list[Quantity]</span>
<span class="sd">    :param dtyp: Data type in [&#39;height&#39;, &#39;slopes_x&#39;, &#39;slopes_y&#39;]</span>
<span class="sd">    :type dtyp: str</span>
<span class="sd">    :param kwargs: Additional arguments for the fit</span>
<span class="sd">    :type kwargs: dict</span>
<span class="sd">    :return: Coefficients of the fit, Fit residuals, Fit values</span>
<span class="sd">    :rtype: np.ndarray, MetrologyData, MetrologyData</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">Z</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">dim_detector</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span><span class="o">*</span><span class="n">Z</span><span class="o">.</span><span class="n">ndim</span>
    <span class="n">dim_detector</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">Z</span><span class="o">.</span><span class="n">ndim</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">dim_detector</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">MetrologyData</span><span class="p">):</span>
        <span class="n">pix_size</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">pix_size_detector</span>
        <span class="n">pix_size</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pix_size</span><span class="p">]</span>
        <span class="n">Zm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="c1"># Zscale = Zm.unit.si.scale</span>
        <span class="n">Zscale</span> <span class="o">=</span> <span class="n">Zm</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">dtyp</span><span class="o">==</span><span class="s1">&#39;height&#39;</span> <span class="k">else</span> <span class="n">Zm</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;rad&#39;</span><span class="p">)</span>  <span class="c1"># Assuming either heights or slopes</span>
        <span class="n">Zval</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">value</span>
        <span class="n">dim_detector</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">dim_detector</span>
        <span class="n">axis_vals</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">get_axis_val_items_detector</span><span class="p">()</span>
        <span class="n">pix_scale</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">get_pix_scale</span><span class="p">()</span>
        <span class="n">axis_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">axis_vals</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Zval</span> <span class="o">=</span> <span class="n">Z</span>
        <span class="n">pix_scale</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pix_size</span><span class="p">]</span>
        <span class="n">Zscale</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">axis_vals</span> <span class="o">=</span> <span class="p">[[]]</span><span class="o">*</span><span class="n">Z</span><span class="o">.</span><span class="n">ndim</span>

    <span class="n">Coeff_nD</span><span class="p">,</span> <span class="n">Zn</span><span class="p">,</span> <span class="n">Zn_fit</span> <span class="o">=</span> <span class="n">fit_nD</span><span class="p">(</span><span class="n">Zval</span><span class="p">,</span> <span class="n">pix_size</span><span class="o">=</span><span class="n">pix_size</span><span class="p">,</span> <span class="n">dim_detector</span><span class="o">=</span><span class="n">dim_detector</span><span class="p">,</span> <span class="n">pix_scale</span><span class="o">=</span><span class="n">pix_scale</span><span class="p">,</span> <span class="n">Zscale</span><span class="o">=</span><span class="n">Zscale</span><span class="p">,</span> <span class="n">dtyp</span><span class="o">=</span><span class="n">dtyp</span><span class="p">,</span> <span class="n">axis_vals</span><span class="o">=</span><span class="n">axis_vals</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">MetrologyData</span><span class="p">):</span>
        <span class="n">Zn</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">copy_to</span><span class="p">(</span><span class="n">Zn</span><span class="p">)</span>
        <span class="n">Zn_fit</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">copy_to</span><span class="p">(</span><span class="n">Zn_fit</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Coeff_nD</span><span class="p">,</span> <span class="n">Zn</span><span class="p">,</span> <span class="n">Zn_fit</span></div>

<div class="viewcode-block" id="integrate_slopes"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.integrate_slopes">[docs]</a><span class="k">def</span> <span class="nf">integrate_slopes</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pix_sz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">isShapeRemoved</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">interpolate_nans</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integrate slopes to heights. 1D integration of slopes_x, or 2D integration of slopes_x and slopes_y.</span>

<span class="sd">    :param sx: Slopes_x nd array</span>
<span class="sd">    :type sx: np.ndarray / MetrologyData</span>
<span class="sd">    :param sy: Slopes_y nd array</span>
<span class="sd">    :type sy: np.ndarray / MetrologyData</span>
<span class="sd">    :param x: X positions</span>
<span class="sd">    :type x: np.ndarray</span>
<span class="sd">    :param y: Y positions</span>
<span class="sd">    :type y: np.ndarray</span>
<span class="sd">    :param pix_sz: Pixel size</span>
<span class="sd">    :type pix_sz: list[Quantity]</span>
<span class="sd">    :param isShapeRemoved:  Is shape already removed (e.g. curvature for sperical/cylindrical mirror)</span>
<span class="sd">    :type isShapeRemoved: bool</span>
<span class="sd">    :param interpolate_nans: Interpolate nan values</span>
<span class="sd">    :type interpolate_nans: bool</span>
<span class="sd">    :param method: Integration method in [&#39;trapz&#39;, &#39;cumtrapz&#39;] for 1D curve integration, [&#39;frankot_chellappa&#39;, &#39;sylvester&#39;] for 2d integration</span>
<span class="sd">    :type method: str</span>
<span class="sd">    :return: Heights</span>
<span class="sd">    :rtype: np.ndarray / MetrologyData</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pix_sz</span> <span class="o">=</span> <span class="n">getPixSz2D</span><span class="p">(</span><span class="n">pix_sz</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Slopes_x object is not available.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">integrate_slopes_X</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">pix_sz</span><span class="o">=</span><span class="n">pix_sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sx</span><span class="o">.</span><span class="n">ndim</span><span class="o">!=</span><span class="n">sy</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Dimensions of slopes_x and slopes_y do not match&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">integrate_slopes_XY</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">pix_sz</span><span class="o">=</span><span class="n">pix_sz</span><span class="p">,</span> <span class="n">isShapeRemoved</span><span class="o">=</span><span class="n">isShapeRemoved</span><span class="p">,</span> <span class="n">interpolate_nans</span><span class="o">=</span><span class="n">interpolate_nans</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span></div>

<div class="viewcode-block" id="integrate_slopes_X"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.integrate_slopes_X">[docs]</a><span class="k">def</span> <span class="nf">integrate_slopes_X</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pix_sz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;trapz&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integrate slope curve(s) with 1D integration.</span>

<span class="sd">    :param sx: Slopes x nd array</span>
<span class="sd">    :type sx: np.ndarray / MetrologyData</span>
<span class="sd">    :param x: X positions</span>
<span class="sd">    :type x: np.ndarray</span>
<span class="sd">    :param pix_sz: Pixel size</span>
<span class="sd">    :type pix_sz: list[Quantity]</span>
<span class="sd">    :param method: Inegration method [&#39;trapz&#39;, &#39;cumtrapz&#39;]</span>
<span class="sd">    :type method: str</span>
<span class="sd">    :return: Heights</span>
<span class="sd">    :rtype: np.ndarray / MetrologyData</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">z</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;trapz&#39;</span><span class="p">,</span> <span class="s1">&#39;cumtrapz&#39;</span><span class="p">]:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">cumtrapz</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">pix_sz</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># uses dx if x is None, integrate along last dimention</span>
    <span class="k">return</span> <span class="n">z</span></div>

<div class="viewcode-block" id="integrate_slopes_XY"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.integrate_slopes_XY">[docs]</a><span class="k">def</span> <span class="nf">integrate_slopes_XY</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pix_sz</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">isShapeRemoved</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">interpolate_nans</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;frankot_chellappa&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integrate slopes_x, slopes_y images to heights with 2D integration. Remove polynomial degree 1 (i.e. curvature), before integration if not already removed.</span>

<span class="sd">    :param sx: Slopes x nd array</span>
<span class="sd">    :type sx: np.ndarray / MetrologyData</span>
<span class="sd">    :param sy: Slopes y nd array</span>
<span class="sd">    :type sy: np.ndarray / MetrologyData</span>
<span class="sd">    :param x: X positions</span>
<span class="sd">    :type x: np.ndarray</span>
<span class="sd">    :param y: Y positions</span>
<span class="sd">    :type y: np.ndarray</span>
<span class="sd">    :param pix_sz: Pixel size</span>
<span class="sd">    :type pix_sz: list[Quantity]</span>
<span class="sd">    :param isShapeRemoved:  Is shape already removed (e.g. curvature for sperical/cylindrical mirror)</span>
<span class="sd">    :type isShapeRemoved: bool</span>
<span class="sd">    :param interpolate_nans: Interpolate nan values</span>
<span class="sd">    :type interpolate_nans: bool</span>
<span class="sd">    :param method: Inegration method [&#39;frankot_chellappa&#39;, &#39;sylvester&#39;]</span>
<span class="sd">    :type method: str</span>
<span class="sd">    :return: Heights</span>
<span class="sd">    :rtype: np.ndarray / MetrologyData</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">z</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># integrate only residuals of plane fit, ideally shape should be removed e.g. ellipse</span>
    <span class="n">sx_resd</span> <span class="o">=</span> <span class="n">sx</span>
    <span class="n">sy_resd</span> <span class="o">=</span> <span class="n">sy</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">isShapeRemoved</span><span class="p">:</span>
        <span class="n">coef_x</span><span class="p">,</span> <span class="n">sx_resd</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">fit_nD_metrology</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">pix_size</span><span class="o">=</span><span class="n">pix_sz</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtyp</span><span class="o">=</span><span class="s1">&#39;slopes_x&#39;</span><span class="p">)</span>
        <span class="n">coef_y</span><span class="p">,</span> <span class="n">sy_resd</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">fit_nD_metrology</span><span class="p">(</span><span class="n">sy</span><span class="p">,</span> <span class="n">pix_size</span><span class="o">=</span><span class="n">pix_sz</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtyp</span><span class="o">=</span><span class="s1">&#39;slopes_y&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sx</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">sx</span><span class="o">*</span><span class="n">pix_sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">MetrologyData</span><span class="p">):</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;nm&#39;</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">dimensionless_angles</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndindex</span><span class="p">(</span><span class="n">sx</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">z</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">integrate_slopes_XY_2D</span><span class="p">(</span><span class="n">sx_resd</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">sy_resd</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">pix_sz</span><span class="o">=</span><span class="n">pix_sz</span><span class="p">,</span> <span class="n">interpolate_nans</span><span class="o">=</span><span class="n">interpolate_nans</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">sx</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">integrate_slopes_XY_2D</span><span class="p">(</span><span class="n">sx_resd</span><span class="p">,</span> <span class="n">sy_resd</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">pix_sz</span><span class="o">=</span><span class="n">pix_sz</span><span class="p">,</span> <span class="n">interpolate_nans</span><span class="o">=</span><span class="n">interpolate_nans</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">integrate_slopes_XY_2D</span><span class="p">(</span><span class="n">sx_resd</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">sy_resd</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">pix_sz</span><span class="o">=</span><span class="n">pix_sz</span><span class="p">,</span> <span class="n">interpolate_nans</span><span class="o">=</span><span class="n">interpolate_nans</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>

    <span class="c1">#TODO: add shape to z</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">isShapeRemoved</span><span class="p">:</span>
        <span class="n">cz</span> <span class="o">=</span> <span class="n">get_coef_z</span><span class="p">(</span><span class="n">coef_x</span><span class="p">,</span> <span class="n">coef_y</span><span class="p">)</span>
        <span class="n">xv</span><span class="p">,</span> <span class="n">yv</span> <span class="o">=</span> <span class="n">getXYGrid</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">pix_sz</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mask</span><span class="o">=~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">MetrologyData</span><span class="p">):</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">sx</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;rad&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">xv</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">z</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
            <span class="n">xv</span> <span class="o">=</span> <span class="n">xv</span><span class="o">.</span><span class="n">value</span>
            <span class="n">yv</span> <span class="o">=</span> <span class="n">yv</span><span class="o">.</span><span class="n">value</span>
            <span class="n">Zfit</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">evalPoly</span><span class="p">(</span><span class="n">cz</span><span class="p">,</span> <span class="n">xv</span><span class="p">,</span> <span class="n">yv</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nbVar</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">terms</span><span class="o">=</span><span class="p">[],</span> <span class="n">dtyp</span><span class="o">=</span><span class="s1">&#39;height&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">z</span><span class="o">.</span><span class="n">unit</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Zfit</span> <span class="o">=</span> <span class="n">evalPoly</span><span class="p">(</span><span class="n">cz</span><span class="p">,</span> <span class="n">xv</span><span class="p">,</span> <span class="n">yv</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nbVar</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">terms</span><span class="o">=</span><span class="p">[],</span> <span class="n">dtyp</span><span class="o">=</span><span class="s1">&#39;height&#39;</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">+</span> <span class="n">Zfit</span>
    <span class="k">return</span> <span class="n">z</span></div>

<div class="viewcode-block" id="get_coef_z"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.get_coef_z">[docs]</a><span class="k">def</span> <span class="nf">get_coef_z</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get polynomial fit coefficients of heights from fit coefficients of slopes.</span>

<span class="sd">    :param cx: Fit coefficients of slopes_x</span>
<span class="sd">    :type cx: np.ndarray</span>
<span class="sd">    :param cy: Fit coefficients of slopes_y</span>
<span class="sd">    :type cy: np.ndarray</span>
<span class="sd">    :return: Fit coefficients of heights</span>
<span class="sd">    :rtype: np.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># cx = l + my + nx, cy = o + py + qx</span>
    <span class="c1"># cz = 0 + oy + lx + p/2 y**2 + (m+q) xy + n/2 x**2</span>
    <span class="n">cx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span>
    <span class="n">cy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cy</span><span class="p">)</span>
    <span class="n">cz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="o">*</span><span class="n">cx</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">cz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cy</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">cz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">cz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cy</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">cz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">cy</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">cz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">cz</span></div>

<div class="viewcode-block" id="integrate_slopes_XY_2D"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.integrate_slopes_XY_2D">[docs]</a><span class="k">def</span> <span class="nf">integrate_slopes_XY_2D</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pix_sz</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">interpolate_nans</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;frankot_chellappa&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integrate slopes_x, slopes_y images to heights with 2D integration.</span>

<span class="sd">    :param sx: Slopes x nd array</span>
<span class="sd">    :type sx: np.ndarray / MetrologyData</span>
<span class="sd">    :param sy: Slopes y nd array</span>
<span class="sd">    :type sy: np.ndarray / MetrologyData</span>
<span class="sd">    :param x: X positions</span>
<span class="sd">    :type x: np.ndarray</span>
<span class="sd">    :param y: Y positions</span>
<span class="sd">    :type y: np.ndarray</span>
<span class="sd">    :param pix_sz: Pixel size</span>
<span class="sd">    :type pix_sz: list[Quantity]</span>
<span class="sd">    :param interpolate_nans: Interpolate nans</span>
<span class="sd">    :type interpolate_nans: bool</span>
<span class="sd">    :param method: Integration method in [&#39;frankot_chellappa&#39;, &#39;sylvester&#39;]</span>
<span class="sd">    :type method: str</span>
<span class="sd">    :return: Heights</span>
<span class="sd">    :rtype: np.ndarray / Quantity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">((</span><span class="n">sx</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">Quantity</span><span class="p">)</span> <span class="k">else</span> <span class="n">sx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">msk</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sy</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">msk</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">z</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">msk</span><span class="p">))</span>
    <span class="n">mn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">mn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="nb">slice</span><span class="p">(</span><span class="n">mn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="c1">#np.ix_(msk.any(axis=1),msk.any(axis=0))</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pix_sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Quantity</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pix_sz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Quantity</span><span class="p">):</span>
        <span class="n">pix_unit</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">unit</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pix_sz</span><span class="p">]</span>
        <span class="n">pix_sz</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">pix_unit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pix_sz</span><span class="p">]</span>
    <span class="n">sx_m</span> <span class="o">=</span> <span class="n">sx</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">Quantity</span><span class="p">)</span> <span class="k">else</span> <span class="n">sx</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
    <span class="n">sy_m</span> <span class="o">=</span> <span class="n">sy</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sy</span><span class="p">,</span> <span class="n">Quantity</span><span class="p">)</span> <span class="k">else</span> <span class="n">sy</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">sx_m</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">sy_m</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">z</span>

    <span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span> <span class="o">=</span> <span class="n">sx</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">nx</span><span class="p">)</span><span class="o">*</span><span class="n">pix_sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">ny</span><span class="p">)</span><span class="o">*</span><span class="n">pix_sz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x_m</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">y_m</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">interpolate_nans</span><span class="p">:</span>
        <span class="n">xx</span><span class="p">,</span><span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_m</span><span class="p">,</span> <span class="n">y_m</span><span class="p">)</span>
        <span class="n">sx_nans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sx_m</span><span class="p">)</span>
        <span class="n">sy_nans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sy_m</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sx_nans</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">interp2d</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="o">~</span><span class="n">sx_nans</span><span class="p">],</span><span class="n">yy</span><span class="p">[</span><span class="o">~</span><span class="n">sx_nans</span><span class="p">],</span><span class="n">sx_m</span><span class="p">[</span><span class="o">~</span><span class="n">sx_nans</span><span class="p">])</span>
            <span class="n">sx_m</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x_m</span><span class="p">,</span> <span class="n">y_m</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sy_nans</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">interp2d</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="o">~</span><span class="n">sy_nans</span><span class="p">],</span><span class="n">yy</span><span class="p">[</span><span class="o">~</span><span class="n">sy_nans</span><span class="p">],</span><span class="n">sy_m</span><span class="p">[</span><span class="o">~</span><span class="n">sy_nans</span><span class="p">])</span>
            <span class="n">sy_m</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x_m</span><span class="p">,</span> <span class="n">y_m</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;sylvester&#39;</span><span class="p">:</span>
        <span class="n">z</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">g2s</span><span class="p">(</span><span class="n">x_m</span><span class="p">,</span> <span class="n">y_m</span><span class="p">,</span> <span class="n">sx_m</span><span class="p">,</span> <span class="n">sy_m</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;frankot_chellappa&#39;</span><span class="p">:</span>
        <span class="n">z</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">pix_sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">pix_sz</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">frankot_chellappa</span><span class="p">(</span><span class="n">sx_m</span><span class="p">,</span> <span class="n">sy_m</span><span class="p">,</span> <span class="n">reflec_pad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">Quantity</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span><span class="o">*</span><span class="n">pix_unit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">sx</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;nm&#39;</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">dimensionless_angles</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">z</span></div>

<div class="viewcode-block" id="compare_shapes"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.compare_shapes">[docs]</a><span class="k">def</span> <span class="nf">compare_shapes</span><span class="p">(</span><span class="n">shp1</span><span class="p">,</span> <span class="n">shp2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare two shapes, returns True if all dimension sizes match. Dimensions with size 1 or none are ignored.</span>

<span class="sd">    :param shp1: Shape 1</span>
<span class="sd">    :type shp1: tuple</span>
<span class="sd">    :param shp2: Shape 2</span>
<span class="sd">    :type shp2: tuple</span>
<span class="sd">    :return: Boolean whether the shapes match</span>
<span class="sd">    :rtype: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shp1</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shp1</span><span class="p">)</span>
    <span class="n">shp2</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shp2</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shp1</span><span class="p">)</span><span class="o">&gt;</span><span class="nb">len</span><span class="p">(</span><span class="n">shp2</span><span class="p">):</span>
        <span class="n">shp2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shp1</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">shp2</span><span class="p">))</span><span class="o">+</span><span class="n">shp2</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">shp1</span><span class="p">)</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">shp2</span><span class="p">):</span>
        <span class="n">shp1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shp2</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">shp1</span><span class="p">))</span><span class="o">+</span><span class="n">shp1</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shp1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">shp2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">val</span><span class="o">==</span><span class="n">shp2</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="match_size"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.match_size">[docs]</a><span class="k">def</span> <span class="nf">match_size</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="n">scan_second</span><span class="p">,</span> <span class="n">scan_item</span><span class="p">,</span> <span class="n">second_item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Match sizes of two items (numpy arrays) and if they match return the second item. Else apply mask of start &amp; end positions to second item and return it.</span>

<span class="sd">    :param scan: Scan dictionary</span>
<span class="sd">    :type scan: dict</span>
<span class="sd">    :param scan_second: Second scan dictionary</span>
<span class="sd">    :type scan_second: dict</span>
<span class="sd">    :param scan_item: Scan item</span>
<span class="sd">    :type scan_item: np.ndarray</span>
<span class="sd">    :param second_item: Second scan item</span>
<span class="sd">    :type second_item: np.ndarray</span>
<span class="sd">    :return: Processed second item</span>
<span class="sd">    :rtype: np.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">compare_shapes</span><span class="p">(</span><span class="n">second_item</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">scan_item</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">second_item</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;full_size&#39;</span> <span class="ow">in</span> <span class="n">scan</span> <span class="ow">and</span> <span class="s1">&#39;start_pos&#39;</span> <span class="ow">in</span> <span class="n">scan</span> <span class="ow">and</span> <span class="s1">&#39;end_pos&#39;</span> <span class="ow">in</span> <span class="n">scan</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">questionMsg</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Shape mismatch&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Shapes mismatch. First dataset has mask applied. Click &quot;Yes&quot; to check if full shapes before mask match.&#39;</span><span class="p">):</span>
                <span class="n">shape_full</span> <span class="o">=</span> <span class="n">scan</span><span class="p">[</span><span class="s1">&#39;full_size&#39;</span><span class="p">]</span>
                <span class="n">st</span> <span class="o">=</span> <span class="n">scan</span><span class="p">[</span><span class="s1">&#39;start_pos&#39;</span><span class="p">]</span>
                <span class="n">en</span> <span class="o">=</span> <span class="n">scan</span><span class="p">[</span><span class="s1">&#39;end_pos&#39;</span><span class="p">]</span>
                <span class="n">shape_second</span> <span class="o">=</span> <span class="n">scan_second</span><span class="p">[</span><span class="s1">&#39;full_size&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;full_size&#39;</span> <span class="ow">in</span> <span class="n">scan_second</span> <span class="k">else</span> <span class="n">second_item</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">st_2</span> <span class="o">=</span> <span class="n">scan_second</span><span class="p">[</span><span class="s1">&#39;start_pos&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;start_pos&#39;</span> <span class="ow">in</span> <span class="n">scan_second</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
                <span class="n">en_2</span> <span class="o">=</span> <span class="n">scan_second</span><span class="p">[</span><span class="s1">&#39;end_pos&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;end_pos&#39;</span> <span class="ow">in</span> <span class="n">scan_second</span> <span class="k">else</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">st_2</span><span class="p">,</span> <span class="n">second_item</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="k">if</span> <span class="n">second_item</span><span class="o">.</span><span class="n">ndim</span><span class="o">&gt;</span><span class="mi">1</span> <span class="k">else</span> <span class="n">second_item</span><span class="o">.</span><span class="n">shape</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">compare_shapes</span><span class="p">(</span><span class="n">shape_full</span><span class="p">,</span> <span class="n">shape_second</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">scan_item</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">second_item</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">en</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">st_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">en</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">en_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Cannot apply mask of first data to second data. First data mask is outside the bounds of second data mask&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">en</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">scan_item</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Mask start &amp; end positions are not up to date with the scan data&#39;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">second_item</span><span class="p">[</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">st_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">en</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">st_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">scan_item</span><span class="o">.</span><span class="n">ndim</span><span class="o">&gt;=</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">second_item</span><span class="o">.</span><span class="n">ndim</span><span class="o">&gt;=</span><span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">en</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">st_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">en</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">en_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">st_2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">en</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">en_2</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Cannot apply mask of first data to second data. First data mask is outside the bounds of second data mask&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">en</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">scan_item</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">en</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">scan_item</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Mask start &amp; end positions are not up to date with the scan data&#39;</span><span class="p">)</span>
                        <span class="n">slc</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="n">second_item</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">slc</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="p">(</span><span class="n">second_item</span><span class="o">.</span><span class="n">ndim</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="n">slc</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">st_2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">en</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">st_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">st_2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">en</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">st_2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
                        <span class="n">second_item_mask</span> <span class="o">=</span> <span class="n">second_item</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">slc</span><span class="p">)]</span>
                        <span class="k">return</span> <span class="n">second_item_mask</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Shape mismatch between datasets&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Trying to apply mask data from first dataset. Full shape (before any mask) mismatch between two datasets&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Shape mismatch and no mask available in (first) scan data&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_mean_image"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.get_mean_image">[docs]</a><span class="k">def</span> <span class="nf">get_mean_image</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If number of data dimensions are &gt;2, it is averaged along all other except last two.</span>

<span class="sd">    :param data: Input data numpy nd array</span>
<span class="sd">    :type data: np.ndarray</span>
<span class="sd">    :return: Mean data, Mean data in original data shape</span>
<span class="sd">    :rtype: np.ndarray, np.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">slc</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">data_dim</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">slc</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_dim</span></div>

<div class="viewcode-block" id="get_data_from_h5"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.get_data_from_h5">[docs]</a><span class="k">def</span> <span class="nf">get_data_from_h5</span><span class="p">(</span><span class="n">h5Obj</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">data_obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get data from h5 object with given entry name.</span>

<span class="sd">    :param h5Obj: H5 object</span>
<span class="sd">    :type h5Obj: H5Group</span>
<span class="sd">    :param entry: Entry name</span>
<span class="sd">    :type entry: str</span>
<span class="sd">    :param data_obj: Input dictionary data reference</span>
<span class="sd">    :type data_obj: dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scans</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">h5Obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">h5msr</span> <span class="o">=</span> <span class="n">h5Obj</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span>
        <span class="n">details</span> <span class="o">=</span> <span class="n">get_instrument_details</span><span class="p">(</span><span class="n">h5msr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">details</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_obj</span><span class="p">[</span><span class="s1">&#39;instrument_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details</span><span class="o">.</span><span class="n">instrId</span>
        <span class="n">pix_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">(</span><span class="n">h5msr</span><span class="p">[</span><span class="s1">&#39;Instrument/resolution&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">])</span>
        <span class="n">pix_size_unit</span> <span class="o">=</span> <span class="n">h5msr</span><span class="p">[</span><span class="s1">&#39;Instrument/resolution&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
        <span class="n">data_obj</span><span class="p">[</span><span class="s1">&#39;instr_scale_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">h5msr</span><span class="p">[</span><span class="s1">&#39;Instrument/scale_factor&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;Instrument/scale_factor&#39;</span> <span class="ow">in</span> <span class="n">h5msr</span> <span class="k">else</span> <span class="mf">1.0</span>
        <span class="c1"># Scan data</span>
        <span class="n">h5scans</span> <span class="o">=</span> <span class="n">h5msr</span><span class="p">[</span><span class="s1">&#39;Data&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">h5scans</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;NX_class&#39;</span> <span class="ow">in</span> <span class="n">h5scans</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="n">h5scans</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NX_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NXdata&#39;</span><span class="p">:</span>  <span class="c1"># loop over scans</span>
                <span class="n">h5scan</span> <span class="o">=</span> <span class="n">h5scans</span><span class="p">[</span><span class="n">it</span><span class="p">]</span>
                <span class="n">scan</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="s1">&#39;mask&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">h5scan</span> <span class="k">else</span> <span class="n">h5scan</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">]</span>
                <span class="n">has_data</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">motors</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;RX&#39;</span><span class="p">,</span><span class="s1">&#39;RY&#39;</span><span class="p">,</span><span class="s1">&#39;RZ&#39;</span><span class="p">]:</span>
                    <span class="n">motor_i</span> <span class="o">=</span> <span class="s1">&#39;motor_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">motor_i</span> <span class="ow">in</span> <span class="n">h5scan</span><span class="p">:</span>
                        <span class="n">motor_arr</span> <span class="o">=</span> <span class="n">h5scan</span><span class="p">[</span><span class="n">motor_i</span><span class="p">][</span><span class="o">...</span><span class="p">]</span>
                        <span class="n">motor_unit</span> <span class="o">=</span> <span class="n">h5scan</span><span class="p">[</span><span class="n">motor_i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;units&#39;</span> <span class="ow">in</span> <span class="n">h5scan</span><span class="p">[</span><span class="n">motor_i</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                        <span class="c1"># scan[motor_i] = Quantity(motor_arr, unit=motor_unit)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">motor_arr</span><span class="p">)):</span>
                            <span class="n">m</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">motor_i</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="n">motor_arr</span><span class="p">,</span> <span class="s1">&#39;axis&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">motor_unit</span><span class="p">)}</span>
                            <span class="n">motors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">get_default_data_names</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">h5scan</span><span class="p">:</span>
                        <span class="n">item_units</span> <span class="o">=</span> <span class="n">h5scan</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;units&#39;</span> <span class="ow">in</span> <span class="n">h5scan</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">item_scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">h5scan</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;scale&#39;</span> <span class="ow">in</span> <span class="n">h5scan</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="k">else</span> <span class="mf">1.0</span>
                        <span class="n">item_data</span> <span class="o">=</span> <span class="n">MetrologyData</span><span class="p">(</span><span class="n">h5scan</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="o">...</span><span class="p">]</span><span class="o">*</span><span class="n">item_scale</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">item_units</span><span class="p">,</span>
                                                  <span class="n">pix_size</span><span class="o">=</span><span class="n">pix_size</span><span class="p">,</span> <span class="n">pix_unit</span><span class="o">=</span><span class="n">pix_size_unit</span><span class="p">,</span>
                                                  <span class="n">dim_detector</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Motor&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">],</span>
                                                  <span class="n">motors</span><span class="o">=</span><span class="n">motors</span><span class="p">)</span>
                        <span class="n">scan</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span>    <span class="o">=</span> <span class="n">apply_mask</span><span class="p">(</span><span class="n">item_data</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
                        <span class="n">has_data</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">has_data</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Scan </span><span class="si">{}</span><span class="s1"> has no primary data. e.g. slopes_x, height&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">it</span><span class="p">))</span>

                <span class="n">scans</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">scan</span>
    <span class="n">data_obj</span><span class="p">[</span><span class="s1">&#39;scan_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scans</span></div>

<div class="viewcode-block" id="get_params_data"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.get_params_data">[docs]</a><span class="k">def</span> <span class="nf">get_params_data</span><span class="p">(</span><span class="n">data_obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get number of subapertures.</span>

<span class="sd">    :param data_obj: Input data dictionary</span>
<span class="sd">    :type data_obj: dict</span>
<span class="sd">    :return: Number of subapertures</span>
<span class="sd">    :rtype: int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nb_subaps</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">pix_sz</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">mXArr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">mYArr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="k">if</span> <span class="s1">&#39;scan_data&#39;</span> <span class="ow">in</span> <span class="n">data_obj</span><span class="p">:</span>
        <span class="n">scan</span> <span class="o">=</span> <span class="n">data_obj</span><span class="p">[</span><span class="s1">&#39;scan_data&#39;</span><span class="p">][</span><span class="n">data_obj</span><span class="p">[</span><span class="s1">&#39;scan_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">nb_subaps</span><span class="p">,</span> <span class="n">pix_sz</span><span class="p">,</span> <span class="n">mXArr</span><span class="p">,</span> <span class="n">mYArr</span> <span class="o">=</span> <span class="n">get_params_scan</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">DEFAULT_DATA_NAMES</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">data_obj</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
        <span class="n">nb_subaps</span><span class="p">,</span> <span class="n">pix_sz</span><span class="p">,</span> <span class="n">mXArr</span><span class="p">,</span> <span class="n">mYArr</span> <span class="o">=</span> <span class="n">get_params_scan</span><span class="p">(</span><span class="n">data_obj</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nb_subaps</span><span class="p">,</span> <span class="n">pix_sz</span><span class="p">,</span> <span class="n">mXArr</span><span class="p">,</span> <span class="n">mYArr</span></div>

<div class="viewcode-block" id="get_stitch_step"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.get_stitch_step">[docs]</a><span class="k">def</span> <span class="nf">get_stitch_step</span><span class="p">(</span><span class="n">data_obj</span><span class="p">,</span> <span class="n">mXArr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mYArr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get stitching step from a single or sequence of scans.</span>

<span class="sd">    :param data_obj: Input data dictionary</span>
<span class="sd">    :type data_obj: dict</span>
<span class="sd">    :return: Stitch step X, Stitch step Y</span>
<span class="sd">    :rtype: float, float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">step_x</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">step_y</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mXArr</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mYArr</span><span class="p">)):</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mXArr</span><span class="p">,</span> <span class="n">mYArr</span> <span class="o">=</span> <span class="n">get_params_data</span><span class="p">(</span><span class="n">data_obj</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mXArr</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">step_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">mXArr</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step_x</span><span class="p">,</span> <span class="n">Quantity</span><span class="p">):</span>
                <span class="n">step_x</span> <span class="o">=</span> <span class="n">step_x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;mm&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mYArr</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">step_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">mYArr</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step_y</span><span class="p">,</span> <span class="n">Quantity</span><span class="p">):</span>
                <span class="n">step_y</span> <span class="o">=</span> <span class="n">step_y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;mm&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">step_x</span> <span class="o">=</span> <span class="n">step_y</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">step_x</span><span class="p">,</span> <span class="n">step_y</span></div>

<div class="viewcode-block" id="update_motors"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.update_motors">[docs]</a><span class="k">def</span> <span class="nf">update_motors</span><span class="p">(</span><span class="n">scan_item</span><span class="p">,</span> <span class="n">scan_out_item</span><span class="p">,</span> <span class="n">mask_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update motor positions from input scan item to output scan item.</span>

<span class="sd">    :param scan_item: Scan item (e.g height)</span>
<span class="sd">    :type scan_item: MetrologyData</span>
<span class="sd">    :param scan_out_item: Output scan item</span>
<span class="sd">    :type scan_out_item: MetrologyData</span>
<span class="sd">    :param mask_list: Mask on subapertures</span>
<span class="sd">    :type mask_list: list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">scan_item</span><span class="o">.</span><span class="n">_motors</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scan_item</span><span class="o">.</span><span class="n">dim_detector</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scan_item</span><span class="o">.</span><span class="n">_motors</span><span class="p">)):</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">scan_item</span><span class="o">.</span><span class="n">_motors</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span> <span class="ow">and</span> <span class="s1">&#39;values&#39;</span> <span class="ow">in</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">scan_item</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]):</span>
                        <span class="n">scan_out_item</span><span class="o">.</span><span class="n">_motors</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">][</span><span class="n">mask_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>

<div class="viewcode-block" id="load_axis_pix"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.load_axis_pix">[docs]</a><span class="k">def</span> <span class="nf">load_axis_pix</span><span class="p">(</span><span class="n">data_obj</span><span class="p">,</span> <span class="n">step_x</span><span class="p">,</span> <span class="n">step_y</span><span class="p">,</span> <span class="n">use_step_always</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load axis values in pixels from a scan or a sequence of scans.</span>

<span class="sd">    :param data_obj: Input data dictionary</span>
<span class="sd">    :type data_obj: dict</span>
<span class="sd">    :param step_x: Step size X</span>
<span class="sd">    :type step_x: float</span>
<span class="sd">    :param step_y: Step size Y</span>
<span class="sd">    :type step_y: float</span>
<span class="sd">    :param use_step_always: Use stitch step instead of motor values</span>
<span class="sd">    :type use_step_always: bool</span>
<span class="sd">    :return: Updated scans</span>
<span class="sd">    :rtype: dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;scan_data&#39;</span> <span class="ow">in</span> <span class="n">data_obj</span><span class="p">:</span>
        <span class="n">pix_sz</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;pix_size&#39;</span> <span class="ow">in</span> <span class="n">data_obj</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_obj</span><span class="p">[</span><span class="s1">&#39;pix_size&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> \
                    <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Quantity</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_obj</span><span class="p">[</span><span class="s1">&#39;pix_size&#39;</span><span class="p">]]):</span>
                <span class="n">pix_sz</span> <span class="o">=</span> <span class="n">data_obj</span><span class="p">[</span><span class="s1">&#39;pix_size&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data_obj</span><span class="p">[</span><span class="s1">&#39;scan_data&#39;</span><span class="p">]:</span>
            <span class="n">scan</span> <span class="o">=</span> <span class="n">data_obj</span><span class="p">[</span><span class="s1">&#39;scan_data&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">n_sub</span><span class="p">,</span> <span class="n">pix_sz</span><span class="p">,</span> <span class="n">mXArr</span><span class="p">,</span> <span class="n">mYArr</span> <span class="o">=</span> <span class="n">get_params_scan</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="n">pix_sz</span><span class="o">=</span><span class="n">pix_sz</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pix_sz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Pixel size not found&#39;</span><span class="p">)</span>
            <span class="n">mxp</span><span class="p">,</span> <span class="n">myp</span> <span class="o">=</span> <span class="n">get_axis_pixels</span><span class="p">(</span><span class="n">mXArr</span><span class="p">,</span> <span class="n">mYArr</span><span class="p">,</span> <span class="n">pix_sz</span><span class="p">,</span> <span class="n">step_x</span><span class="p">,</span> <span class="n">step_y</span><span class="p">,</span> <span class="n">n_sub</span><span class="o">=</span><span class="n">n_sub</span><span class="p">,</span> <span class="n">use_step_always</span><span class="o">=</span><span class="n">use_step_always</span><span class="p">)</span>
            <span class="n">scan</span><span class="p">[</span><span class="s1">&#39;motor_X_pix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxp</span>
            <span class="k">if</span> <span class="n">myp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">scan</span><span class="p">[</span><span class="s1">&#39;motor_Y_pix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">myp</span>
    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">DEFAULT_DATA_NAMES</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">data_obj</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
        <span class="n">n_sub</span><span class="p">,</span> <span class="n">pix_sz</span><span class="p">,</span> <span class="n">mXArr</span><span class="p">,</span> <span class="n">mYArr</span> <span class="o">=</span> <span class="n">get_params_scan</span><span class="p">(</span><span class="n">data_obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pix_sz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Pixel size not found&#39;</span><span class="p">)</span>
        <span class="n">mxp</span><span class="p">,</span> <span class="n">myp</span> <span class="o">=</span> <span class="n">get_axis_pixels</span><span class="p">(</span><span class="n">mXArr</span><span class="p">,</span> <span class="n">mYArr</span><span class="p">,</span> <span class="n">pix_sz</span><span class="p">,</span> <span class="n">step_x</span><span class="p">,</span> <span class="n">step_y</span><span class="p">,</span> <span class="n">n_sub</span><span class="o">=</span><span class="n">n_sub</span><span class="p">,</span> <span class="n">use_step_always</span><span class="o">=</span><span class="n">use_step_always</span><span class="p">)</span>
        <span class="n">data_obj</span><span class="p">[</span><span class="s1">&#39;motor_X_pix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxp</span>
        <span class="k">if</span> <span class="n">myp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_obj</span><span class="p">[</span><span class="s1">&#39;motor_Y_pix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">myp</span>
    <span class="k">return</span> <span class="n">data_obj</span></div>

<div class="viewcode-block" id="get_params_scan"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.get_params_scan">[docs]</a><span class="k">def</span> <span class="nf">get_params_scan</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="n">pix_sz</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get parameters from scan dictionary.</span>

<span class="sd">    :param scan: Scan dictionary</span>
<span class="sd">    :type scan: dict</span>
<span class="sd">    :param pix_sz: Pixel size</span>
<span class="sd">    :type pix_sz: list[Quantity]</span>
<span class="sd">    :return: Number of subapertures, pixel size, motor x positions, motor y positions</span>
<span class="sd">    :rtype: int, list[Quantity], Quantity/np.ndarray, Quantity/np.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">DEFAULT_DATA_NAMES</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">scan</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">nb_subapertures</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mXArr</span> <span class="o">=</span> <span class="n">scan</span><span class="p">[</span><span class="s1">&#39;motor_X&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;motor_X&#39;</span> <span class="ow">in</span> <span class="n">scan</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">mYArr</span> <span class="o">=</span> <span class="n">scan</span><span class="p">[</span><span class="s1">&#39;motor_Y&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;motor_Y&#39;</span> <span class="ow">in</span> <span class="n">scan</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">is</span> <span class="n">MetrologyData</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">motors</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">motors</span><span class="p">:</span>
            <span class="n">mXArr</span> <span class="o">=</span> <span class="n">Quantity</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;motor_X&#39;</span> <span class="k">else</span> <span class="n">mXArr</span>
            <span class="n">mYArr</span> <span class="o">=</span> <span class="n">Quantity</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;motor_Y&#39;</span> <span class="k">else</span> <span class="n">mYArr</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">is</span> <span class="n">MetrologyData</span><span class="p">:</span>
        <span class="n">pix_sz</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">pix_size_detector</span>
    <span class="k">elif</span> <span class="s1">&#39;pix_size&#39;</span> <span class="ow">in</span> <span class="n">scan</span><span class="p">:</span>
        <span class="n">pix_sz</span> <span class="o">=</span> <span class="n">scan</span><span class="p">[</span><span class="s1">&#39;pix_size&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">nb_subapertures</span><span class="p">,</span> <span class="n">pix_sz</span><span class="p">,</span> <span class="n">mXArr</span><span class="p">,</span> <span class="n">mYArr</span></div>

<div class="viewcode-block" id="get_axis_pixels"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.get_axis_pixels">[docs]</a><span class="k">def</span> <span class="nf">get_axis_pixels</span><span class="p">(</span><span class="n">mXArr</span><span class="p">,</span> <span class="n">mYArr</span><span class="p">,</span> <span class="n">pix_sz</span><span class="p">,</span> <span class="n">step_x</span><span class="p">,</span> <span class="n">step_y</span><span class="p">,</span> <span class="n">n_sub</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">use_step_always</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get X,Y axes position values in pixels.</span>

<span class="sd">    :param mXArr: X positions</span>
<span class="sd">    :type mXArr: Quantity / np.ndarray</span>
<span class="sd">    :param mYArr: Y positions</span>
<span class="sd">    :type mYArr: Quantity / np.ndarray</span>
<span class="sd">    :param pix_sz: Pixel size</span>
<span class="sd">    :type pix_sz: list[Quantity]</span>
<span class="sd">    :param step_x: Stitching step along X axis</span>
<span class="sd">    :type step_x: float</span>
<span class="sd">    :param step_y: Stitching step along Y axis</span>
<span class="sd">    :type step_y: float</span>
<span class="sd">    :param n_sub: Number of subapertures</span>
<span class="sd">    :type n_sub: int</span>
<span class="sd">    :param use_step_always: Always use stitch steps instead of mXArr, mYArr</span>
<span class="sd">    :type use_step_always: bool</span>
<span class="sd">    :return: X positions in pixels, Y positions in pixels</span>
<span class="sd">    :rtype: np.ndarray, np.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">has_x</span> <span class="o">=</span> <span class="n">mXArr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">mXArr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mXArr</span><span class="p">))</span>
    <span class="n">has_y</span> <span class="o">=</span> <span class="n">mYArr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">mYArr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mYArr</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">mXArr</span><span class="o">==</span><span class="mf">0.0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">mYArr</span><span class="o">==</span><span class="mf">0.0</span><span class="p">):</span>
            <span class="n">has_x</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">has_y</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">if</span> <span class="n">use_step_always</span><span class="p">:</span>
        <span class="n">has_x</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">has_y</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">mXArr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">mXArr</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">mYArr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">mYArr</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_x</span> <span class="ow">and</span> <span class="n">step_x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">has_x</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">mXArr</span> <span class="o">=</span> <span class="n">Quantity</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_sub</span><span class="p">)</span> <span class="o">*</span> <span class="n">step_x</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;mm&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_y</span> <span class="ow">and</span> <span class="n">step_y</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">has_y</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">mYArr</span> <span class="o">=</span> <span class="n">Quantity</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_sub</span><span class="p">)</span> <span class="o">*</span> <span class="n">step_y</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;mm&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_x</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_y</span> <span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Please enter stitch step x or y.&#39;</span><span class="p">)</span>

    <span class="n">mxp</span> <span class="o">=</span> <span class="n">arr_to_pix</span><span class="p">(</span><span class="n">mXArr</span><span class="p">,</span> <span class="n">pix_sz</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">n_sub</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">myp</span> <span class="o">=</span> <span class="n">arr_to_pix</span><span class="p">(</span><span class="n">mYArr</span><span class="p">,</span> <span class="n">pix_sz</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pix_sz</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">n_sub</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">mxp</span><span class="p">,</span> <span class="n">myp</span></div>

<div class="viewcode-block" id="arr_to_pix"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.arr_to_pix">[docs]</a><span class="k">def</span> <span class="nf">arr_to_pix</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">n_sub</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Array (e.g. motor X) converted to pixel format.</span>

<span class="sd">    :param a: Input array</span>
<span class="sd">    :type a: Quantity / np.ndarray</span>
<span class="sd">    :param p: Pixel size</span>
<span class="sd">    :type p: Quantity / float</span>
<span class="sd">    :param n_sub: Number of subapertures in sequence</span>
<span class="sd">    :type n_sub: int</span>
<span class="sd">    :return: Pixel format array, residual pixel offsets</span>
<span class="sd">    :rtype: np.ndarray[int], np.ndarray[float]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_sub</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="k">if</span> <span class="n">n_sub</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_sub</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="k">if</span> <span class="n">n_sub</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">ar</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Quantity</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">Quantity</span><span class="p">):</span>
        <span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="n">ar</span> <span class="o">/</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># ar = ar.value if type(a) is Quantity else ar</span>
        <span class="c1"># p = p.value if type(p) is Quantity else p</span>
        <span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="n">ar</span> <span class="o">/</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">ap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">div</span><span class="p">)</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">div</span> <span class="o">-</span> <span class="n">ap</span>
    <span class="k">return</span> <span class="n">ap</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">da</span>  <span class="c1"># pixel offsets from start</span></div>

<div class="viewcode-block" id="get_pix_size"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.get_pix_size">[docs]</a><span class="k">def</span> <span class="nf">get_pix_size</span><span class="p">(</span><span class="n">Z</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scan</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get pixel size of dataset</span>

<span class="sd">    :param Z: Input dataset</span>
<span class="sd">    :type Z: MetrologyData/np.ndarray</span>
<span class="sd">    :param scan: Scan dictionary with pixel size, if dataset is only numpy array and not MetrologyData</span>
<span class="sd">    :type scan: dict</span>
<span class="sd">    :return: Pixel size</span>
<span class="sd">    :rtype: list[Quantity]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pix_sz</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pix_sz</span> <span class="o">=</span> <span class="n">scan</span><span class="p">[</span><span class="s1">&#39;pix_size&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;pix_size&#39;</span> <span class="ow">in</span> <span class="n">scan</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">Z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">MetrologyData</span><span class="p">):</span>
            <span class="n">pix_sz</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">pix_size_detector</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pix_sz</span></div>

<div class="viewcode-block" id="get_dims"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.get_dims">[docs]</a><span class="k">def</span> <span class="nf">get_dims</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get detector dimensions of an array.</span>

<span class="sd">    :param Z: Input array</span>
<span class="sd">    :type Z: MetrologyData/np.ndarray</span>
<span class="sd">    :return: Detector dimensions</span>
<span class="sd">    :rtype: np.ndarray[bool]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="n">Z</span><span class="o">.</span><span class="n">ndim</span>
    <span class="n">dims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">Z</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">dims</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">MetrologyData</span><span class="p">):</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">dim_detector</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dims</span></div>

<div class="viewcode-block" id="remove_tuple"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.remove_tuple">[docs]</a><span class="k">def</span> <span class="nf">remove_tuple</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Subtract second tuple from first and return subtraction&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">x</span><span class="o">-</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">)])</span></div>

<div class="viewcode-block" id="add_tuple"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.add_tuple">[docs]</a><span class="k">def</span> <span class="nf">add_tuple</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add two tuples and return sum&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">x</span><span class="o">+</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">)])</span></div>

<div class="viewcode-block" id="apply_mask"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.apply_mask">[docs]</a><span class="k">def</span> <span class="nf">apply_mask</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply mask to data</span>

<span class="sd">    :param data: Input array</span>
<span class="sd">    :type data: MetrologyData/np.ndarray</span>
<span class="sd">    :param mask: Mask array</span>
<span class="sd">    :type mask: np.ndarray</span>
<span class="sd">    :return: Masked data, new start, new end</span>
<span class="sd">    :rtype: MetrologyData/np.ndarray, tuple, tuple</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ret_data</span> <span class="o">=</span> <span class="n">data</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="n">get_dims</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">dims</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">start_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">start_position_pix</span>
    <span class="n">center_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">center_pix</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">MetrologyData</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span><span class="o">*</span><span class="n">mask</span><span class="o">.</span><span class="n">ndim</span>
    <span class="n">st</span><span class="p">,</span> <span class="n">en</span> <span class="o">=</span> <span class="n">get_default_positions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
        <span class="n">st</span><span class="p">,</span> <span class="n">en</span> <span class="o">=</span> <span class="n">get_mask_positions</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">slc</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">slc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">en</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">slc</span><span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">en</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">slc</span><span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">en</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">data_mask</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">slc</span><span class="p">)]</span>
        <span class="n">ret_data</span> <span class="o">=</span> <span class="n">data_mask</span>

    <span class="n">st</span> <span class="o">=</span> <span class="n">remove_tuple</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">center_data</span><span class="p">)</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">add_tuple</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">start_data</span><span class="p">)</span>
    <span class="n">en</span> <span class="o">=</span> <span class="n">remove_tuple</span><span class="p">(</span><span class="n">en</span><span class="p">,</span> <span class="n">center_data</span><span class="p">)</span>
    <span class="n">en</span> <span class="o">=</span> <span class="n">add_tuple</span><span class="p">(</span><span class="n">en</span><span class="p">,</span> <span class="n">start_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret_data</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">en</span></div>

<div class="viewcode-block" id="get_default_positions"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.get_default_positions">[docs]</a><span class="k">def</span> <span class="nf">get_default_positions</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get default mask positions from a dataset.</span>

<span class="sd">    :param data: Dataset</span>
<span class="sd">    :type data: np.ndarray</span>
<span class="sd">    :param axes: Axes along which to get start and end positions</span>
<span class="sd">    :type axes: list[int]</span>
<span class="sd">    :return: (start y, start x), (end y, end x)</span>
<span class="sd">    :rtype: tuple(float, float), tuple(float, float)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,),</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),)</span>
    <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="o">&gt;=</span><span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span></div>

<div class="viewcode-block" id="get_mask_positions"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.get_mask_positions">[docs]</a><span class="k">def</span> <span class="nf">get_mask_positions</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get mask positions from given 1D/2D mask.</span>

<span class="sd">    :param mask: Mask array</span>
<span class="sd">    :type mask: np.ndarray</span>
<span class="sd">    :return: (start y, start x), (end y, end x)</span>
<span class="sd">    :rtype: tuple(float, float), tuple(float, float)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">)),),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">)),)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">max_mask</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">max_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">max_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># maximum applicable mask elements by collapsing until last two dimensions</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">max_mask</span><span class="p">))</span>
        <span class="n">mn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">mn</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">mn</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">mx</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">mx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_instrument_details"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.get_instrument_details">[docs]</a><span class="k">def</span> <span class="nf">get_instrument_details</span><span class="p">(</span><span class="n">h5Entry</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get instrument details from a hdf5 entry (with NXentry as nexus class).</span>

<span class="sd">    :param h5Entry: H5 entry</span>
<span class="sd">    :type h5Entry: H5Group</span>
<span class="sd">    :return: Instrument details object selected from sql database</span>
<span class="sd">    :rtype: SelectResultsClass</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">retVal</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">h5Entry</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;NX_class&#39;</span> <span class="ow">in</span> <span class="n">h5Entry</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="n">h5Entry</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NX_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NXinstrument&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;instr_id&#39;</span> <span class="ow">in</span> <span class="n">h5Entry</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                    <span class="n">instr_id</span> <span class="o">=</span> <span class="n">h5Entry</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;instr_id&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">Instruments</span><span class="o">.</span><span class="n">selectBy</span><span class="p">(</span><span class="n">instrId</span><span class="o">=</span><span class="n">instr_id</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">qinstr</span> <span class="o">=</span> <span class="n">Instruments</span><span class="o">.</span><span class="n">selectBy</span><span class="p">(</span><span class="n">instrId</span><span class="o">=</span><span class="n">instr_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">retVal</span> <span class="o">=</span> <span class="n">qinstr</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">alertMsg</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">,</span> <span class="s1">&#39;Error getting instrument details&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">retVal</span></div>

<div class="viewcode-block" id="get_entries"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.get_entries">[docs]</a><span class="k">def</span> <span class="nf">get_entries</span><span class="p">(</span><span class="n">h5Obj</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="s1">&#39;Select entry&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get entries in the h5 object with nexus NX_class &#39;NXentry&#39;.</span>

<span class="sd">    :param h5Obj: H5 object</span>
<span class="sd">    :type h5Obj: H5File</span>
<span class="sd">    :param first: First option in entries dropdown, e.g. &#39;Select entry&#39;</span>
<span class="sd">    :type first: str</span>
<span class="sd">    :return: list of entries</span>
<span class="sd">    :rtype: list[str]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">first</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">h5Obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">h5Obj</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">h5Obj</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;NX_class&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NX_class&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;NXentry&#39;</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="o">!=</span><span class="s1">&#39;/StitchResults&#39;</span><span class="p">:</span>
                <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">entries</span></div>

<div class="viewcode-block" id="get_stitch_setups"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.get_stitch_setups">[docs]</a><span class="k">def</span> <span class="nf">get_stitch_setups</span><span class="p">(</span><span class="n">h5Obj</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="s1">&#39;New setup&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get stitching setups from h5 object.</span>

<span class="sd">    :param h5Obj: H5 object</span>
<span class="sd">    :type h5Obj: H5Group / H5File</span>
<span class="sd">    :param entry: Entry name</span>
<span class="sd">    :type entry: str</span>
<span class="sd">    :param first: First option for setups dropdown, e.g. &#39;New setup&#39;</span>
<span class="sd">    :type first: str</span>
<span class="sd">    :return: list of setups</span>
<span class="sd">    :rtype: list[str]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">setups</span> <span class="o">=</span> <span class="p">[</span><span class="n">first</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">h5Obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;StitchResults&#39;</span> <span class="ow">in</span> <span class="n">h5Obj</span><span class="p">:</span>
        <span class="n">h5sr</span> <span class="o">=</span> <span class="n">h5Obj</span><span class="p">[</span><span class="s1">&#39;StitchResults&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">h5sr</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;NX_class&#39;</span> <span class="ow">in</span> <span class="n">h5sr</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="n">h5sr</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NX_class&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;NXprocess&#39;</span> <span class="ow">and</span> <span class="n">h5sr</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;measurement_entry&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">entry</span><span class="p">:</span>
                <span class="n">setups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h5sr</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">setups</span></div>

<div class="viewcode-block" id="load_class"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.load_class">[docs]</a><span class="k">def</span> <span class="nf">load_class</span><span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="n">locs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load class if not already loaded.</span>

<span class="sd">    :param class_name: Name of the class</span>
<span class="sd">    :type class_name: str</span>
<span class="sd">    :param locs: list of module locations</span>
<span class="sd">    :type locs: list[str]</span>
<span class="sd">    :return: Class object</span>
<span class="sd">    :rtype: Class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">locs</span><span class="p">:</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">loc</span><span class="p">),</span> <span class="s1">&#39;__file__&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">importer</span><span class="p">,</span> <span class="n">package_name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">pkgutil</span><span class="o">.</span><span class="n">iter_modules</span><span class="p">([</span><span class="n">dirname</span><span class="p">]):</span>
            <span class="n">full_module_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">package_name</span><span class="p">)</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">full_module_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">class_name</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="parseDefValue"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.parseDefValue">[docs]</a><span class="k">def</span> <span class="nf">parseDefValue</span><span class="p">(</span><span class="n">valStr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse default strings. e.g.&#39;N&#39;, &#39;NO&#39;, &#39;FALSE&#39; are parsed to boolean False</span>

<span class="sd">    :param valStr: Input string</span>
<span class="sd">    :type valStr: str</span>
<span class="sd">    :return: Parsed object</span>
<span class="sd">    :rtype:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">valStr</span><span class="p">)</span><span class="o">!=</span><span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">valStr</span>
    <span class="k">elif</span> <span class="n">valStr</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;NO&#39;</span><span class="p">,</span> <span class="s1">&#39;FALSE&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">valStr</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;YES&#39;</span><span class="p">,</span> <span class="s1">&#39;TRUE&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">valStr</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;NONE&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">valStr</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">ast</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">valStr</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">valStr</span>
    <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="closeH5"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.closeH5">[docs]</a><span class="k">def</span> <span class="nf">closeH5</span><span class="p">(</span><span class="n">h5f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Close hdf5 file object.</span>

<span class="sd">    :param h5f: File object</span>
<span class="sd">    :type h5f: h5py.File</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">h5f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">h5f</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">h5f</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="alertMsg"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.alertMsg">[docs]</a><span class="k">def</span> <span class="nf">alertMsg</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Show alert dialog.</span>

<span class="sd">    :param title: Dialog title</span>
<span class="sd">    :type title: str</span>
<span class="sd">    :param msg: Alert message</span>
<span class="sd">    :type msg: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">PyQt5.Qt</span> <span class="k">as</span> <span class="nn">qt</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">app</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">app</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QApplication</span><span class="p">([])</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;alertMsg &lt;- commons&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">qt</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="infoMsg"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.infoMsg">[docs]</a><span class="k">def</span> <span class="nf">infoMsg</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Show information message dialog.</span>

<span class="sd">    :param title: Dialog title</span>
<span class="sd">    :type title: str</span>
<span class="sd">    :param msg: Information message</span>
<span class="sd">    :type msg: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">PyQt5.Qt</span> <span class="k">as</span> <span class="nn">qt</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">app</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">app</span> <span class="o">=</span> <span class="n">qt</span><span class="o">.</span><span class="n">QApplication</span><span class="p">([])</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;infoMsg &lt;- commons&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">qt</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="questionMsg"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.questionMsg">[docs]</a><span class="k">def</span> <span class="nf">questionMsg</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Title&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Yes/No?&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Question dialog with Yes or No options.</span>

<span class="sd">    :param parent: Parent object</span>
<span class="sd">    :type parent: QWidget</span>
<span class="sd">    :param title: Dialog title</span>
<span class="sd">    :type title: str</span>
<span class="sd">    :param msg: Question or message</span>
<span class="sd">    :type msg: str</span>
<span class="sd">    :return: Clicked option</span>
<span class="sd">    :rtype: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">answer</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">question</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span>
                                  <span class="n">title</span><span class="p">,</span>
                                  <span class="n">msg</span><span class="p">,</span>
                                  <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span><span class="o">|</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">No</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">answer</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="questionMsgAdv"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.questionMsgAdv">[docs]</a><span class="k">def</span> <span class="nf">questionMsgAdv</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Title&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Yes/No/Cancel?&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Advanced question dialog with Yes, No and Cancel options.</span>

<span class="sd">    :param parent: Parent object</span>
<span class="sd">    :type parent: QWidget</span>
<span class="sd">    :param title: Dialog title</span>
<span class="sd">    :type title: str</span>
<span class="sd">    :param msg: Question or message</span>
<span class="sd">    :type msg: str</span>
<span class="sd">    :return: Clicked option 0 = Cancel, 1 = No, 2 = Yes</span>
<span class="sd">    :rtype: int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">answer</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">question</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span>
                                  <span class="n">title</span><span class="p">,</span>
                                  <span class="n">msg</span><span class="p">,</span>
                                  <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span><span class="o">|</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">No</span><span class="o">|</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Cancel</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">answer</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">answer</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">No</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="save_file_dialog"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.save_file_dialog">[docs]</a><span class="k">def</span> <span class="nf">save_file_dialog</span><span class="p">(</span><span class="n">start_dir</span><span class="p">,</span> <span class="n">start_filter</span><span class="p">,</span> <span class="n">file_formats</span><span class="p">,</span>
                         <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Save as...&quot;</span><span class="p">,</span> <span class="n">dialog</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save file dialog with file formats.</span>

<span class="sd">    Function also returns the format and filter to cover the case where the</span>
<span class="sd">    same extension appears in multiple filters.</span>

<span class="sd">    :param start_dir: initial directory, optionally including the filename</span>
<span class="sd">    :type start_dir: str</span>
<span class="sd">    :param start_filter: initial filter</span>
<span class="sd">    :type start_filter: str</span>
<span class="sd">    :param file_formats: file formats</span>
<span class="sd">    :type file_formats: list[FileFormat]</span>
<span class="sd">    :param title: Title of the dialog</span>
<span class="sd">    :type title: str</span>
<span class="sd">    :param dialog: A function that creates a QT dialog</span>
<span class="sd">    :type dialog: Callable</span>
<span class="sd">    :return: (filename_list, file_format, filter), or `(None, None, None)` on cancel</span>
<span class="sd">    :rtype: tuple(list, FileFormat, str)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_formats</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">file_formats</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">PRIORITY</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">DESCRIPTION</span><span class="p">))</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">format_filter</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_formats</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">start_filter</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
        <span class="n">start_filter</span> <span class="o">=</span> <span class="n">filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">dialog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dialog</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getSaveFileName</span>
    <span class="n">filename</span><span class="p">,</span> <span class="nb">filter</span> <span class="o">=</span> <span class="n">dialog</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">start_dir</span><span class="p">,</span> <span class="s1">&#39;;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filters</span><span class="p">),</span> <span class="n">start_filter</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">filter</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
        <span class="n">file_format</span> <span class="o">=</span> <span class="n">file_formats</span><span class="p">[</span><span class="n">filters</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">filter</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file_format</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">filter</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">filename</span><span class="p">,</span> <span class="n">file_format</span><span class="p">,</span> <span class="nb">filter</span></div>

<div class="viewcode-block" id="open_multifile_dialog"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.open_multifile_dialog">[docs]</a><span class="k">def</span> <span class="nf">open_multifile_dialog</span><span class="p">(</span><span class="n">start_dir</span><span class="p">,</span> <span class="n">start_filter</span><span class="p">,</span> <span class="n">file_formats</span><span class="p">,</span>
                         <span class="n">add_all</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Open...&quot;</span><span class="p">,</span> <span class="n">dialog</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Open file dialog with file formats.</span>

<span class="sd">    Function also returns the format and filter to cover the case where the</span>
<span class="sd">    same extension appears in multiple filters.</span>

<span class="sd">    :param start_dir: initial directory, optionally including the filename</span>
<span class="sd">    :type start_dir: str</span>
<span class="sd">    :param start_filter: initial filter</span>
<span class="sd">    :type start_filter: str</span>
<span class="sd">    :param file_formats: file formats</span>
<span class="sd">    :type file_formats: list[FileFormat]</span>
<span class="sd">    :param title: Title of the dialog</span>
<span class="sd">    :type title: str</span>
<span class="sd">    :param dialog: A function that creates a QT dialog</span>
<span class="sd">    :type dialog: Callable</span>
<span class="sd">    :return: (filename_list, file_format, filter), or `(None, None, None)` on cancel</span>
<span class="sd">    :rtype: tuple(list, FileFormat, str)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_formats</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">file_formats</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">PRIORITY</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">DESCRIPTION</span><span class="p">))</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">format_filter</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_formats</span><span class="p">]</span>

    <span class="c1"># add all readable files option</span>
    <span class="k">if</span> <span class="n">add_all</span><span class="p">:</span>
        <span class="n">all_extensions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_formats</span><span class="p">:</span>
            <span class="n">all_extensions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">EXTENSIONS</span><span class="p">)</span>
        <span class="n">file_formats</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">filters</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;All readable files (*</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s1">&#39; *&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_extensions</span><span class="p">))))</span>

    <span class="k">if</span> <span class="n">start_filter</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
        <span class="n">start_filter</span> <span class="o">=</span> <span class="n">filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">dialog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dialog</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getOpenFileNames</span>
    <span class="n">filename</span><span class="p">,</span> <span class="nb">filter</span> <span class="o">=</span> <span class="n">dialog</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">start_dir</span><span class="p">,</span> <span class="s1">&#39;;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filters</span><span class="p">),</span> <span class="n">start_filter</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">filter</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
        <span class="n">file_format</span> <span class="o">=</span> <span class="n">file_formats</span><span class="p">[</span><span class="n">filters</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">filter</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file_format</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">filter</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">filename</span><span class="p">,</span> <span class="n">file_format</span><span class="p">,</span> <span class="nb">filter</span></div>

<div class="viewcode-block" id="parseQInt"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.parseQInt">[docs]</a><span class="k">def</span> <span class="nf">parseQInt</span><span class="p">(</span><span class="n">quser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse string to integers, e.g. format &#39;1-3,5&#39; is parsed to [1,2,3,5]</span>

<span class="sd">    :param quser: Input string</span>
<span class="sd">    :type quser: str</span>
<span class="sd">    :return: Parsed integer array</span>
<span class="sd">    :rtype: list[int]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">retArr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">quser</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">retArr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">quser</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">A</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
                    <span class="n">an</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">an</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">an</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">retArr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">retArr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">retArr</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;parseQInt &lt;- util_functions&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>

<div class="viewcode-block" id="flip_data"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.flip_data">[docs]</a><span class="k">def</span> <span class="nf">flip_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">flip_motors</span> <span class="o">=</span> <span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flip data along given axis.</span>

<span class="sd">    :param data: Input dataset</span>
<span class="sd">    :type data: MetrologyData / np.ndarray</span>
<span class="sd">    :param axis: Axis</span>
<span class="sd">    :type axis: int</span>
<span class="sd">    :param flip_motors: Also flip selected motors, e.g. [&#39;X&#39;, &#39;RY&#39;]</span>
<span class="sd">    :type flip_motors: list[str]</span>
<span class="sd">    :return: Flipped data</span>
<span class="sd">    :rtype: MetrologyData / np.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">MetrologyData</span><span class="p">):</span>
        <span class="n">index_list_prev</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">index_list</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
        <span class="n">index_list</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">index_list</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">init_shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">init_shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">index_list</span><span class="p">[</span><span class="n">axis</span><span class="p">]):</span>
            <span class="n">index_list</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">init_shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">index_list</span><span class="p">[</span><span class="n">axis</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index_list</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">index_list_prev</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
        <span class="n">data</span><span class="o">.</span><span class="n">_set_index_list</span><span class="p">(</span><span class="n">index_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">axis_id</span> <span class="ow">in</span> <span class="n">flip_motors</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">motors</span><span class="p">:</span>
                <span class="n">motor_id</span> <span class="o">=</span> <span class="s1">&#39;motor_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">axis_id</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">motor_id</span> <span class="ow">and</span> <span class="n">motor_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">axis_values</span><span class="p">:</span>
                    <span class="n">m</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="get_suplementary_output"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.get_suplementary_output">[docs]</a><span class="k">def</span> <span class="nf">get_suplementary_output</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">keep_tag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">ret_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">[</span><span class="n">options</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">module</span><span class="o">==</span><span class="s1">&#39;custom&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">DEFAULT_DATA_NAMES</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">option</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">ret_data</span><span class="p">[</span><span class="n">key</span> <span class="k">if</span> <span class="n">keep_tag</span> <span class="k">else</span> <span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">module</span><span class="o">==</span><span class="s1">&#39;scan_data&#39;</span><span class="p">:</span>
        <span class="n">scans</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;scan_data&#39;</span><span class="p">]</span>
        <span class="n">ret_scans</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scans</span><span class="p">):</span>
            <span class="n">scan</span> <span class="o">=</span> <span class="n">scans</span><span class="p">[</span><span class="n">it</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">DEFAULT_DATA_NAMES</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">option</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">scan</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">it</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ret_scans</span><span class="p">:</span>
                            <span class="n">ret_scans</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">ret_scans</span><span class="p">[</span><span class="n">it</span><span class="p">][</span><span class="n">key</span> <span class="k">if</span> <span class="n">keep_tag</span> <span class="k">else</span> <span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">scan</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret_scans</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">ret_data</span><span class="p">[</span><span class="s1">&#39;scan_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret_scans</span>
    <span class="k">return</span> <span class="n">ret_data</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret_data</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="remove_suplementary_output"><a class="viewcode-back" href="../../../pylost_widgets.util.html#pylost_widgets.util.util_functions.remove_suplementary_output">[docs]</a><span class="k">def</span> <span class="nf">remove_suplementary_output</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">[</span><span class="n">options</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">module</span><span class="o">==</span><span class="s1">&#39;custom&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">DEFAULT_DATA_NAMES</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">option</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">module</span><span class="o">==</span><span class="s1">&#39;scan_data&#39;</span><span class="p">:</span>
        <span class="n">scans</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;scan_data&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scans</span><span class="p">):</span>
            <span class="n">scan</span> <span class="o">=</span> <span class="n">scans</span><span class="p">[</span><span class="n">it</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">DEFAULT_DATA_NAMES</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">option</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">scan</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">scan</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">pylost_widgets</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../pylost_widgets.html">pylost_widgets package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>